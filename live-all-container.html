<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2011 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<head>

<title>pgn4web chess live broadcast</title>

<link rel="shortcut icon" href="pawn.ico" />

<script src="pgn4web-server-config.js" type="text/javascript"></script>

<script src="pgn4web.js" type="text/javascript"></script>

<script type="text/javascript">

  var pgnData_default = "live/live.pgn";
  var maxBoards_default = 8;
  var firstGame_default = 1;
  var refreshMinutes_default = 1;

  var thisRegExp = /(&|\?)(help|h)([^&]*)(&|$)/i;
  if (window.location.search.match(thisRegExp) !== null) {
    alert("pgn4web live-all-container.html parameters" + "\n\n" + 
      " - pgnData = file.pgn" + "\n\n" +
      " - maxBoards = max number of boards to display in a page (default " + maxBoards_default +  ")" + "\n\n" +
      " - firstGame = number of first game to show, negative counts backwards (default " + firstGame_default + ")" + "\n\n" +
      " - refreshMinutes = live broadcast delay (default " + refreshMinutes_default + ")" + "\n\n" +
      " - refreshDemo = if set true sets live demo mode (default false)" + "\n\n" +
      " - help");
  }

  var pgnData = pgnData_default;
  // accepts pgnData as alias for pgnFile for consistency with board.html
  thisRegExp = /(&|\?)(pgnData|pd)=([^&]*)(&|$)/i;
  if (! thisRegExp) { thisRegExp = /(&|\?)(pgnFile|pf)=([^&]*)(&|$)/i; }
  if (window.location.search.match(thisRegExp) !== null) {
     pgnData = unescape(window.location.search.match(thisRegExp)[3]);
  } 
  if (pgnData) {
     SetPgnUrl(pgnData); // if set, this has precedence over the inline PGN in the HTML file
  }

  var maxBoards = parseInt(getMaxBoardFromLocalStorage(), 10);
  if (! maxBoards) { maxBoards = maxBoards_default; }
  thisRegExp = /(&|\?)(maxBoards|mb)=([\d]*)(&|$)/i;
  if (window.location.search.match(thisRegExp) !== null) {
    maxBoards = unescape(window.location.search.match(thisRegExp)[3]);
  }
  maxBoards = parseInt(maxBoards, 10);
  setMaxBoardToLocalStorage();

  var firstGame = firstGame_default;
  thisRegExp = /(&|\?)(firstGame|fg)=((\+|-|)[\d]*)(&|$)/i;
  if (window.location.search.match(thisRegExp) !== null) {
    firstGame = unescape(window.location.search.match(thisRegExp)[3]);
  }
  firstGame = parseInt(firstGame, 10);
  if (firstGame > 0) { firstGame--; }

  var alertFlag = demoFlag = false;
  thisRegExp = /(&|\?)(refreshDemo|rd)=([^&]*)(&|$)/i;
  if (window.location.search.match(thisRegExp) !== null) {
    refreshDemo = unescape(window.location.search.match(thisRegExp)[3]);
    if ((refreshDemo == "true") || (refreshDemo == "t")) { alertFlag = demoFlag = true; }
  }
 
  var refreshMinutes = refreshMinutes_default;
  var stepFlag = true;
  thisRegExp = /(&|\?)(refreshMinutes|rm)=([\d.]*)(&|$)/i;
  if (window.location.search.match(thisRegExp) !== null) {
    refreshMinutes = unescape(window.location.search.match(thisRegExp)[3]);
  }
  SetLiveBroadcast(refreshMinutes, alertFlag, demoFlag, stepFlag); // set live broadcast; parameters are delay (refresh delay in minutes, 0 means no broadcast, default 0) alertFlag (if true, displays debug error messages, default false) demoFlag (if true starts broadcast demo mode, default false) stepFlag (if true, autoplays updates in steps, default false)

  function getMaxBoardFromLocalStorage() {
    if (typeof(localStorage) == "undefined") { return 0; }
    try { mb = localStorage.getItem("pgn4web_live_all_maxBoards"); }
    catch (e) { return 0; }
    return mb;
  }

  function setMaxBoardToLocalStorage() {
    if (typeof(localStorage) == "undefined") { return false; }
    try { localStorage.setItem("pgn4web_live_all_maxBoards", maxBoards); }
    catch (e) { return false; }
    return true;
  }

</script>

<style type="text/css">

body {
  color: #DDDDDD;
  background: white;
  font-family: sans-serif;
  padding-top: 20px;
  padding-bottom: 10px;
  padding-left: 20px;
  padding-right: 20px;
}

.header,
.header:link,
.header:visited,
.header:hover,
.header:active {
  color: red;
  text-decoration: none;
}

.headerBoardsFiller {
  height: 20px;
}

.footer {
  font-size: small;
  font-weight: bold;
  margin-top: 20px;
  margin-bottom: 10px;
  line-height: 1.3em;
}

.footerTable {
  height: 3.9em;
}

a:link, a:visited, a:active {
  color: #DDDDDD;
  text-decoration: none;
}

a:hover {
  color: red;
  text-decoration: none;
}

.hiddenFrame,
.visibleFrame {
  width: 240px;
  height: 290px;
  margin-left: 20px;
  margin-right: 20px;
  margin-top: 20px;
  margin-bottom: 0;
}

.hiddenFrame {
  display: none;
  visibility: hidden;
}

.visibleFrame {
  display: inline;
  visibility: visible;
}

</style>

</head>

<body>

<table border="0" cellpadding="0" cellspacing="0" width="100%"><tbody><tr>
<td align="left" valign="middle">
<h1 class="header" name="top">pgn4web <a class="header" href="#boards">chess live broadcast</a></h1>
</td>
<td align="right" valign="middle">
<img src="pawns.png" border="0">
</td>
</tr></tbody></table>

<center>
<div class="headerBoardsFiller"><a name="boards">&nbsp</a></div>
<script type="text/javascript">

for (board = 0; board < maxBoards; board++) {
  document.write("<iframe name='board" + board + "' id='board" + board + "' class='hiddenFrame' width='240' height='290' frameborder='0' scrolling='no' marginheight='0' marginwidth='0' src='live-all-frame.html?ut=t&rm=" + refreshMinutes + (alertFlag ? "&rd=t" : "") + "'>your web browser and/or your host do not support iframes as required to display the chessboard</iframe>");
}

</script>
</center>

<table class="footer footerTable" border="0" cellpadding="0" cellspacing="0" width="100%"><tbody><tr>
<td align="left" valign="bottom">
<div><a id="GameLiveStatus" href="javascript:void();" onclick="displayDebugInfo();" title="live broadcast status: show more details"></a></div>
<div id="leftFooter_2"></div>
<div id="leftFooter_3"></div>
</td>
<td align="right" valign="bottom">
<div id="rightFooter_1"></div>
<div id="rightFooter_2"></div>
<div id="rightFooter_3"></div>
</td>
</tr></tbody></table>

<script type="text/javascript">

var filteredGames = new Array();
var numberOfGamesForDisplay = numberOfGames;

function filterEndedGames(gamesList) {
  filteredGames = new Array();
  for (g in gamesList) {
    if (LiveBroadcastDemo) { if (gameDemoMaxPly[gamesList[g]] <= gameDemoLength[gamesList[g]]) { continue; } }
    else { if ((typeof(gameResult[gamesList[g]]) != "undefined") && (gameResult[gamesList[g]] == "*")) { continue; } }
    filteredGames.push(gamesList[g]);
  }
}

function skipEndedGames() {
  n = new Array();
  for (g = 0; g < numberOfGames; g++) { n.push(g); }
  filterEndedGames(n);
  customFunctionOnPgnTextLoad();
}

function restoreEndedGames() {
  filteredGames = new Array();
  customFunctionOnPgnTextLoad();
}

function customFunctionOnPgnTextLoad() {

  filterEndedGames(filteredGames);
  unfilteredGames = new Array();
  for (g = 0; g < numberOfGames; g++) {
    found_g = false;
    for (f in filteredGames) { if (found_g = (filteredGames[f] == g)) { break; } }
    if (! found_g) { unfilteredGames.push(g); }
  }
  numberOfGamesForDisplay = unfilteredGames.length;
  if (numberOfGamesForDisplay < 1) { numberOfGamesForDisplay = 1; }
  numBoards = Math.min(numberOfGamesForDisplay, maxBoards);

  startGame = startFromFirstGame(firstGame, numberOfGamesForDisplay);
  for (board = 0; board < maxBoards; board++) {
    if (startGame >= 0) { gameForBoard = (startGame + board) % numberOfGamesForDisplay; }
    else { gameForBoard = (2 * numberOfGamesForDisplay + startGame - board) % numberOfGamesForDisplay; }
    if (thisFrame = document.getElementById("board" + board)) {
      if (board < numberOfGamesForDisplay) {
        thisFrame.className = "visibleFrame";
        window.frames["board" + board].document.getElementById("pgnText").value = pgnGame[unfilteredGames[gameForBoard]];
        window.frames["board" + board].refreshPgnSource();
      } else {
        thisFrame.className = "hiddenFrame";
      }
    }
  }

  if (theObject = document.getElementById("rightFooter_1")) {
    theObject.innerHTML = numberOfGamesForDisplay > maxBoards ? "<a class='footer' href='javascript:void(0);' onclick='previousPage();' title='more games available: show the previous set of games'>previous</a> / <a class='footer' href='javascript:void(0);' onclick='nextPage();' title='more games available: show the next set of games'>next</a> games" : "";
  }

  if (theObject = document.getElementById("rightFooter_2")) {
    theObject.innerHTML = "";
    if (maxBoards > 1 && numberOfGamesForDisplay > 1) { theObject.innerHTML += "<a class='footer' href='javascript:void(0);' onclick='newBoards(" + Math.min(maxBoards - 1, numberOfGamesForDisplay - 1) + ");' title='show fewer chessboards on the page'>less</a> "; }
    if (maxBoards > 1 && numberOfGamesForDisplay > maxBoards) { theObject.innerHTML += "/ "; }
    if (numberOfGamesForDisplay > maxBoards) { theObject.innerHTML += "<a class='footer' href='javascript:void(0);' onclick='newBoards(" + (maxBoards + 1) + ");' title='show more chessboards on the page'>more</a> "; }
    if ((maxBoards > 1 && numberOfGamesForDisplay > 1) || numberOfGamesForDisplay > maxBoards) { theObject.innerHTML += "boards"; }
  }

  if (theObject = document.getElementById("rightFooter_3")) {
    theObject.innerHTML = "";
    if (LiveBroadcastStarted && !LiveBroadcastEnded) { theObject.innerHTML += "<a class='footer' href='javascript:void(0);' onclick='skipEndedGames();' title='skip games ended so far'>skip</a> "; }
    if (filteredGames.length > 0 && (LiveBroadcastStarted && !LiveBroadcastEnded)) { theObject.innerHTML += "/ "; }
    if (filteredGames.length > 0) { theObject.innerHTML += "<a class='footer' href='javascript:void(0);' onclick='restoreEndedGames();' title='restore the ended games previously skipped'>restore</a> "; }
    if (filteredGames.length > 0 || (LiveBroadcastStarted && !LiveBroadcastEnded)) { theObject.innerHTML += "ended games "; }
  }

  if (theObject = document.getElementById("leftFooter_2")) {
    theObject.innerHTML = "";
    if (LiveBroadcastEnded) { theObject.innerHTML += "<a class='footer' href='javascript:void(0);' onclick='restartLiveBroadcast();' title='check for the start of a new live broadcast event'>check</a> / "; }
    else if (LiveBroadcastPaused) { theObject.innerHTML += "<a class='footer' href='javascript:void(0);' onclick='restartLiveBroadcast();' title='restart live broadcast automatic refresh of games'>restart</a> / "; }
    else if (LiveBroadcastStarted) { theObject.innerHTML += "<a class='footer' href='javascript:void(0);' onclick='pauseLiveBroadcast(); customFunctionOnPgnTextLoad();' title='pause live broadcast automatic refresh of games'>pause</a> / "; }
    else { theObject.innerHTML += "<a class='footer' href='javascript:void(0);' onclick='restartLiveBroadcast();' title='start live broadcast automatic refresh of games'>start</a> / "; }
    theObject.innerHTML += "<a class='footer' href='javascript:void(0);' onclick='refreshPgnSource();' title='force games refresh'>force</a> games refresh</a>"; 
  }

  document.title = LiveBroadcastStatusString.replace(" &nbsp;", ",");
}

function startFromFirstGame(firstGame, numberOfGamesForDisplay) {
  if (firstGame >= numberOfGamesForDisplay) { return numberOfGamesForDisplay - 1; }
  if (firstGame < -numberOfGamesForDisplay) { return 0; }
  if (firstGame < 0) { return numberOfGamesForDisplay + firstGame; }
  else { return firstGame; }
}

function nextPage() {
  firstGame = (startFromFirstGame(firstGame, numberOfGamesForDisplay) + maxBoards) % numberOfGamesForDisplay;
  firstGame -= (firstGame < 0 ? numberOfGamesForDisplay : 0); 
  customFunctionOnPgnTextLoad();
}

function previousPage() {
  firstGame = (startFromFirstGame(firstGame, numberOfGamesForDisplay) - maxBoards + numberOfGamesForDisplay) % numberOfGamesForDisplay; 
  firstGame -= (firstGame < 0 ? numberOfGamesForDisplay : 0);
  customFunctionOnPgnTextLoad();
}

function newBoards(newMaxBoards) {
  currentLocationSearch = "";
  if (pgnData !== pgnData_default) { currentLocationSearch += "&pd=" + pgnData; }
  if (refreshMinutes !== refreshMinutes_default) { currentLocationSearch += "&rm=" + refreshMinutes; }
  if (alertFlag) { currentLocationSearch += "&rd=t"; }
  if (newMaxBoards !== maxBoards_default) { currentLocationSearch += "&mb=" + newMaxBoards; }
  if (firstGame !== firstGame_default) { currentLocationSearch += "&fg=" + (firstGame < 0 ? firstGame : firstGame + 1); }
  document.location.search = currentLocationSearch.replace(/^&/, "?");
}

</script>

</body>

</html>
