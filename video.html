<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2011 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<head>

<link rel="shortcut icon" href="pawn.ico" />

<style type="text/css">

body {
  color: black;
  background: white;
  font-family: sans-serif;
}

.boardTable {
  border-style: solid;
  border-color: #663300;
  border-width: 3px;
  height: 270px;
  width: 270px;
  box-shadow: 0px 0px 20px #663300;
  -webkit-box-shadow: 0px 0px 20px #663300;
  -moz-box-shadow: 0px 0px 20px #663300;
}

.pieceImage {
  width: 26px;
  height: 26px;
}

.whiteSquare,
.blackSquare,
.highlightWhiteSquare,
.highlightBlackSquare {
  width: 33px;
  height: 33px;
  border-style: solid;
  border-width: 2px;
}

.whiteSquare,
.highlightWhiteSquare {
  border-color: #FFCC99;
  background: #FFCC99;
}

.blackSquare,
.highlightBlackSquare {
  border-color: #CC9966;
  background: #CC9966;
}

.highlightWhiteSquare,
.highlightBlackSquare {
  border-color: #663300;
  border-style: solid;
}

</style>

<script type="text/javascript" src="swfobject/swfobject.js"></script>

<script src="pgn4web.js" type="text/javascript"></script>

</head>

<body>

<!-- paste your PGN below and make sure you dont specify an external source with SetPgnUrl() -->
<form style="display: none;"><textarea style="display: none;" id="pgnText">

</textarea></form>

<center>
<table><tr valign="middle"><td>

<div style="font-weight:bold;">
<span id="GameEvent"></span>
&nbsp; &nbsp;
<span id="GameSite"></span>
&nbsp; &nbsp;
<span id="GameDate"></span>
</div>

</td><td width="20"></td><td>

<div id="debug"></div>

</td></tr><tr valign="middle"><td>

<div id="videodiv" style="text-align:center; font-style:italic;">
<video id="videoPlayer" controls="controls" autoplay="autoplay"><br><br>warning: HTML5 video support required</video>
</div>

</td><td width=20></td><td>

<div style="font-weight:bold; margin-bottom:1em;">
<div id="GameBlackClock" style="float:right;"></div>
<div id="GameBlack"></div>
</div>
<div id="GameBoard"></div>
<div style="font-weight:bold; margin-top:1em;">
<div id="GameWhiteClock" style="float:right;"></div>
<div id="GameWhite"></div>
</div>

</td></tr><tr valign="middle"><td colspan="3">

<div id="warning" style="color:lightgray; font-style:italic; text-align:left; margin-top: 0.5em; margin-bottom: 0.5em;"></div>

</td></tr></table>
</center>

<script type="text/javascript">

var pgnFile_default = "video.pgn";
// accepts pgnData as alias for pgnFile for consistency with board.html
if ((pgnFile = gup("pgnData")) === "") {
  if ((pgnFile = gup("pgnFile")) === "") {
    pgnFile = pgnFile_default;
  }
}

var videoUrl_default = "video.ogv";
if ((videoUrl = gup("videoUrl")) === "") {
  videoUrl = videoUrl_default;
}

var youtubeVideoid_default = "";
if ((youtubeVideoid = gup("youtubeVideoid")) === "") {
  youtubeVideoid = youtubeVideoid_default;
}

var videoWidth_default = youtubeVideoid ? "480" : "";
if ((videoWidth = gup("videoWidth")) === "") {
  videoWidth = videoWidth_default;
}
if (videoWidth) { document.getElementById("videodiv").style.width = videoWidth + "px"; }

var videoHeight_default = youtubeVideoid ? "360" : "";
if ((videoHeight = gup("videoHeight")) === "") {
  videoHeight = videoHeight_default;
}
if (videoHeight) { document.getElementById("videodiv").style.height = videoHeight + "px"; }

testVideotimes = ((gup("testVideotimes") == "true") || (gup("testVideotimes") == "t"));

if ((gup("debug") == "true") || (gup("debug") == "t")) {
  document.getElementById("debug").style.display = "inline";
} else {
  document.getElementById("debug").style.display = "none";
}

if ((gup("help") == "true") || (gup("help") == "t")) {
  alert("pgn4web youtube.html parameters" + "\n" +
        " - pgnData = " + pgnFile + "; PGN file to load (default " + pgnFile_default + ")" + "\n" +
        " - videoUrl = " + videoUrl + "; video URL to load (default " + videoUrl_default + ")" + "\n" +
        " - youtubeVideoid = " + (youtubeVideoid ? youtubeVideoid : "null") + "; youtube video id, overrides videoUrl (default " + (youtubeVideoid_default ? youtubeVideoid_default : "null") + ")" + "\n" +
        " - videoWidth = " + (videoWidth ? videoWidth : "null") + "; video width (default " + (videoWidth_default ? videoWidth_default : "null") + ")" + "\n" +
        " - videoHeigth = " + (videoHeight ? videoHeight : "null") + "; video height (default " + (videoHeight_default ? videoHeight_default : "null") + ")" + "\n" +
        " - testVideotimes = true|false; detects missing/wrong video times in the PGN file (default false)" + "\n" +
        " - debug = true|false; if true shows timing info for adjusting the PGN file (default false)" + "\n" +
        " - help = true|false; prints this help (default false)");
}

function gup( name ){

  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  // commented below to match first occurrence (to avoid users overruling setting)
  // regexS = regexS+"(?!.*"+regexS+")"; // matches the LAST occurrence
  var regex = new RegExp( regexS, "i" );
  var results = regex.exec( window.location.href );
  if( results !== null ) { return decodeURIComponent(results[1]); }

  // allows for short version of the URL parameters, for instance sC matches squareColor
  compact_name = name.charAt(0);
    for(i=1; i<name.length; i++){
      if (name.charAt(i).match(/[A-Z]/)) { compact_name = compact_name + name.charAt(i).toLowerCase(); }
    }
  name = compact_name;

  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  regexS = "[\\?&]"+name+"=([^&#]*)";
  // commented below to match first occurrence (to avoid users overruling setting)
  // regexS = regexS+"(?!.*"+regexS+")"; // matches the LAST occurrence
  regex = new RegExp( regexS, "i" );

  results = regex.exec( window.location.href );
  if( results !== null ) { return decodeURIComponent(results[1]); }

  return "";
}

if (youtubeVideoid) {
  document.getElementById("videodiv").innerHTML = "warning: flash video support required";
  document.title = document.getElementById("warning").innerHTML = "pgn4web integration with youtube";
  var expressInstall = null;
  var flashvars = { };
  var params = { allowScriptAccess: "always" };
  var atts = { id: "videoPlayer" };
  swfobject.embedSWF("http://www.youtube.com/e/" + youtubeVideoid + "?enablejsapi=1&autoplay=1&loop=0&rel=0&disablekb=1", "videodiv", videoWidth, videoHeight, "8", expressInstall, flashvars, params, atts);
} else {
  document.title = document.getElementById("warning").innerHTML = "pgn4web integration with HTML5 video";
  if (theObj = document.getElementById("videoPlayer")) {
    theObj.src = videoUrl;
    if (videoWidth) { theObj.width = videoWidth; }
    if (videoHeight) { theObj.height = videoHeight; } 
  }
}

SetPgnUrl(pgnFile); // if set, this has precedence over the inline PGN below
SetImagePath ("alpha/26"); // use "" path if images are in the same folder as this javascript file
SetImageType("png");
SetHighlightOption(true); // true or false
SetShortcutKeysEnabled(false);

clearShortcutSquares("A", "123456");
clearShortcutSquares("BCDEFGH", "1234567");

var videotimeForGame = new Array();
function getVideotimeForGame() {
  videotimeForGame = new Array();
  for(thisGame=0; thisGame<numberOfGames; thisGame++) {
    videotimeForGame[thisGame] = parseFloat(customPgnHeaderTag("VideoTime", null, thisGame));
    if (!videotimeForGame[thisGame]) { videotimeForGame[thisGame] = 0; }
  }
}

var videotimeAtPly = new Array();
function getVideotimeAtPly() {
  videotimeAtPly = new Array();
  for(thisPly=StartPly; thisPly<=StartPly+PlyNumber; thisPly++) {
    videotimeAtPly[thisPly] = parseFloat(customPgnCommentTag("vt", null, thisPly));
    if (!videotimeAtPly[thisPly]) { videotimeAtPly[thisPly] = 0; }
  }
}

function customFunctionOnPgnGameLoad() {
  getVideotimeAtPly();
}

function runTestVidoetimes() {
  for(thisGame=0; thisGame<numberOfGames; thisGame++) {
    if ((thisGame>0) && (videotimeForGame[thisGame] <= videotimeForGame[thisGame-1])) {
      alert("warning: " + pgnFile + " missing/wrong VideoTime header tag for game " + (thisGame+1));
      return false;
    }
    Init(thisGame);
    for(thisPly=StartPly; thisPly<=StartPly+PlyNumber; thisPly++) {
      if ((thisPly>StartPly) && (videotimeAtPly[thisPly] <= videotimeAtPly[thisPly-1])) {
        alert("warning: " + pgnFile + " missing/wrong %vt comment at ply " + thisPly + " of game " + (thisGame+1));
        return false;
      }
    }
  }
  alert("info: " + pgnFile + " video time values looks ok");
  return true;
}

var syncInterval = 456; // milliseconds
var syncTimer = null;
function customFunctionOnPgnTextLoad() {
  getVideotimeForGame();
  if (testVideotimes) { runTestVidoetimes(); }
  if (syncTimer) { clearTimeout(syncTimer); }
  syncTimer = setTimeout("syncBoard();", syncInterval);
}

// assumes arrayValues ordered
function findIndexInOrderedArray(target, arrayValues, arrayFirst, arrayLast, previous) {
  if (previous < arrayFirst) { previous = arrayFirst; }
  if (previous > arrayLast ) { previous = arrayLast ; }
  if ((previous > arrayFirst) && (target < arrayValues[previous])) {
    for(index=previous; (index>arrayFirst) && (target < arrayValues[index]); index--) {}
    found = index;
  } else if ((previous < arrayLast) && (target > arrayValues[previous+1])) {
    for(index=previous; (index<arrayLast) && (target > arrayValues[index+1]); index++) {}
    found = index;
  } else { found = previous; }
  return found;
}

function syncBoard() {
  if (syncTimer) { clearTimeout(syncTimer); }

  var videoPlayer = document.getElementById("videoPlayer");
  if (videoPlayer && videoPlayer.currentTime) { videoCurrentTime = videoPlayer.currentTime; }
  else if (videoPlayer && videoPlayer.getCurrentTime) { videoCurrentTime = videoPlayer.getCurrentTime(); }
  else { videoCurrentTime = 0; }
  document.getElementById("debug").innerHTML = videoCurrentTime;

  foundGame = findIndexInOrderedArray(videoCurrentTime, videotimeForGame, 0, numberOfGames-1, currentGame);
  if (foundGame !== currentGame) { Init(foundGame); }

  foundPly = findIndexInOrderedArray(videoCurrentTime, videotimeAtPly, StartPly, StartPly+PlyNumber, CurrentPly); 
  if (foundPly != CurrentPly) { GoToMove(foundPly); }
  syncTimer = setTimeout("syncBoard();", syncInterval);
}

</script>

</body>

</html>
