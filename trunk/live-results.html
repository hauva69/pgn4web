<!DOCTYPE>
<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2012 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<head>

<title>pgn4web live results</title>

<link rel="shortcut icon" href="pawn.ico" />

<style type="text/css">

body {
  font-family: sans-serif;
  padding: 2em;
  margin: 0;
}

.event, .round, .match, .score, .player, .move, .lastMove, .result {
  display: inline-block;
  white-space: nowrap;
  overflow: hidden;
  margin-right: 1em;
}

.event, .round {
  font-size: 133%;
  padding-top: 1em;
  padding-bottom: 1em;
}

.event {
  width: 12em;
}

.round {
  width: 6em;
}

.match, .score {
  font-size: 111%;
  font-weight: bold;
  padding-top: 1em;
  padding-bottom: 1em;
}

.match {
  width: 15em;
}

.score {
  width: 5em;
}

.player {
  width: 10em;
}

.secondTeam {
  background-color: #F0F0F0;
}

.move, .lastMove {
}

.lastMove {
  width: 7em;
}

.result {
  width: 5em;
}

.gameLiveStatusTicker {
  position: fixed;
  top: 0;
  right: 0;
  text-align: center;
  width: 1em;
  color: gray;
  text-decoration: none;
}

.gameBoard {
  position: fixed;
  top: 0;
  right: 0;
}

.boardTable {
  border-style: double;
  border-color: black;
  border-width: 3px;
  box-shadow: 0px 0px 15px #AAAAAA;
  width: 320px;
  height: 320px;
  margin: 2em;
}

.pieceImage {
  width: 32px;
  height: 32px;
}

.whiteSquare,
.blackSquare,
.highlightWhiteSquare,
.highlightBlackSquare {
  width: 40px;
  height: 40px;
}

.whiteSquare {
  background: #EFF4EC;
}

.blackSquare {
  background: #C6CEC3;
}

.highlightWhiteSquare,
.highlightBlackSquare {
  background: #DAF4D7;
}

</style>

<script src="pgn4web.js" type="text/javascript"></script>
<script src="crc32.js" type="text/javascript"></script>

<script type="text/javascript">

  pgnFile_default = detectBaseLocation() ?
    location.protocol + "//" + location.hostname + location.pathname.replace(/\/[^\/]*$/, "/live/live.pgn") :
    "live/live.pgn";
  // accepts pgnData as alias for pgnFile for consistency with board.html
  if ((pgnFile = gup("pgnData")) === "") {
    if ((pgnFile = gup("pgnFile")) === "") {
      pgnFile = pgnFile_default;
    }
  }

  if ((gup("demo") == "true") || (gup("demo") == "t") ||
      (gup("refreshDemo") == "true") || (gup("refreshDemo") == "t")) {
    demoFlag = true; alertFlag = true;
  } else { demoFlag = false; alertFlag = false; }

  if ((refreshMinutes = gup("refreshMinutes")) === "") {
    refreshMinutes = 1;
  } else {
    testMinutes = refreshMinutes + "";
    if ((testMinutes.match(/[^0-9\.]/)) || (refreshMinutes === 0)) {
      if (alertFlag) {
	      alert("ERROR: refreshMinutes parameter must be a positive number.\n" +
		    "Supplied " + testMinutes + "; defaulting to 1.");
      }
      refreshMinutes = 1;
    }
  }

  showBoard = false;
  if ((gup("showBoard") == "true") || (gup("showBoard") == "t")) { showBoard = true; }

  showEvent = true;
  if ((gup("showEvent") == "false") || (gup("showEvent") == "f")) { showEvent = false; }

  showMatch = true;
  if ((gup("showMatch") == "false") || (gup("showMatch") == "f")) { showMatch = false; }

  showLastMove = true;
  if ((gup("showLastMove") == "false") || (gup("showLastMove") == "f")) { showLastMove = false; }

  if ((gup("help") == "true") || (gup("help") == "t")) {
      document.write("<pre>" +
      "pgn4web live-results.html parameters" + "\n\n" +
      " - pgnData = " + pgnFile + "; PGN file to load (default " + pgnFile_default + ")" + "\n" +
      " - refreshMinutes = " + refreshMinutes + "; refresh interval in minutes, decimals allowed (default 1)" + "\n" +
      " - refreshDemo = " + demoFlag + "; sets live demo mode (default false)" + "\n" +
      " - showBoard = true|false; whether to show/hide the chessboard (default true)" + "\n" +
      " - showEvent = true|false; whether to show/hide event information (default true)" + "\n" +
      " - showMatch = true|false; whether to show/hide team match information (default true)" + "\n" +
      " - showLastMove = true|false; whether to show/hide game's last move (default true)" + "\n" +
      " - help = true; prints this help (default false)" + "\n\n" +
      "</pre>");
  }

  SetPgnUrl(pgnFile);
  SetImagePath ("alpha/32");
  SetImageType("png");
  SetHighlightOption(false);
  SetShortcutKeysEnabled(false);
  SetInitialHalfmove("end", true);
  SetLiveBroadcast(refreshMinutes, alertFlag, demoFlag, false);

  liveStatusTickerString = "o.oO";
  function customFunctionOnCheckLiveBroadcastStatus() {
    if (theObject = document.getElementById("GameLiveStatusTicker")) {
      theObject.innerHTML =  theObject.innerHTML = liveStatusTickerString.charAt(LiveBroadcastTicker % liveStatusTickerString.length);
      theObject.title = LiveBroadcastStatusString.replace("&nbsp;", " ");
    }
  }

  function customFunctionOnPgnGameLoad() {
    highlightGame(currentGame);
  }

  function customShortcutKey_Shift_1() {
    refreshPgnSource();
  }

  clearShortcutSquares("ABCDEFGH", "1234");
  clearShortcutSquares("G", "6");
  clearShortcutSquares("BCEFG", "7");

  var gameId;
  var gameWhiteTeam;
  var gameBlackTeam;
  var gameMatch;
  var gameBoard;
  var gameLastMove;
  function customFunctionOnPgnTextLoad() {
    gameId = new Array();
    gameWhiteTeam = new Array();
    gameBlackTeam = new Array();
    gameMatch = new Array();
    gameBoard = new Array();
    gameLastMove = new Array();
    for (cc = 0; cc < numberOfGames; cc++) {
      gg = (cc + oldSelectedGame + 1) % numberOfGames;
      gameId[gg] = gg;
      oldShowBoard = showBoard;
      showBoard = false;
      Init(gg);
      showBoard = oldShowBoard;
      gameWhiteTeam[gg] = customPgnHeaderTag("WhiteTeam");
      gameBlackTeam[gg] = customPgnHeaderTag("BlackTeam");
      gameMatch[gg] = crc32(gameWhiteTeam[gg]) + crc32(gameBlackTeam[gg]);
      gameBoard[gg] = customPgnHeaderTag("Board");
      showThisMove = StartPly + PlyNumber - 1;
      if ((showThisMove >= StartPly) && Moves[showThisMove]) {
        gameLastMove[gg] = (Math.floor(showThisMove/2) + 1) + (showThisMove % 2 === 0 ? '. ' : '... ') + Moves[showThisMove];
      } else { gameLastMove[gg] = ''; }
    }

    gameId.sort(sortGameId);

    printGames();
  }

  function myCompare(AA, ZZ) {
    if (!AA && !ZZ) { return 0; }
    if (AA && !ZZ) { return -1; }
    if (!AA && ZZ) { return 1; }
    if (AA > ZZ) { return 1; }
    if (AA < ZZ) { return -1; }
    return 0;
  }

  function sortGameId(aa, zz) {

    res = myCompare(gameEvent[aa], gameEvent[zz]);
    if (res !== 0) { return res; }

    res = myCompare(gameRound[aa], gameRound[zz]);
    if (res !== 0) { return res; }

    res = myCompare(gameMatch[aa], gameMatch[zz]);
    if (res !== 0) { return res; }

    res = myCompare(gameBoard[aa], gameBoard[zz]);
    if (res !== 0) { return res; }

    return 0;

  }

  function printGames() {
    lastEventRound = "";
    lastMatch = 0;
    if (theObject = document.getElementById("results")) {
      resultTable = "";
      resultTable += "<table cellspacing='0' cellpadding='0' border='0'>";
      for (gg in gameId) {
        currentEventRound = gameEvent[gameId[gg]] + " - " + gameRound[gameId[gg]];
        if (showEvent && (currentEventRound !== lastEventRound)) {
          resultTable += "<tr><td colspan='2'><span class='event'>" + gameEvent[gameId[gg]] + "</span></td><td colspan='2'><span class='round'>" + (gameRound[gameId[gg]] !== "" ? "round " + gameRound[gameId[gg]] : "") + "</span></td></tr>";
          lastEventRound = currentEventRound;
        }
        if (showMatch && (gameMatch[gg] !== lastMatch)) {
          resultTable += "<tr>" + matchRow(gameMatch[gg]) + "</tr>";
          lastMatch = gameMatch[gg];
        }
        resultTable += "<tr id='gameRow_" + gameId[gg] + "' onclick='selectGame(" + gameId[gg] + ");' style='font-weight: " + (showBoard && (gameId[gg] === oldSelectedGame) ? "bold" : "") + "'><td><span class='player'><span class='" + (secondTeam && gameWhiteTeam[gameId[gg]] === secondTeam ? "secondTeam" : "") + "'>" + gameWhite[gameId[gg]] + "</span></span></td><td><span class='player'><span class='" + (secondTeam && gameBlackTeam[gameId[gg]] === secondTeam ? "secondTeam" : "") + "'>" + gameBlack[gameId[gg]] + "</span></span></td><td>" + (showLastMove ? "<span class='lastMove'>" + gameLastMove[gameId[gg]] + "</span>" : "") + "</td><td><span class='result' style='width:auto; margin:0;'><span class='result'>" + gameResult[gameId[gg]] + "</span><span class='lastMove' style='font-weight:bold; width:auto; margin:0;'>&nbsp;</span></span></td></tr>";
      }
      resultTable += "</table>";
      theObject.innerHTML = resultTable;
    }
  }

  var firstTeam = "";
  var secondTeam = "";
  function matchRow(id) {
    firstTeam = "";
    secondTeam = "";
    if (id === 0) { return ""; }
    firstTeamScore = 0;
    secondTeamScore = 0;
    for (ii in gameId) {
      if (gameMatch[ii] == id) {
        if (!firstTeam || !secondTeam) {
          firstTeam = gameWhiteTeam[gameId[ii]];
          secondTeam = gameBlackTeam[gameId[ii]];
        }
        switch (gameResult[gameId[ii]]) {
          case "1-0":
            if (firstTeam == gameWhiteTeam[gameId[ii]]) { firstTeamScore += 1; }
            else if (secondTeam == gameWhiteTeam[gameId[ii]]) { secondTeamScore += 1; }
            break;
          case "0-1":
            if (firstTeam == gameBlackTeam[gameId[ii]]) { firstTeamScore += 1; }
            else if (secondTeam == gameBlackTeam[gameId[ii]]) { secondTeamScore += 1; }
            break;
          case "1/2-1/2":
            firstTeamScore += 0.5;
            secondTeamScore += 0.5;
            break;
          default:
            break;
        }
      }
    }
    return "<td colspan='3'><span class='match'>" + firstTeam + " - <span class='secondTeam'>" + secondTeam + "</span></span></td><td colspan='1'><span class='score'>" + firstTeamScore + " - " + secondTeamScore + "</span></td>";
  }

  oldSelectedGame = -1;
  function selectGame(gameNum) {
    if (!showBoard) { return; }
    Init(gameNum);
    highlightGame(gameNum);
  }

  function highlightGame(gameNum) {
    if (!showBoard) { return; }
    if (theObject = document.getElementById("gameRow_" + oldSelectedGame)) {
      if (oldSelectedGame !== gameNum) {
        theObject.style.fontWeight = "";
      }
    }
    if (theObject = document.getElementById("gameRow_" + gameNum)) {
       theObject.style.fontWeight = "bold";
    }
    oldSelectedGame = gameNum;
  }

function gup( name ){

  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  // commented below to match first occurrence (to avoid users overruling setting)
  // regexS = regexS+"(?!.*"+regexS+")"; // matches the LAST occurrence
  var regex = new RegExp( regexS, "i" );
  var results = regex.exec( window.location.href );
  if( results !== null ) { return decodeURIComponent(results[1]); }

  // allows for short version of the URL parameters, for instance sC matches squareColor
  compact_name = name.charAt(0);
    for(i=1; i<name.length; i++){
      if (name.charAt(i).match(/[A-Z]/)) { compact_name = compact_name + name.charAt(i).toLowerCase(); }
    }
  name = compact_name;

  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  regexS = "[\\?&]"+name+"=([^&#]*)";
  // commented below to match first occurrence (to avoid users overruling setting)
  // regexS = regexS+"(?!.*"+regexS+")"; // matches the LAST occurrence
  regex = new RegExp( regexS, "i" );

  results = regex.exec( window.location.href );
  if( results !== null ) { return decodeURIComponent(results[1]); }

  return "";
}

</script>

</head>

<body>

<a class="gameLiveStatusTicker" id="GameLiveStatusTicker" href="javascript:void(0);" onclick="refreshPgnSource(); this.blur();">&nbsp;</a>
<div class="gameBoard" id="GameBoard"></div>
<div id="results"></div>

<script type="text/javascript">

  if (theObject = document.getElementById("GameBoard")) {
    theObject.style.display = showBoard ? "" : "none";
  }
  if (theObject = document.getElementById("GameLiveStatusTicker")) {
    theObject.style.display = showBoard ? "none" : "";
  }

</script>

</body>

</html>
