<html id="html">

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2011 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<!-- 

HTML, CSS and Javascript code optimized for use as extension 
of Google Chrome. Don't use with any other browser.

-->

<head>

<title>chess games viewer</title>

<link href="chess-games-viewer.css" type="text/css" rel="stylesheet" />

<!-- not needed within a google chrome extension
<link rel="shortcut icon" href="pawn.ico" />
-->

<script src="js-unzip/js-unzip.js" type="text/javascript"></script>
<script src="js-unzip/js-inflate.js" type="text/javascript"></script>
<script src="pgn4web.js" type="text/javascript"></script>

</head>

<body>

<!-- paste your PGN below and make sure you dont specify an external source with SetPgnUrl() -->
<form style="display: none;"><textarea style="display: none;" id="pgnText">

</textarea></form>
<!-- paste your PGN above and make sure you dont specify an external source with SetPgnUrl() -->

<script type="text/javascript">

   // alert message redefined to take advantage of page layout
   alertPgnHeader = '[Site "chess games error"]\n[Event "click on the top left"]\n[Board "square for info"]\n';
   
   var backgroundPage;
   if ((typeof(chrome) != "undefined") && (chrome.extension)) {
      backgroundPage = chrome.extension.getBackgroundPage();
   }

   var highlightOption_default = true;
   var commentsOnSeparateLines_default = false;
   var commentsIntoMoveText_default = true;

   thisRegExp = /(&|\?)(help|h)([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      alert("pgn4web google chrome chess games viewer" + "\n" + 
            "chess-games-viewer.html parameters" + "\n\n" +
            " - pgnBackground = index" + "\n\n" +
            " - pgnData = URL.pgn" + "\n\n" +
            " - refreshMinutes = live broadcast delay (default 0 = live broadcast disabled)" + "\n\n" +
            " - refreshDemo = if set true sets live demo mode (default false)" + "\n\n" +
            " - search = search expression (default first game for normal view and first unfinished game for live broadcast view)" + "\n\n" +
            " - help");
   }

   function setPgnTextIndexFromTabId(tab) {
      if (backgroundPage) {
         if ((backgroundPage.pgnTextIndexFromTabId[tab.id] !== null) && (backgroundPage.pgnTextIndexFromTabId[tab.id] !== undefined) && (backgroundPage.pgnTextIndexFromTabId[tab.id] !== pgnBackground)) {
            backgroundPage.removePgnTextOnRemoved(tab.id);
         }
         backgroundPage.pgnTextIndexFromTabId[tab.id] = pgnBackground;
         theObject = document.getElementById("pgnText");
         if ((theObject) && (theObject.value) && (theObject.value != backgroundPage.pgnText[pgnBackground]))
         { backgroundPage.pgnText[pgnBackground] = theObject.value; }
      }
   }

   pgnBackground = null;
   if (backgroundPage) {
      thisRegExp = /(&|\?)(pgnBackground|pb)=([^&]*)(&|$)/i;
      if (window.location.search.match(thisRegExp) !== null) {
         if ((pgnBackground = unescape(window.location.search.match(thisRegExp)[3])) !== "") {
            theObject = document.getElementById("pgnText");
            theBackgroundPgnText = backgroundPage.pgnText[pgnBackground];
            if ((theObject) && (theBackgroundPgnText) && (theBackgroundPgnText !== undefined)) 
            { theObject.value = theBackgroundPgnText; }
            chrome.tabs.getCurrent(setPgnTextIndexFromTabId);
         }
      }
   }

   pgnData = "";
   thisRegExp = /(&|\?)(pgnData|pd)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      pgnData = unescape(window.location.search.match(thisRegExp)[3]);
   }


   // when opening the plain bookmark, once every N times, as a surprise, one of Tim Krabbe's most fantastic moves is shown
   if (!pgnData && !pgnBackground) {
      tkFEN = new Array(
         '[FEN "rnq2rk1/1pn3bp/p2p2p1/2pPp1PP/P1P1Pp2/2N2N2/1P1B1P2/R2QK2R b KQ - 1 16"] 16... Nc6',
         '[FEN "8/8/4kpp1/3p1b2/p6P/2B5/6P1/6K1 b - - 2 47"] 47... Bh3',
         '[FEN "5rk1/pp4pp/4p3/2R3Q1/3n4/2q4r/P1P2PPP/5RK1 b - - 1 23"] 23. Qg3',
         '[FEN "1r6/4k3/r2p2p1/2pR1p1p/2P1pP1P/pPK1P1P1/P7/1B6 b - - 0 48"] 48... Rxb3+',
         '[FEN "2k2b1r/pb1r1p2/5P2/1qnp4/Npp3Q1/4B1P1/1P3PBP/R4RK1 w - - 4 21"] 21. Qg7',
         '[FEN "r1bq1rk1/1p3ppp/p1pp2n1/3N3Q/B1PPR2b/8/PP3PPP/R1B3K1 w - - 0 14"] 14. Rxh4',
         '[FEN "r4k1r/1b2bPR1/p4n2/3p4/4P2P/1q2B2B/PpP5/1K4R1 w - - 0 26"] 26. Bh6',
         '[FEN "r1b2r1k/4qp1p/p2ppb1Q/4nP2/1p1NP3/2N5/PPP4P/2KR1BR1 w - - 4 18"] 18. Nc6',
         '[FEN "8/5B2/6Kp/6pP/5b2/p7/1k3P2/8 b - - 3 69"] 69... Be3',
         '[FEN "4r1k1/q6p/2p4P/2P2QP1/1p6/rb2P3/1B6/1K4RR w - - 1 38"] 38. Qxh7+',
         '[FEN "6k1/3Q4/5p2/5P2/8/1KP5/PP4qp/2B5 w - - 0 99"] 99. Bg5',
         '[FEN "k4b1r/p3pppp/B1p2n2/3rB1N1/7q/8/PPP2P2/R2Q1RK1 w - - 1 18"] 18. c4',
         '[FEN "1nbk1b1r/r3pQpp/pq2P3/1p1P2B1/2p5/2P5/5PPP/R3KB1R b KQ - 0 15"] 15... Rd7',
         '[FEN "5r2/7k/1pPP3P/8/4p3/3p4/P4R1P/7K b - - 0 48"] 48... e3',
         '[FEN "rnb1kr2/pp1p1pQp/6q1/4PpB1/1P6/8/1PP2PPP/2KR3R w q - 2 15"] 15. e6',
         '[FEN "7k/1p1P2pp/p7/3P4/1Q5P/5pPK/PP3r2/1q5B b - - 1 37"] 37... h5',
         '[FEN "r2q1rk1/pp2bpp1/4p2p/2pPB2P/2P3n1/3Q2N1/PP3PP1/2KR3R w - - 1 17"] 17. Bxg7',
         '[FEN "r2qk2r/1b3ppp/p2p1b2/2nNp3/1R2P3/2P5/1PN2PPP/3QKB1R w Kkq - 3 17"] 17. Rxb7',
         '[FEN "r3kbnr/p1pp1qpp/b1n1P3/6N1/1p6/8/Pp3PPP/RNBQR1K1 b kq - 0 12"] 12... O-O-O',
         '[FEN "r2qkb1r/pb1p1p1p/1pn2np1/2p1p3/2P1P3/2NP1NP1/PP3PBP/R1BQ1RK1 w kq - 0 9"] 9. Nxe5',
         '[FEN "r1bq1rk1/3nbppp/pp1p1n2/2pPp3/P1P1P3/2N3P1/1P2QPBP/R1B1K1NR w KQ - 0 10"] 10. Kd1',
         '[FEN "5r2/q3ppkp/3p2p1/3P4/Nr2PPn1/1R3BP1/P3N2P/R2Q2K1 w - - 1 24"] 24. Nb6',
         '[FEN "2kr3r/ppp1qpp1/2p5/2b2b2/2P1pPP1/1P2P1p1/PBQPB3/RN2K1R1 b Q - 1 14"] 14... Rh1',
         '[FEN "rn1q1r1k/2pp4/5pQ1/1b1PB3/8/4P3/PP1K1P1P/R7 b - - 2 19"] 19... Bd3',
         '[FEN "r3kb1r/1p2pppp/1pn5/3p1b2/3P4/4PN2/PP1B1PPP/R3KB1R b KQkq - 2 10"] 10... Bd7 ',
         '[FEN "r2q1rk1/3nbpp1/4p2p/p1p1P3/1p1P3P/3B1b1R/PPQB1PP1/R3K3 w Q - 0 18"] 18. Bxh6 ',
         '[FEN "rn1r2k1/pq1p1ppp/3Rp3/2p5/2P1b3/4QNP1/P3PPBP/3R2K1 w - - 2 17"] 17. Rxe6 ',
         '[FEN "8/8/p2k1p2/1p1p3p/1P1P3p/P3NPP1/5K2/1b6 w - - 0 47"] 47. Ng2 ',
         '[FEN "3rrk2/2p1n1bQ/1p3pp1/1q2B1N1/p1b1PP2/6PB/P1P5/3R1RK1 w - - 4 25"] 25. Rd5 ',
         '[FEN "r2q1k1r/p3bpp1/2p4p/2Bp4/4B1PP/4Q3/PPP5/2K1R3 w - - 1 22"] 22. Bh7 ',
         '[FEN "1nq3k1/r3b1p1/pp2prNp/2p5/4Q3/2P1P1B1/P4PPP/2R2RK1 w - - 6 21"] 21. Qa8 ',
         '[FEN "4r1k1/1p4p1/pPp2r1p/P1Pp1p2/3P1Pn1/2NR1P2/3Q2Bq/R4K2 b - - 0 31"] 31... Re4 ',
         '[FEN "r1bqkb1r/1p3ppp/p1nppn2/8/2P1P3/N1N5/PP3PPP/R1BQKB1R b KQkq - 1 8"] 8... d5'
      );
      onceEveryN = 10;
      if (theObject = document.getElementById("pgnText")) {
         if ((randomPick = Math.floor(onceEveryN * tkFEN.length * Math.random())) < tkFEN.length) {
            theObject.innerHTML = tkFEN[Math.floor(tkFEN.length * Math.random())];
            SetInitialHalfmove("end", true);
         }
      }
   }


   SetImagePath("alpha/128");
   SetImageType("png");
   SetHighlightOption(getHighlightOptionFromLocalStorage());
   SetGameSelectorOptions(null, true, 12, 12, 2, 15, 15, 3, 10);
   SetCommentsIntoMoveText(getCommentsIntoMoveTextFromLocalStorage());
   SetCommentsOnSeparateLines(getCommentsOnSeparateLinesFromLocalStorage());
   SetAutostartAutoplay(false);
   SetAutoplayNextGame(false);
   SetShortcutKeysEnabled(true);

   alertFlag = demoFlag = false;
   thisRegExp = /(&|\?)(refreshDemo|rd)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      refreshDemo = unescape(window.location.search.match(thisRegExp)[3]);
      if ((refreshDemo == "true") || (refreshDemo == "t")) { alertFlag = demoFlag = true; }
   }

   refreshMinutes = 0;
   stepFlag = true;
   thisRegExp = /(&|\?)(refreshMinutes|rm)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      refreshMinutes = unescape(window.location.search.match(thisRegExp)[3]);
   }

   searchGame = "";
   thisRegExp = /(&|\?)(search|s)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      searchGame = unescape(window.location.search.match(thisRegExp)[3]);
   }

   function setInitialGameFromSearchGame() {
      if (searchGame) { SetInitialGame(searchGame); }
      else if (LiveBroadcastDelay > 0) { SetInitialGame("\\[\\s*Result\\s*\"\\*\"\\s*\\]"); }
      else { SetInitialGame(1); }
   }

   function getHighlightOptionFromLocalStorage() {
      try { ho = (localStorage.getItem("pgn4web_chess_games_viewer_highlightOption") != "false"); }
      catch (e) { return highlightOption_default; }
      return ho;
   }
   function setHighlightOptionToLocalStorage() {
      try { localStorage.setItem("pgn4web_chess_games_viewer_highlightOption", highlightOption ? "true" : "false"); }
      catch (e) { return false; }
      return true;
   }

   function getCommentsIntoMoveTextFromLocalStorage() {
      try { cimt = !(localStorage.getItem("pgn4web_chess_games_viewer_commentsIntoMoveText") == "false"); }
      catch (e) { return commentsIntoMoveText_default; }
      return cimt;
   }
   function setCommentsIntoMoveTextToLocalStorage() {
      try { localStorage.setItem("pgn4web_chess_games_viewer_commentsIntoMoveText", commentsIntoMoveText ? "true" : "false"); }
      catch (e) { return false; }
      return true;
   }
   
   function getCommentsOnSeparateLinesFromLocalStorage() {
      try { cosl = (localStorage.getItem("pgn4web_chess_games_viewer_commentsOnSeparateLines") == "true"); }
      catch (e) { return commentsOnSeparateLines_default; }
      return cosl;
   }
   function setCommentsOnSeparateLinesToLocalStorage() {
      try { localStorage.setItem("pgn4web_chess_games_viewer_commentsOnSeparateLines", commentsOnSeparateLines ? "true" : "false"); }
      catch (e) { return false; }
      return true;
   }


   // A7
   if ((typeof(chrome) != "undefined") && (typeof(chrome.tabs) != "undefined") && (typeof(chrome.tabs.create) != "undefined")) { boardShortcut("A7", "about the chess games viewer extension for google chrome", function(){ chrome.tabs.create({url: "about.html"}); }); }
   // B7
   boardShortcut("B7", "toggle show comments in game text and save setting", function(){ SetCommentsIntoMoveText(!commentsIntoMoveText); oldPly = CurrentPly; Init(); GoToMove(oldPly); setCommentsIntoMoveTextToLocalStorage(); });
   // C7
   boardShortcut("C7", "toggle show comments on separate lines in game text and save setting", function(){ SetCommentsOnSeparateLines(!commentsOnSeparateLines); oldPly = CurrentPly; Init(); GoToMove(oldPly); setCommentsOnSeparateLinesToLocalStorage(); });
   // D7
   boardShortcut("D7", "toggle highlight last move and save setting", function(){ SetHighlight(!highlightOption); setHighlightOptionToLocalStorage(); });
   // F5
   boardShortcut("F5", "show the chess puzzler of the day", showPuzzler);
   // G5
   boardShortcut("G5", "adjust last move and current comment text area, if present", toggleFitResetLastMoveAndCommentArea);


   function fixHeaderTag(elementId) {
      var headerId = ["GameEvent", "GameSite", "GameDate", "GameRound", "GameWhite", "GameBlack", "GameResult", "GameSection", "GameStage", "GameBoardNum", "Timecontrol", "GameWhiteTitle", "GameBlackTitle", "GameWhiteElo", "GameBlackElo", "GameECO", "GameOpening", "GameVariation", "GameSubVariation", "GameTermination", "GameWhiteClock", "GameBlackClock", "GameTimeControl"];
      var headerLabel = ["event", "site", "date", "round", "white player", "black player", "result", "section", "stage", "board", "time control", "white title", "black title", "white elo", "black elo", "eco", "opening", "variation", "subvariation", "termination", "white clock", "black clock", "time control"];
      theObject = document.getElementById(elementId);
      if (theObject) { 
        theObject.className = (theObject.innerHTML === "") ? "innerHeaderItemNoMargin" : "innerHeaderItem"; 
        theObject.title = (headerId.indexOf(elementId) < 0 ? elementId : headerLabel[headerId.indexOf(elementId)] ) + ": " + theObject.innerHTML;
      }
   }

   function customPgnHeaderTagWithFix(tag, elementId) {
      customPgnHeaderTag(tag, elementId);
      fixHeaderTag(elementId);
   }

   function customFunctionOnMove() {
      wObject = document.getElementById('GameWhiteClock');
      bObject = document.getElementById('GameBlackClock');
      if (wObject && bObject) {
         if ((!wObject.innerHTML.match(/\S/)) && (bObject.innerHTML.match(/\S/))) { wObject.innerHTML = '-'; }
         if ((!bObject.innerHTML.match(/\S/)) && (wObject.innerHTML.match(/\S/))) { bObject.innerHTML = '-'; }
      }
      fixHeaderTag('GameWhiteClock');
      fixHeaderTag('GameBlackClock');
      if (theObject = document.getElementById('GameLastMove')) {
         if (CurrentPly == StartPly) {
            theObject.innerHTML = ((CurrentPly%2) ? "black" : "white") + " to move";
         }
      }
   }

   function customFunctionOnPgnGameLoad() {
      fixHeaderTag('GameDate');
      fixHeaderTag('GameSite');
      fixHeaderTag('GameEvent');
      customPgnHeaderTagWithFix('Section', 'GameSection');
      customPgnHeaderTagWithFix('Stage', 'GameStage');
      fixHeaderTag('GameRound');
      if (theObject = document.getElementById("GameRound")) {
         if (theObject.innerHTML) {
            theObject.innerHTML = "round " + theObject.innerHTML;
         }
      }
      customPgnHeaderTagWithFix('Board', 'GameBoardNum');
      if (theObject = document.getElementById("GameBoardNum")) {
         if (theObject.innerHTML) {
            theObject.innerHTML = "board " + theObject.innerHTML;
         }
      }
      customPgnHeaderTagWithFix('TimeControl', 'GameTimeControl');
      fixHeaderTag('GameWhite');
      fixHeaderTag('GameBlack');
      customPgnHeaderTagWithFix('WhiteTitle', 'GameWhiteTitle');
      customPgnHeaderTagWithFix('BlackTitle', 'GameBlackTitle');
      customPgnHeaderTagWithFix('WhiteElo', 'GameWhiteElo');
      customPgnHeaderTagWithFix('BlackElo', 'GameBlackElo');
      customPgnHeaderTagWithFix('ECO', 'GameECO');
      customPgnHeaderTagWithFix('Opening', 'GameOpening');
      customPgnHeaderTagWithFix('Variation', 'GameVariation');
      customPgnHeaderTagWithFix('SubVariation', 'GameSubVariation');
      fixHeaderTag('GameResult');
      customPgnHeaderTagWithFix('Termination', 'GameTermination');
      // if (PlyNumber > 0) { customPgnHeaderTag('Result', 'ResultAtGametextEnd'); }
      // else { if (theObject = document.getElementById('ResultAtGametextEnd')) { theObject.innerHTML = ""; } }
      if (theObject = document.getElementById('lastMoveAndComment')) {
         var lastDisplayStyle = "none";
         if ((PlyNumber === 0) && (gameFEN[currentGame])) {
            lastDisplayStyle = "block";
         } else if ((PlyNumber > 0) || (gameFEN[currentGame])) {
            for(ii=StartPly; ii<=StartPly+PlyNumber; ii++) {
               if (strippedMoveComment(ii)) {
                  lastDisplayStyle = "block";
                  break;
               }
            }
         }
         theObject.style.display = lastDisplayStyle;
      }
      if (previousCurrentGame !== currentGame) { 
         previousPlyNumber = PlyNumber;
         previousCurrentGame = currentGame
      }
   }

   var liveBroadcastUpdateTicker = -1;
   var previousPlyNumber = -1;
   var previousCurrentGame = -1;
   function customFunctionOnPgnTextLoad() {
      noGamesLoaded = (numberOfGames == 1) && (PlyNumber === 0) && (StartPly === 0) && (!gameWhite[0]) && (!gameBlack[0]) && (!gameResult[0]) && (!gameFEN[0]); 
      if (LiveBroadcastDelay > 0) {
         if (previousPlyNumber !== PlyNumber) {
            previousPlyNumber = PlyNumber;
            liveBroadcastUpdateTicker++;
         } 
         document.title = LiveBroadcastStatusString.replace(" &nbsp;", liveBroadcastUpdateTicker % 2 ? ";" : ",");
      } else {
         if (noGamesLoaded) { document.title = alertNum ? "PGN data error" : "chess games viewer"; }
         else { document.title = numberOfGames + " game" + (numberOfGames == 1 ? "" : "s"); }
      }

      // H5
      if ((typeof(chrome) != "undefined") && (chrome.extension) && (pgnUrl) && (LiveBroadcastDelay > 0)) {
         boardShortcut("H5", "zoom out to the multiple small boards view", switchBoardView);
      } else {
         clearShortcutSquares("H", "5");
      }

      if (pgnData.indexOf(puzzlerUrl) === 0) {
         if (theObject = document.getElementById("GameText")) { theObject.style.visibility = "hidden"; }
         if (theObject = document.getElementById("GameLastComment")) { theObject.style.visibility = "hidden"; }
         alert((pgnData == puzzlerUrl ? "chess puzzler of the day: " : "") + (CurrentPly%2 === 0 ? "White" : "Black") + " to move\n\nclick OK to view the solution");
         if (theObject = document.getElementById("GameText")) { theObject.style.visibility = ""; }
         if (theObject = document.getElementById("GameLastComment")) { theObject.style.visibility = ""; }
         MoveForward(1);
      }
   }

   function underlineByTicker(text, ticker) {
      position = ticker % text.length;
      return (text.substring(0, position) + "<u>" +text.substring(position, position + 1) + "</u>" + text.substring(position + 1));
   }

   function customFunctionOnCheckLiveBroadcastStatus() {
      if (theObject = document.getElementById("GameLiveStatus")) {
         if (LiveBroadcastTicker > 1) {
            theObject.innerHTML =  theObject.innerHTML.replace(/live/, underlineByTicker("live", LiveBroadcastTicker-2));
         }
      }
   }

   function lookupFidePlayer(name) {
      if (name) {
         window.open("http://ratings.fide.com/seek.phtml?idcode=&name=" + escape(name) + "&offset=0");
      }
   }

   function switchBoardView() {
      if ((typeof(chrome) != "undefined") && (chrome.extension) && (pgnUrl) && (LiveBroadcastDelay > 0)) {
         url = "live-mosaic-viewer.html?pgnData=" + escape(pgnUrl) + "&refreshMinutes=" + escape(refreshMinutes) + "&hp=t";
         if (demoFlag) { url += "&refreshDemo=true"; }
         url += "&firstGame=" + (currentGame + 1);
         location.href = url;
      }
   }


   function goToHash(hash) {
      if (hash) { location.hash = ""; }
      else { location.hash = "board"; }
      location.hash = hash;
   }

   function customShortcutKey_Shift_1() { goToHash(""); }
   function customShortcutKey_Shift_2() { goToHash("board"); }
   function customShortcutKey_Shift_3() { goToHash("bottom"); }

   function customShortcutKey_Shift_4() { chrome.tabs.create({url: "http://www.google.com/search?q=chess+games+PGN"}); }
   function customShortcutKey_Shift_5() { chrome.tabs.create({url: "http://www.chess.co.uk/twic/twic.html"}); }

   function customShortcutKey_Shift_7() { resetLastMoveAndCommentArea(); }
   function customShortcutKey_Shift_8() { fitLastMoveAndCommentArea(); }
   function customShortcutKey_Shift_9() { maximizeLastMoveAndCommentArea(); }


   function emPixels(em) { return em * document.getElementById("boardTable").offsetHeight / 24.5; } 

   function toggleFitResetLastMoveAndCommentArea() {
      if (theObject = document.getElementById("lastMoveAndComment")) {
         if ((theObject.scrollHeight === theObject.clientHeight) || (theObject.offsetHeight == emPixels(21))) { resetLastMoveAndCommentArea(); }
         else { fitLastMoveAndCommentArea(); }
      }
   }

   function resetLastMoveAndCommentArea() {
      if (theObject = document.getElementById("lastMoveAndComment")) {
         theObject.style.height = "";
      }
   }

   function fitLastMoveAndCommentArea() {
      if (theObject = document.getElementById("lastMoveAndComment")) {
         theObject.style.height = "";
         theObject.style.height = theObject.scrollHeight;
      }
   }

   function maximizeLastMoveAndCommentArea() {
      if (theObject = document.getElementById("lastMoveAndComment")) {
         theObject.style.height = "21em";
      }
   }

   puzzlerUrl = "http://pgn4web.casaschi.net/puzzler.php?pgnMini=true";
   function showPuzzler() { useNewPgnUrl(puzzlerUrl, 0); }


   window.onload = function() {
      if (pgnData) { useNewPgnUrl(pgnData, refreshMinutes); }
      else { 
         setInitialGameFromSearchGame();
         start_pgn4web();
      }
   };

</script>

<table class="topMenu" width="100%" cellpadding="0" cellspacing="0" border="0"><tr valign="top"><td width="99%">
<div id="GameSelector" class="gameSelector"></div>
</td><td>
<select class="hiddenSelect" />
</td><td>
<input type="file" id="localPgnFiles" name="localPgnFiles[]" multiple="multiple" class="localPgnFiles" />
</td><td>
<a id="inputPgnText" name="inputPgnText" class="topButton" href="javascript:void(0);" onclick="fetchInputPgnText();" title="enter PGN chess games TEXT for viewing">&nbsp;text&nbsp;</a>
</td><td>
<a id="openLocalPgnFiles" name="openLocalPgnFiles" class="topButton" href="javascript:void(0);" onclick="openPgnFiles();" title="open local PGN chess games files or drag and drop local PGN chess games files on this page for viewing; ZIP archives containing PGN chess games files are also accepted">&nbsp;files&nbsp;</a>
</td><td>
<a id="remotePgnUrl" name="remotePgnUrl" class="topButton" href="javascript:void(0);" onclick="fetchNewPgnUrl(false);" title="enter PGN chess games URL for viewing; ZIP archives containing PGN chess games files are also accepted">&nbsp;url&nbsp;</a>
</td><td>
<a id="remoteLivePgnUrl" name="remoteLivePgnUrl" class="topButton" href="javascript:void(0);" onclick="fetchNewPgnUrl(true);" title="enter PGN chess games URL for viewing with live refresh">&nbsp;live&nbsp;</a>
</td></tr></table>

<a name="board" href="javascript:void(0);" onclick="goToHash('board')" class="positionLink">&nbsp;</a>

<div class="mainContainer">

<div class="columnsContainer">

<div class="boardColumn">
<center>
<div id="GameBoard" class="gameBoard"></div>
<div id="GameButtons" class="gameButtons"></div>
</center>
</div>

<div class="headerColumn">
<div class="headerItem"><span class="innerHeaderItem" id="GameDate"></span><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameSite"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameEvent"></span><span class="innerHeaderItem" id="GameSection"></span><span class="innerHeaderItem" id="GameStage"></span><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameRound"></span><span class="innerHeaderItem" id="GameBoardNum"></span><span class="innerHeaderItem" id="GameTimeControl"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameECO"></span><span class="innerHeaderItem" id="GameOpening"></span><span class="innerHeaderItem" id="GameVariation"></span><span class="innerHeaderItem" id="GameSubVariation"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameWhiteClock"></span><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="javascript:void(0);" onclick="lookupFidePlayer(this.innerHTML);" class="innerHeaderItem" id="GameWhite"></a></b><span class="innerHeaderItem" id="GameWhiteTitle"></span><span class="innerHeaderItem" id="GameWhiteElo"></span><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="javascript:void(0);" onclick="lookupFidePlayer(this.innerHTML);" class="innerHeaderItem" id="GameBlack"></a></b><span class="innerHeaderItem" id="GameBlackTitle"></span><span class="innerHeaderItem" id="GameBlackElo"></span><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameBlackClock"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><b><span class="innerHeaderItem" id="GameResult"></span></b><span class="innerHeaderItem" id="GameTermination"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameLiveStatus" title="live broadcast status"></span><b>&nbsp;</b></div>

</div>

</div>

<div class="lastMoveAndComment" id="lastMoveAndComment"><a href="javascript:MoveToNextComment();" class="lastMove" title="last move" id="GameLastMove"></a><a href="javascript:MoveToPrevComment();" class="lastComment" title="current position comment" id="GameLastComment"></a></div>

<div id="moveText" class="moveText"><span id="GameText"></span> <span class="move" id="ResultAtGametextEnd"></span></div>

<a name="bottom" href="javascript:void(0);" onclick="goToHash('')" class="positionLink">&nbsp;</a>

</div>

<script type="text/javascript">

   function openPgnFiles() {
      if (theObject = document.getElementById("localPgnFiles")) { theObject.click(); }
   }
   
   function fetchNewPgnUrl(live) {
      if (newPgnUrl = prompt("Enter PGN chess games URL for viewing" + (live ? " with live refresh:" : ":"), pgnData)) {
         if (live) { newRefreshMinutes = refreshMinutes ? refreshMinutes : 1 + 0.01 * Math.floor(Math.random()*10); }
         else { newRefreshMinutes = 0; }
         useNewPgnUrl(newPgnUrl, newRefreshMinutes);
      }
   }

   function useNewPgnUrl(newPgnUrl, newRefreshMinutes) {
      refreshMinutes = newRefreshMinutes;
      SetPgnUrl(pgnData = newPgnUrl);
      SetLiveBroadcast(refreshMinutes, alertFlag, demoFlag, stepFlag);
      setInitialGameFromSearchGame();
      if (refreshMinutes) {
         SetAutoplayDelay(1000);
         SetInitialHalfmove("end", true);
      } else {
         SetAutoplayDelay(2000);
         SetInitialHalfmove(0, true);
      }
      firstStart = true;
      if (theObject = document.getElementById("pgnText")) { theObject.value = ""; }
      if (theObject = document.getElementById("GameLiveStatus")) { theObject.innerHTML = ""; }
      if (theObject = document.getElementById("localPgnFiles")) { theObject.value = ""; }
      LiveBroadcastStarted = false;
      LiveBroadcastEnded = false;
      LiveBroadcastPaused = false;
      LiveBroadcastTicker = 0;
      LiveBroadcastStatusString = "";
      LiveBroadcastLastModified_Reset();
      LiveBroadcastLastReceivedLocal_Reset();
      start_pgn4web();
   }

   var newPgnText;
   var pgnFilesLeft;
   var invalidFiles;
   var validFiles;
   var errorFiles;
   function handleFileSelect(evt) {
      evt.stopPropagation();
      evt.preventDefault();

      var files = new Array();
      if (evt.target.files) { files = evt.target.files; }
      else if (evt.dataTransfer.files) { files = evt.dataTransfer.files; }

      try {
         newPgnText = "";
         pgnFilesLeft = files.length;
         invalidFiles = new Array();
         validFiles = new Array();
         errorFiles = new Array();
         for (f=0; f<files.length; f++) {
            if (files[f].name.match(/\.(pgn|zip)$/i)) {
               var reader = new FileReader();
               reader.onload = (function(theFileName) {
                  return function(e) {
                     if (e.target.result) {
                        if (theFileName.match(/\.(pgn)$/i)) {
                           newPgnText += e.target.result + "\n\n\n";
                           validFiles.push(theFileName);
                        } else if (theFileName.match(/\.(zip)$/i)) {
                           var unzippedPgnText = "";
                           try {
                              var unzipper = new JSUnzip(e.target.result);
                              if (unzipper.isZipFile()) {
                                 unzipper.readEntries();
                                 for (u in unzipper.entries) {
                                    if (unzipper.entries[u].fileName.match(/\.pgn$/i)) {
                                       switch (unzipper.entries[u].compressionMethod) {
                                          case 0:
                                             unzippedPgnText += "\n" + unzipper.entries[u].data + "\n";
                                             break;
                                          case 8:
                                             unzippedPgnText += "\n" + JSInflate.inflate(unzipper.entries[u].data) + "\n";
                                             break;
                                          default:
                                             // unsupported compression method
                                             break;
                                       }
                                    }
                                 } 
                              }
                           } catch(e) { /* missing unzip library or unzip error */ }
                           if (unzippedPgnText) {
                              newPgnText += unzippedPgnText + "\n\n\n";
                              validFiles.push(theFileName);
                           } else {
                              errorFiles.push(theFileName);
                           }
                        } else {
                           errorFiles.push(theFileName);
                        }
                     } else {
                        errorFiles.push(theFileName);
                     }
                     if (! --pgnFilesLeft) { useNewPgnTextFromFiles(); }                            
                  };
               })(files[f].name);
               reader.onerror = (function(theFileName) {
                  return function(e) {
                     errorFiles.push(theFileName);
                     if (! --pgnFilesLeft) { useNewPgnTextFromFiles(); }                            
                  };
               })(files[f].name);
               if (files[f].name.match(/\.(zip)$/i)) { reader.readAsBinaryString(files[f]); }
               else { reader.readAsText(files[f]); }
            } else {
               invalidFiles.push(files[f].name);
               if (! --pgnFilesLeft) { useNewPgnTextFromFiles(); }
            }
         }
      } catch(e) {}
      if (theObject = document.getElementById("localPgnFiles")) { theObject.value = ""; }
   }

   function handleDragOver(evt) {
      evt.stopPropagation();
      evt.preventDefault();
   }

   try {
      if (theObject = document.getElementById("localPgnFiles")) {
         theObject.addEventListener("change", handleFileSelect, false);
      }

      if (theObject = document.getElementById("html")) {
         theObject.addEventListener("dragover", handleDragOver, false);
         theObject.addEventListener("drop", handleFileSelect, false);
      }
   } catch(e) {}

   function useNewPgnTextFromFiles() {
      if (noNewPgnText = !newPgnText) { newPgnText = alertPgnHeader; }
      useNewPgnText(newPgnText);
      allRejectedFiles = invalidFiles.concat(errorFiles).sort();
      if (allRejectedFiles.length) {
         msg = (noNewPgnText ? "error" : "warning");
         msg += ": failed reading PGN games from ";
         msg += (allRejectedFiles.length) + " local ";
         msg += (allRejectedFiles.length == 1 ? "file" : "files");
         for (f in allRejectedFiles) { msg += "\n" + allRejectedFiles[f]; }
         myAlert(msg, noNewPgnText);
      }
   }

   function useNewPgnText(newPgnText) {
      SetPgnUrl(pgnData = "");
      SetLiveBroadcast(0, true, false, false);
      SetAutoplayDelay(2000);
      setInitialGameFromSearchGame();
      SetInitialHalfmove(0, true);
      firstStart = true;
      if (theObject = document.getElementById("pgnText")) { theObject.value = newPgnText; }
      if (theObject = document.getElementById("GameLiveStatus")) { theObject.innerHTML = ""; }
      if (theObject = document.getElementById("localPgnFiles")) { theObject.value = ""; }
      start_pgn4web();
   }

   function fetchInputPgnText() {
      if ((inputPgnText = prompt("Enter PGN chess games TEXT for viewing; pasting multi-line PGN data in the textbox is allowed:", "")) !== null) {
         pgnHeaderRegExpGlobal = /((\[\s*(\w+)\s*"([^"]*)"\s*\]\s*)+)/g;
         inputPgnText = inputPgnText.replace(pgnHeaderRegExpGlobal, "\n$1\n"); // add newline after header section
         inputPgnText = fixCommonPgnMistakes(inputPgnText);
         useNewPgnText(inputPgnText);
      }
   }

</script>

</body>

</html>
