<html id="html">

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2011 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<!-- 

HTML, CSS and Javascript code optimized for use as extension 
of Google Chrome. Don't use with any other browser.

-->

<head>

<title>chess games viewer</title>

<link href="chess-games-viewer.css" type="text/css" rel="stylesheet" />

<!-- not needed within a google chrome extension
<link rel="shortcut icon" href="pawn.ico" />
-->

<script src="pgn4web.js" type="text/javascript"></script>

</head>

<body id="body" onresize="fixCommentScrollbar();">

<!-- paste your PGN below and make sure you dont specify an external source with SetPgnUrl() -->
<form style="display: none;"><textarea style="display: none;" id="pgnText">

</textarea></form>
<!-- paste your PGN above and make sure you dont specify an external source with SetPgnUrl() -->

<script type="text/javascript">

   var backgroundPage;
   if ((typeof(chrome) != "undefined") && (chrome.extension) && (chrome.extension.getBackgroundPage)) {
      backgroundPage = chrome.extension.getBackgroundPage();
   }

   var highlightOption_default = true;
   var commentsOnSeparateLines_default = false;

   thisRegExp = /(&|\?)(help|h)([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      alert("pgn4web google chrome chess games viewer" + "\n" + 
            "chess-games-viewer.html parameters" + "\n\n" +
            " - pgnBackground = index" + "\n\n" +
            " - pgnData = URL.pgn" + "\n\n" +
            " - refreshMinutes = live broadcast delay (default 0 = live broadcast disabled)" + "\n\n" +
            " - refreshDemo = if set true sets live demo mode (default false)" + "\n\n" +
            " - search = search expression (default first game for normal view and first unfinished game for live broadcast view)" + "\n\n" +
            " - help");
   }

   function setPgnTextIndexFromTabId(tab) {
      if (backgroundPage) {
         if ((backgroundPage.pgnTextIndexFromTabId[tab.id] !== null) && (backgroundPage.pgnTextIndexFromTabId[tab.id] !== undefined) && (backgroundPage.pgnTextIndexFromTabId[tab.id] !== pgnBackground)) {
            backgroundPage.removePgnTextOnRemoved(tab.id);
         }
         backgroundPage.pgnTextIndexFromTabId[tab.id] = pgnBackground;
         theObject = document.getElementById("pgnText");
         if ((theObject) && (theObject.value) && (theObject.value != backgroundPage.pgnText[pgnBackground]))
         { backgroundPage.pgnText[pgnBackground] = theObject.value; }
      }
   }

   pgnBackground = null;
   if (backgroundPage) {
      thisRegExp = /(&|\?)(pgnBackground|pb)=([^&]*)(&|$)/i;
      if (window.location.search.match(thisRegExp) !== null) {
         if ((pgnBackground = unescape(window.location.search.match(thisRegExp)[3])) !== "") {
            theObject = document.getElementById("pgnText");
            theBackgroundPgnText = backgroundPage.pgnText[pgnBackground];
            if ((theObject) && (theBackgroundPgnText) && (theBackgroundPgnText !== undefined)) 
            { theObject.value = theBackgroundPgnText; }
            chrome.tabs.getCurrent(setPgnTextIndexFromTabId);
         }
      }
   }

   pgnData = "";
   thisRegExp = /(&|\?)(pgnData|pd)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      pgnData = unescape(window.location.search.match(thisRegExp)[3]);
   } 
   if (pgnData) {
      SetPgnUrl(pgnData); // if set, this has precedence over the inline PGN in the HTML file
   }

   SetImagePath("alpha/128"); // use "" path if images are in the same folder as this javascript file
   SetImageType("png");
   SetHighlightOption(getHighlightOptionFromLocalStorage()); // true or false
   SetGameSelectorOptions(null, true, 12, 12, 2, 15, 15, 3, 10); // (head, num, chEvent, chSite, chRound, chWhite, chBlack, chResult, chDate);   
   SetCommentsIntoMoveText(true);
   SetCommentsOnSeparateLines(getCommentsOnSeparateLinesFromLocalStorage());
   SetAutostartAutoplay(false);
   SetAutoplayNextGame(false); // if set, move to the next game at the end of the current game during autoplay
   SetShortcutKeysEnabled(true);

   alertFlag = demoFlag = false;
   thisRegExp = /(&|\?)(refreshDemo|rd)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      refreshDemo = unescape(window.location.search.match(thisRegExp)[3]);
      if ((refreshDemo == "true") || (refreshDemo == "t")) { alertFlag = demoFlag = true; }
   }

   refreshMinutes = 0;
   stepFlag = true;
   thisRegExp = /(&|\?)(refreshMinutes|rm)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      refreshMinutes = unescape(window.location.search.match(thisRegExp)[3]);
      SetLiveBroadcast(refreshMinutes, alertFlag, demoFlag, stepFlag); // set live broadcast; parameters are delay (refresh delay in minutes, 0 means no broadcast, default 0) alertFlag (if true, displays debug error messages, default false) demoFlag (if true starts broadcast demo mode, default false) stepFlag (if true, autoplays updates in steps, default false)
      SetAutoplayDelay(1000); // milliseconds
      SetInitialHalfmove("end", true); // halfmove number to be shown at load, 0 for start position, -1 for random halfmove
   } else {
      SetAutoplayDelay(2000); // milliseconds
      SetInitialHalfmove(0, true); // halfmove number to be shown at load, 0 for start position, -1 for random halfmove
   }

   thisRegExp = /(&|\?)(search|s)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      SetInitialGame(unescape(window.location.search.match(thisRegExp)[3])); // search for game matching search string
   } else if (refreshMinutes) {
      SetInitialGame("\\[\\s*Result\\s*\"\\*\"\\s*\\]"); // search for first unfinished game ([Result "*"])
   } else {
      SetInitialGame(1); // number of game to be shown at load, from 1 (default); values (keep the quotes) of "first", "last", "random" are accepted; other string values assumed as PGN search string
   }

   function getHighlightOptionFromLocalStorage() {
      try { ho = (localStorage.getItem("pgn4web_chess_games_viewer_highlightOption") != "false"); }
      catch (e) { return highlightOption_default; }
      return ho;
   }
   function setHighlightOptionToLocalStorage() {
      try { localStorage.setItem("pgn4web_chess_games_viewer_highlightOption", highlightOption ? "true" : "false"); }
      catch (e) { return false; }
      return true;
   }

   function getCommentsOnSeparateLinesFromLocalStorage() {
      try { cosl = (localStorage.getItem("pgn4web_chess_games_viewer_commentsOnSeparateLines") == "true"); }
      catch (e) { return commentsOnSeparateLines_default; }
      return cosl;
   }
   function setCommentsOnSeparateLinesToLocalStorage() {
      try { localStorage.setItem("pgn4web_chess_games_viewer_commentsOnSeparateLines", commentsOnSeparateLines ? "true" : "false"); }
      catch (e) { return false; }
      return true;
   }

   // A7
   if ((typeof(chrome) != "undefined") && (typeof(chrome.tabs) != "undefined") && (typeof(chrome.tabs.create) != "undefined")) { boardShortcut("A7", "about the chess games viewer extension for google chrome", function(){ chrome.tabs.create({url: "about.html"}); }); }
   // C7
   boardShortcut("C7", "toggle show comments on separate lines in game text and save setting", function(){ SetCommentsOnSeparateLines(!commentsOnSeparateLines); oldPly = CurrentPly; Init(); GoToMove(oldPly); setCommentsOnSeparateLinesToLocalStorage(); });
   // D7
   boardShortcut("D7", "toggle highlight last move and save setting", function(){ SetHighlight(!highlightOption); setHighlightOptionToLocalStorage(); });

   function fixHeaderTag(elementId) {
      var headerId = ["GameEvent", "GameSite", "GameDate", "GameRound", "GameWhite", "GameBlack", "GameResult", "GameSection", "GameStage", "GameBoardNum", "Timecontrol", "GameWhiteTitle", "GameBlackTitle", "GameWhiteElo", "GameBlackElo", "GameECO", "GameOpening", "GameVariation", "GameSubVariation", "GameTermination", "GameWhiteClock", "GameBlackClock", "GameTimeControl"];
      var headerLabel = ["event", "site", "date", "round", "white player", "black player", "result", "section", "stage", "board", "time control", "white title", "black title", "white elo", "black elo", "eco", "opening", "variation", "subvariation", "termination", "white clock", "black clock", "time control"];
      theObject = document.getElementById(elementId);
      if (theObject) { 
        theObject.className = (theObject.innerHTML === "") ? "innerHeaderItemNoMargin" : "innerHeaderItem"; 
        theObject.title = (headerId.indexOf(elementId) < 0 ? elementId : headerLabel[headerId.indexOf(elementId)] ) + ": " + theObject.innerHTML;
      }
   }

   function customPgnHeaderTagWithFix(tag, elementId) {
      customPgnHeaderTag(tag, elementId);
      fixHeaderTag(elementId);
   }

   function fixCommentScrollbar() {
      if (theObject = document.getElementById('lastMoveAndComment')) {
         theObject.style.paddingRight = "1em";
         if (theObject.offsetWidth == theObject.clientWidth) { theObject.style.paddingRight = '0'; }
         else { theObject.scrollTop = 0; }
      }
   }

   function customFunctionOnMove() {
      wObject = document.getElementById('GameWhiteClock');
      bObject = document.getElementById('GameBlackClock');
      if (wObject && bObject) {
         if ((!wObject.innerHTML.match(/\S/)) && (bObject.innerHTML.match(/\S/))) { wObject.innerHTML = '-'; }
         if ((!bObject.innerHTML.match(/\S/)) && (wObject.innerHTML.match(/\S/))) { bObject.innerHTML = '-'; }
      }
      fixHeaderTag('GameWhiteClock');
      fixHeaderTag('GameBlackClock');
      if (theObject = document.getElementById('GameLastMove')) {
         if (CurrentPly == StartPly) {
            theObject.innerHTML = ((CurrentPly%2) ? "black" : "white") + " to move";
         }
      }
      if ((theObject = document.getElementById("infoMessage")) && (theObject.innerHTML)) {
         theObject.innerHTML = "";
         theObject.style.display = "";
      }
      fixCommentScrollbar();
   }

   function customFunctionOnPgnGameLoad() {
      fixHeaderTag('GameDate');
      fixHeaderTag('GameSite');
      fixHeaderTag('GameEvent');
      customPgnHeaderTagWithFix('Section', 'GameSection');
      customPgnHeaderTagWithFix('Stage', 'GameStage');
      fixHeaderTag('GameRound');
      if (theObject = document.getElementById("GameRound")) {
         if (theObject.innerHTML) {
            theObject.innerHTML = "round " + theObject.innerHTML;
         }
      }
      customPgnHeaderTagWithFix('Board', 'GameBoardNum');
      if (theObject = document.getElementById("GameBoardNum")) {
         if (theObject.innerHTML) {
            theObject.innerHTML = "board " + theObject.innerHTML;
         }
      }
      customPgnHeaderTagWithFix('TimeControl', 'GameTimeControl');
      fixHeaderTag('GameWhite');
      fixHeaderTag('GameBlack');
      customPgnHeaderTagWithFix('WhiteTitle', 'GameWhiteTitle');
      customPgnHeaderTagWithFix('BlackTitle', 'GameBlackTitle');
      customPgnHeaderTagWithFix('WhiteElo', 'GameWhiteElo');
      customPgnHeaderTagWithFix('BlackElo', 'GameBlackElo');
      customPgnHeaderTagWithFix('ECO', 'GameECO');
      customPgnHeaderTagWithFix('Opening', 'GameOpening');
      customPgnHeaderTagWithFix('Variation', 'GameVariation');
      customPgnHeaderTagWithFix('SubVariation', 'GameSubVariation');
      fixHeaderTag('GameResult');
      customPgnHeaderTagWithFix('Termination', 'GameTermination');
      // if (PlyNumber > 0) { customPgnHeaderTag('Result', 'ResultAtGametextEnd'); }
      // else { if (theObject = document.getElementById('ResultAtGametextEnd')) { theObject.innerHTML = ""; } }
      var lastDisplayStyle = "none";
      for(ii=StartPly; ii<=StartPly+PlyNumber; ii++) {
        if (strippedMoveComment(ii)) {
          lastDisplayStyle = "block";
          break;
        }
      }
      if (theObject = document.getElementById('lastMoveAndComment')) {
        theObject.style.display = lastDisplayStyle;
      }
   }

   function customFunctionOnPgnTextLoad() {
      if (LiveBroadcastStatusString) {
         document.title = LiveBroadcastStatusString.replace(" &nbsp;", ",");
      } else {
         if ((numberOfGames == 1) && (PlyNumber === 0) && (StartPly === 0) && (!gameWhite[0]) && (!gameBlack[0]) && (!gameResult[0])) {
            document.title = alertNum ? "PGN data error" : "chess games viewer";
         } else {
            document.title = numberOfGames + " game" + (numberOfGames == 1 ? "" : "s");
         }
      }
   }

   function underlineByTicker(text, ticker) {
      position = ticker % text.length;
      return (text.substring(0, position) + "<u>" +text.substring(position, position + 1) + "</u>" + text.substring(position + 1));
   }

   function customFunctionOnCheckLiveBroadcastStatus() {
      if (theObject = document.getElementById("GameLiveStatus")) {
         if (LiveBroadcastTicker > 1) {
            theObject.innerHTML =  theObject.innerHTML.replace(/live/, underlineByTicker("live", LiveBroadcastTicker-2));
         }
      }
   }

   function customShortcutKey_Shift_1() {
      if (gameWhite[currentGame]) {
         window.open("http://ratings.fide.com/seek.phtml?idcode=&name=" + gameWhite[currentGame] + "&offset=0");
      }
   }

   function customShortcutKey_Shift_2() {
      if (gameBlack[currentGame]) {
         window.open("http://ratings.fide.com/seek.phtml?idcode=&name=" + gameBlack[currentGame] + "&offset=0");
      }
   }

</script>

<div id="GameSelector"></div>
<div id="GameSearch"></div>

<a name="board"></a>

<div class="columnsContainer">

<div class="boardColumn">
<center>
<div id="GameBoard"></div>
<div id="GameButtons"></div>
</center>
</div>

<div class="headerColumn">
<div class="headerItem"><span class="innerHeaderItem" id="GameDate"></span><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameSite"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameEvent"></span><span class="innerHeaderItem" id="GameSection"></span><span class="innerHeaderItem" id="GameStage"></span><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameRound"></span><span class="innerHeaderItem" id="GameBoardNum"></span><span class="innerHeaderItem" id="GameTimeControl"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameECO"></span><span class="innerHeaderItem" id="GameOpening"></span><span class="innerHeaderItem" id="GameVariation"></span><span class="innerHeaderItem" id="GameSubVariation"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameWhiteClock"></span><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="#" class="innerHeaderItem" id="GameWhite"></a></b><span class="innerHeaderItem" id="GameWhiteTitle"></span><span class="innerHeaderItem" id="GameWhiteElo"></span><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="#board" class="innerHeaderItem" id="GameBlack"></a></b><span class="innerHeaderItem" id="GameBlackTitle"></span><span class="innerHeaderItem" id="GameBlackElo"></span><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameBlackClock"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="#bottom" class="innerHeaderItem" id="GameResult"></a></b><span class="innerHeaderItem" id="GameTermination"></span><b>&nbsp;</b></div>
</div>

</div>

<div class="infoMessage" id="infoMessage"></div>
<div class="lastMoveAndComment" id="lastMoveAndComment"><a href="javascript:MoveToPrevComment();" class="lastMove" title="last move" id="GameLastMove"></a><a href="javascript:MoveToNextComment();" class="lastComment" title="current position comment" id="GameLastComment"></a></div>

<div class="moveText"><span id="GameText"></span> <span class="move" id="ResultAtGametextEnd"></span></div>

<div id="notes" class="notes">

<div id="notesRight" class="notesRight"></div>

<div id="notesLeft" class="notesLeft">
<span title="live broadcast status" id="GameLiveStatus"></span>
<input type="file" id="localPgnFiles" name="localPgnFiles[]" multiple="multiple" class="inputFiles" size="4" style="display:none;" title="use the file selector input to choose *.PGN chess games or drag and drop *.PGN files on this page" />
&nbsp;
</div>

</div>

<script type="text/javascript">

   if (pgnData && (theObject = document.getElementById("notesRight"))) {
      theObject.innerHTML = "<a title='chess games source' class='notesLink' href=" + pgnData + ">" + pgnData + "</a>";
   } else if (pgnBackground && (theObject = document.getElementById("notesRight"))) {
      theObject.innerHTML = "chess games from PGN text input";
   } else if (theObject = document.getElementById("localPgnFiles")) {
      theObject.style.display = "";
      theObject.click(); /* currently does not have any effect, hopefully someday chrome will comply */
      if (theObject = document.getElementById("notesRight")) {
         theObject.innerHTML = "<span title='use the file selector input to choose *.PGN chess games or drag and drop *.PGN files on this page'>choose *.PGN chess games files or drag and drop them on this page</span>";
      }
   }

   var newPgnText;
   var pgnFilesLeft;
   var invalidFiles;
   var validFiles;
   var errorFiles;
   function handleFileSelect(evt) {
      evt.stopPropagation();
      evt.preventDefault();

      var files = new Array();
      if (evt.target.files) { files = evt.target.files; }
      else if (evt.dataTransfer.files) { files = evt.dataTransfer.files; }

      try {
         newPgnText = "";
         pgnFilesLeft = files.length;
         invalidFiles = new Array();
         validFiles = new Array();
         errorFiles = new Array();
         for (f=0; f<files.length; f++) {
            if (files[f].name.match(/\.pgn$/i)) {
               var reader = new FileReader();
               reader.onload = (function(theFileName) {
                  return function(e) {
                     if (e.target.result) {
                        newPgnText += e.target.result + "\n\n\n";
                        validFiles.push(theFileName);
                     } else {
                        errorFiles.push(theFileName);
                     }
                     if (! --pgnFilesLeft) { useNewPgnText(); }                            
                  };
               })(files[f].name);
               reader.onerror = (function(theFileName) {
                  return function(e) {
                     errorFiles.push(theFileName);
                     if (! --pgnFilesLeft) { useNewPgnText(); }                            
                  };
               })(files[f].name);
               reader.readAsText(files[f]);
            } else {
               invalidFiles.push(files[f].name);
               if (! --pgnFilesLeft) { useNewPgnText(); }
            }
         }
      } catch(e) {}
   }

   function handleDragOver(evt) {
      evt.stopPropagation();
      evt.preventDefault();
   }

   try {
      if (theObject = document.getElementById("localPgnFiles")) {
         theObject.addEventListener("change", handleFileSelect, false);
      }

      if (theObject = document.getElementById("html")) {
         theObject.addEventListener("dragover", handleDragOver, false);
         theObject.addEventListener("drop", handleFileSelect, false);
      }
   } catch(e) {}

   function useNewPgnText() {
      if (newPgnText && (validFiles.length > 0)) {
         SetPgnUrl("");
         SetLiveBroadcast(0, true, false, false);
         SetAutoplayDelay(2000); // milliseconds
         SetInitialHalfmove(0, true); // halfmove number to be shown at load, 0 for start position, -1 for random halfmove
         firstStart = true;
         if (theObject = document.getElementById("pgnText")) { theObject.value = newPgnText; }
         if (theObject = document.getElementById("GameLiveStatus")) { theObject.innerHTML = ""; }
         if (theObject = document.getElementById("notesRight")) {
            text = "chess games from " + validFiles.length + " local PGN " + (validFiles.length == 1 ? "file" : "files");
            theObject.innerHTML = "<span title='" + text + ": \n" + validFiles.sort().join(" \n") + "'>" + text + "</span>";
            theObject.style.marginTop = "";
         }
         if (theObject = document.getElementById("localPgnFiles")) { 
            theObject.style.display = "";
            theObject.value = "";
         }
         location.hash = "top";
         start_pgn4web();
         location.hash = "board";
      }
      if (theObject = document.getElementById("infoMessage")) {
         if ((invalidFiles.length > 0) || (errorFiles.length > 0)) {
            text = "<span class='infoMessageHighlight'>" + (newPgnText ? "warning:" : "error:") + "</span> the chess games viewer only accepts chess games *.PGN files; files generating errors while loading, empty files, files other than *.PGN files and folders are rejected:<ul type='square'><li>" + invalidFiles.concat(errorFiles).sort().join("</li><li>") + "</li></ul>";
            if (validFiles.length > 0) { text += "loaded *.PGN files:<ul><li type='square'>" + validFiles.sort().join("</li><li>") + "</li></ul>"; }
            theObject.innerHTML = text;
            theObject.style.display = "block";
         } else {
            theObject.innerHTML = "";
            theObject.style.display = "";
         }
      }
   }

</script>

<div class="footer"><a name="bottom"></a></div>

</body>

</html>
