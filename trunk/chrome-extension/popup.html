<!DOCTYPE html>
<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2011 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<!--

HTML, CSS and Javascript code optimized for use as extension
of Google Chrome. Don't use with any other browser.

-->

<head>

<style type="text/css">

body {
  margin: 2em;
  margin-bottom: 1em;
  margin-right: 0;
  background: white;
  background: -webkit-linear-gradient(#FFFFFF, #F0F0F0);
  color: black;
  font-family: sans-serif;
  white-space: nowrap;
  overflow: hidden;
}

.pgnHeader {
  margin-right: 2em;
  line-height: 2em;
  font-weight: bold;
}

.pgnHeaderLink, .pgnListLink, .pgnFileName {
  color: black;
  text-decoration: none;
}

.measure {
  height: 1em;
  width: 100%;
}

.pgnLinkList {
  margin: 0;
  padding: 0;
  line-height: 2em;
  overflow-x: hidden;
  overflow-y: auto;
}

.pgnItem {
}

.pgnListLink {
  margin-right: 0.6em;
}

.linkImage {
  height: 1em;
  width: 1em;
}

.pgnFileName {
  margin-left: 1em;
  white-space: nowrap;
}

.pgnFooter {
  height: 1em;
  width: 100%;
}

</style>

</head>

<body>

<div id="pgnHeader" class="pgnHeader"></div>
<div id="measure" class="measure" onmouseover="scrollLinkList(true, false);" onmouseout="stopScrollLinkList();" onclick="scrollLinkList(true, true);">&nbsp</div>
<div id="pgnLinkList" class="pgnLinkList"></div>
<div class="pgnFooter" onmouseover="scrollLinkList(false, false);" onmouseout="stopScrollLinkList();" onclick="scrollLinkList(false, true);">&nbsp;</div>

<script type="text/javascript">

var em = document.getElementById("measure").offsetHeight; /* measuring em in px */

scrollLinkListTimeout = null;

function scrollLinkList(up, allTheWay) {
   if (theObject = document.getElementById("pgnLinkList")) {
      if ((up && theObject.scrollTop === 0) || (!up && theObject.scrollTop === theObject.scrollHeight - theObject.offsetHeight)) { return; }
      stopScrollLinkList();
      if (allTheWay) {
         theObject.scrollTop = up ? 0 : theObject.scrollHeight - theObject.offsetHeight;
      } else {
         theObject.scrollTop = theObject.scrollTop + (up ? -2 : 2) * em;
         scrollLinkListTimeout = setTimeout("scrollLinkList(" + up + ", false);", 666);
      }
   }
}

function stopScrollLinkList() {
   if (scrollLinkListTimeout) {
      clearTimeout(scrollLinkListTimeout);
      scrollLinkListTimeout = null;
   }
}

var cursorDef = "url(cursor-small.png) 1 6, auto";

var pgnLinksDisplay = new Array();
var pgnLinksId = new Array();

chrome.tabs.getSelected(null, function(tab){

  function displayUrl(url, base) {
    adjUrl = url.replace(/(?=:)\/+/, "/");
    adjBase = base.replace(/[?#].*$/, "").replace(/(?=:)\/+/, "/").replace(/\/[^\/]*$/, "") + "/";
    retUrl = url;
    if (adjUrl.indexOf(adjBase) === 0) { retUrl = adjUrl.substr(adjBase.length); }
    else {
      if (hostBaseMatch = adjBase.match(/^[^:\/]+:\/\/[^\/]+/, "")) {
        hostBase = hostBaseMatch[0];
        if (adjUrl.indexOf(hostBase) != -1) { retUrl = adjUrl.substr(hostBase.length); }
      }
    }
    // return retUrl;
    return htmlentities(unescape(retUrl));
  }

  function sortPgnLinks(a, b) {
    aHasPath = (pgnLinksDisplay[a].indexOf("/") != -1);
    bHasPath = (pgnLinksDisplay[b].indexOf("/") != -1);
    if (!aHasPath && bHasPath) { return -1; }
    if (aHasPath && !bHasPath) { return  1; }

    aHasHost = (pgnLinksDisplay[a].indexOf("://") != -1);
    bHasHost = (pgnLinksDisplay[b].indexOf("://") != -1);
    if (!aHasHost && bHasHost) { return -1; }
    if (aHasHost && !bHasHost) { return  1; }

    aAtRoot = (pgnLinksDisplay[a].indexOf("/") === 0);
    bAtRoot = (pgnLinksDisplay[b].indexOf("/") === 0);
    if (!aAtRoot && bAtRoot) { return -1; }
    if (aAtRoot && !bAtRoot) { return  1; }

    if (pgnLinksDisplay[a].toLowerCase() < pgnLinksDisplay[b].toLowerCase()) { return -1; }
    if (pgnLinksDisplay[a].toLowerCase() > pgnLinksDisplay[b].toLowerCase()) { return 1; }
    if (pgnLinksDisplay[a] > pgnLinksDisplay[b]) { return -1; } // if lowercase comparison is equal, place lowercase first
    if (pgnLinksDisplay[a] < pgnLinksDisplay[b]) { return 1; } 
    return 0;
  }

  var headerObject = document.getElementById("pgnHeader");
  var listObject = document.getElementById("pgnLinkList");

  var pgnHeaderInnerHTML = '<a class="pgnHeaderLink" title="chess games viewer extension help" target="_blank" href="javascript:void(0);" onclick="chrome.extension.getBackgroundPage().showAboutPage(); self.close();">Chess games viewer</a>';

  if ((typeof(chrome.extension.getBackgroundPage().pgnHrefLinks[tab.id]) == "undefined") || (typeof(chrome.extension.getBackgroundPage().pgnWebRequests[tab.id]) == "undefined")) {
    listObject.style.marginRight = "2em";
    listObject.innerHTML = "please reload the page to look for links to PGN chess games";
    headerObject.innerHTML = pgnHeaderInnerHTML + ": error";
    return;
  }
  pgnLinks = chrome.extension.getBackgroundPage().pgnHrefLinks[tab.id];
  pgnLinks = pgnLinks.concat(chrome.extension.getBackgroundPage().pgnWebRequests[tab.id]);

  for (l in pgnLinks) {
    pgnLinksDisplay[l] = displayUrl(pgnLinks[l], tab.url);
    pgnLinksId[l] = l;
  }
  pgnLinksId = pgnLinksId.sort(sortPgnLinks);

  // fix the link list height to show up to 10 items
  // to cope with chrome bugs http://crbug.com/76899 and http://crbug.com/50192
  maxLinkListItems = 10;
  if (pgnLinks.length > maxLinkListItems) {
    listObject.style.maxHeight = (maxLinkListItems * 2) + "em";
    listObject.style.paddingRight = "2em";
  } else { listObject.style.marginRight = "2em"; }

  pgnHeaderInnerHTML += ': <span title="the chess games viewer extension detected on this page ' + 
    pgnLinks.length + (pgnLinks.length == 1 ? ' link' : ' links') + ' to chess games in PGN format">' + 
    pgnLinks.length + (pgnLinks.length == 1 ? ' link' : ' links') + ' on this page</span>';

  var pgnLinkListInnerHTML = "";
  for(ll in pgnLinks) {
    l = pgnLinksId[ll];
    pgnLinkListInnerHTML += '<div class="pgnItem">' +
      '<a title="view on a single board games from\n' + pgnLinks[l] + '" class="pgnListLink" href="javascript:void(0);" onmouseover=\'this.style.cursor="' + cursorDef + '";\' onclick=\'chrome.tabs.create({url: "chess-games-viewer.html?pgnData=' + escape(pgnLinks[l]) + '"}); self.close();\'><img src="alpha-16.png" class="linkImage"></a>' +
      '<a title="view on a single board with live refresh games from\n' + pgnLinks[l] + '" class="pgnListLink" href="javascript:void(0);" onmouseover=\'this.style.cursor="' + cursorDef + '";\' onclick=\'chrome.tabs.create({url: "chess-games-viewer.html?pgnData=' + escape(pgnLinks[l]) + '&refreshMinutes=1.0' + Math.floor(Math.random()*10) + '"}); self.close();\'><img src="refresh.png" class="linkImage"></a>' +
      '<a title="view on multiple boards with live refresh games from\n' + pgnLinks[l] + '" class="pgnListLink" href="javascript:void(0);" onmouseover=\'this.style.cursor="' + cursorDef + '";\' onclick=\'chrome.tabs.create({url: "live-mosaic-viewer.html?pgnData=' + escape(pgnLinks[l]) + '&refreshMinutes=1.0' + Math.floor(Math.random()*10) + '&headlessPage=true"}); self.close();\'><img src="refresh-mosaic.png" class="linkImage"></a>' +
      '<a title="download games from\n' + pgnLinks[l] + '" class="pgnListLink" href="javascript:void(0);" onmouseover=\'this.style.cursor="' + cursorDef + '";\' onclick=\'chrome.tabs.update(' + tab.id + ', {url: "' + pgnLinks[l] + '"}); self.close();\'><img src="download.png" class="linkImage"></a>' +
      '<a id="pgnLinkUrl_' + l + '" title="chess games link #' + (parseInt(ll, 10) + 1) + '\n' + pgnLinks[l] + '" class="pgnFileName" href="javascript:void(0);" onclick="toggleFullPgnUrl(' + l + ');">' + pgnLinksDisplay[l] + '</a>' +
      '</div>';
  }

  listObject.innerHTML = pgnLinkListInnerHTML;
  headerObject.innerHTML = pgnHeaderInnerHTML;
});

var toggledFullUrlNum = null;
function toggleFullPgnUrl(l) {
  if (link = document.getElementById("pgnLinkUrl_" + l)) {
    previousToggledFullUrlNum = toggledFullUrlNum;
    link.innerHTML = (toggledFullUrlNum === l) ? pgnLinksDisplay[l] : pgnLinks[l];
    toggledFullUrlNum = (toggledFullUrlNum === l) ? null : l;
    if ((previousToggledFullUrlNum !== l) && (previousToggledFullUrlNum !== null) && (previousToggledFullUrlLink = document.getElementById("pgnLinkUrl_" + previousToggledFullUrlNum))) { previousToggledFullUrlLink.innerHTML = pgnLinksDisplay[previousToggledFullUrlNum]; }
  }
}


var hash_map, hash_map_quote_style;
function htmlentities (string, quote_style, charset, double_encode) {
  // version: 1109.2015 + pgn4web modifications
  // original source: http://phpjs.org/functions/htmlentities

  if (!hash_map || hash_map_quote_style !== quote_style) { hash_map = this.get_html_translation_table('HTML_ENTITIES', quote_style); }
  var symbol;
  string = typeof(string) == "undefined" ? '' : string + '';
 
  if (!hash_map) { return false; }
    
  if (quote_style && quote_style === 'ENT_QUOTES') { hash_map["'"] = '&#039;'; }
    
  if (!!double_encode || typeof(double_encode) == "undefined") {
    for (symbol in hash_map) {
      if (hash_map.hasOwnProperty(symbol)) {
        string = string.split(symbol).join(hash_map[symbol]);
      }
    }
  } else {
    string = string.replace(/([\s\S]*?)(&(?:#\d+|#x[\da-f]+|[a-zA-Z][\da-z]*);|$)/g, function (ignore, text, entity) {
      for (symbol in hash_map) {
        if (hash_map.hasOwnProperty(symbol)) {
          text = text.split(symbol).join(hash_map[symbol]);
        }
      }
      return text + entity;
    });
  }
  return string;
}

function get_html_translation_table (table, quote_style) {
  // version: 1109.2015 + pgn4web modifications
  // original source: http://phpjs.org/functions/get_html_translation_table

  var entities = {},
      local_hash_map = {},
      decimal;
  var constMappingTable = {},
      constMappingQuoteStyle = {};
  var useTable = {},
      useQuoteStyle = {};

  // Translate arguments
  constMappingTable[0] = 'HTML_SPECIALCHARS';
  constMappingTable[1] = 'HTML_ENTITIES';
  constMappingQuoteStyle[0] = 'ENT_NOQUOTES';
  constMappingQuoteStyle[2] = 'ENT_COMPAT';
  constMappingQuoteStyle[3] = 'ENT_QUOTES';
 
  useTable = !isNaN(table) ? constMappingTable[table] : table ? table.toUpperCase() : 'HTML_SPECIALCHARS';
  useQuoteStyle = !isNaN(quote_style) ? constMappingQuoteStyle[quote_style] : quote_style ? quote_style.toUpperCase() : 'ENT_COMPAT';
 
  if (useTable !== 'HTML_SPECIALCHARS' && useTable !== 'HTML_ENTITIES') {
    throw new Error("Table: " + useTable + ' not supported');
    // return false;
  }
 
  entities['38'] = '&amp;';
  if (useTable === 'HTML_ENTITIES') {
    entities['160'] = '&nbsp;';
    entities['161'] = '&iexcl;';
    entities['162'] = '&cent;';
    entities['163'] = '&pound;';
    entities['164'] = '&curren;';
    entities['165'] = '&yen;';
    entities['166'] = '&brvbar;';
    entities['167'] = '&sect;';
    entities['168'] = '&uml;';
    entities['169'] = '&copy;';
    entities['170'] = '&ordf;';
    entities['171'] = '&laquo;';
    entities['172'] = '&not;';
    entities['173'] = '&shy;';
    entities['174'] = '&reg;';
    entities['175'] = '&macr;';
    entities['176'] = '&deg;';
    entities['177'] = '&plusmn;';
    entities['178'] = '&sup2;';
    entities['179'] = '&sup3;';
    entities['180'] = '&acute;';
    entities['181'] = '&micro;';
    entities['182'] = '&para;';
    entities['183'] = '&middot;';
    entities['184'] = '&cedil;';
    entities['185'] = '&sup1;';
    entities['186'] = '&ordm;';
    entities['187'] = '&raquo;';
    entities['188'] = '&frac14;';
    entities['189'] = '&frac12;';
    entities['190'] = '&frac34;';
    entities['191'] = '&iquest;';
    entities['192'] = '&Agrave;';
    entities['193'] = '&Aacute;';
    entities['194'] = '&Acirc;';
    entities['195'] = '&Atilde;';
    entities['196'] = '&Auml;';
    entities['197'] = '&Aring;';
    entities['198'] = '&AElig;';
    entities['199'] = '&Ccedil;';
    entities['200'] = '&Egrave;';
    entities['201'] = '&Eacute;';
    entities['202'] = '&Ecirc;';
    entities['203'] = '&Euml;';
    entities['204'] = '&Igrave;';
    entities['205'] = '&Iacute;';
    entities['206'] = '&Icirc;';
    entities['207'] = '&Iuml;';
    entities['208'] = '&ETH;';
    entities['209'] = '&Ntilde;';
    entities['210'] = '&Ograve;';
    entities['211'] = '&Oacute;';
    entities['212'] = '&Ocirc;';
    entities['213'] = '&Otilde;';
    entities['214'] = '&Ouml;';
    entities['215'] = '&times;';
    entities['216'] = '&Oslash;';
    entities['217'] = '&Ugrave;';
    entities['218'] = '&Uacute;';
    entities['219'] = '&Ucirc;';
    entities['220'] = '&Uuml;';
    entities['221'] = '&Yacute;';
    entities['222'] = '&THORN;';
    entities['223'] = '&szlig;';
    entities['224'] = '&agrave;';
    entities['225'] = '&aacute;';
    entities['226'] = '&acirc;';
    entities['227'] = '&atilde;';
    entities['228'] = '&auml;';
    entities['229'] = '&aring;';
    entities['230'] = '&aelig;';
    entities['231'] = '&ccedil;';
    entities['232'] = '&egrave;';
    entities['233'] = '&eacute;';
    entities['234'] = '&ecirc;';
    entities['235'] = '&euml;';
    entities['236'] = '&igrave;';
    entities['237'] = '&iacute;';
    entities['238'] = '&icirc;';
    entities['239'] = '&iuml;';
    entities['240'] = '&eth;';
    entities['241'] = '&ntilde;';
    entities['242'] = '&ograve;';
    entities['243'] = '&oacute;';
    entities['244'] = '&ocirc;';
    entities['245'] = '&otilde;';
    entities['246'] = '&ouml;';
    entities['247'] = '&divide;';
    entities['248'] = '&oslash;';
    entities['249'] = '&ugrave;';
    entities['250'] = '&uacute;';
    entities['251'] = '&ucirc;';
    entities['252'] = '&uuml;';
    entities['253'] = '&yacute;';
    entities['254'] = '&thorn;';
    entities['255'] = '&yuml;';
  }
 
  if (useQuoteStyle !== 'ENT_NOQUOTES') { entities['34'] = '&quot;'; }
  if (useQuoteStyle === 'ENT_QUOTES') { entities['39'] = '&#39;'; }
  entities['60'] = '&lt;';
  entities['62'] = '&gt;';

  // ascii decimals to real symbols
  for (decimal in entities) {
    if (entities.hasOwnProperty(decimal)) {
      local_hash_map[String.fromCharCode(decimal)] = entities[decimal];
    }
  }
 
  return local_hash_map;
}

</script>

</body>

</html>