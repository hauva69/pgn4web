<!DOCTYPE html>
<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2011 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<!--

HTML, CSS and Javascript code optimized for use as extension
of Google Chrome. Don't use with any other browser.

-->

<head>

<style type="text/css">

body {
  margin: 2em;
  margin-right: 0;
  background: white;
  background: -webkit-linear-gradient(#FFFFFF, #F0F0F0);
  color: black;
  font-family: sans-serif;
  white-space: nowrap;
  overflow: hidden;
}

.pgnHeader {
  margin-right: 2em;
  font-weight: bold;
}

.pgnHeaderLink, .pgnListLink, .pgnFileName {
  color: black;
  text-decoration: none;
}

.measure {
  height: 1em;
  width: 1em;
  overflow-y: hidden;
  overflow-x: hidden;
  visibility: hidden;
}

.pgnLinkList {
  margin: 0;
  padding: 0;
  line-height: 2em;
  overflow-x: hidden;
  overflow-y: auto;
}

.pgnItem {
}

.pgnListLink {
  margin-right: 0.6em;
}

.linkImage {
  height: 1em;
  width: 1em;
}

.pgnFileName {
  margin-left: 1em;
}

</style>

</head>

<body>

<div id="pgnHeader" class="pgnHeader"></div>
<div id="measure" class="measure">hidden text to measure some page elements</div>
<div id="pgnLinkList" class="pgnLinkList"></div>

<script type="text/javascript">

var cursorDef = "url(cursor-small.png) 1 6, auto";

chrome.tabs.getSelected(null, function(tab){

  function displayUrl(url, base) {
    adjUrl = url.replace(/(?=:)\/+/, "/");
    adjBase = base.replace(/(?=:)\/+/, "/").replace(/\/[^\/]*$/, "") + "/";
    if (adjUrl.indexOf(adjBase) === 0) { return (adjUrl.substr(adjBase.length)); }

    if (hostBaseMatch = adjBase.match(/^[^:\/]+:\/\/[^\/]+/, "")) {
      hostBase = hostBaseMatch[0];
      if (adjUrl.indexOf(hostBase) != -1) { return adjUrl.substr(hostBase.length); }
    }

    return url;
  }

  function sortPgnLinks(a, b) {
    aHasPath = (pgnLinksDisplay[a].indexOf("/") != -1);
    bHasPath = (pgnLinksDisplay[b].indexOf("/") != -1);
    if (!aHasPath && bHasPath) { return -1; }
    if (aHasPath && !bHasPath) { return  1; }

    aHasHost = (pgnLinksDisplay[a].indexOf("://") != -1);
    bHasHost = (pgnLinksDisplay[b].indexOf("://") != -1);
    if (!aHasHost && bHasHost) { return -1; }
    if (aHasHost && !bHasHost) { return  1; }

    aAtRoot = (pgnLinksDisplay[a].indexOf("/") === 0);
    bAtRoot = (pgnLinksDisplay[b].indexOf("/") === 0);
    if (!aAtRoot && bAtRoot) { return -1; }
    if (aAtRoot && !bAtRoot) { return  1; }

    if (pgnLinksDisplay[a].toLowerCase() < pgnLinksDisplay[b].toLowerCase()) { return -1; }
    if (pgnLinksDisplay[a].toLowerCase() > pgnLinksDisplay[b].toLowerCase()) { return 1; }
    if (pgnLinksDisplay[a] > pgnLinksDisplay[b]) { return -1; } // if lowercase comparison is equal, place lowercase first
    if (pgnLinksDisplay[a] < pgnLinksDisplay[b]) { return 1; } 
    return 0;
  }

  var headerObject = document.getElementById("pgnHeader");
  var listObject = document.getElementById("pgnLinkList");
  var measureObject = document.getElementById("measure");

  var pgnHeaderInnerHTML = '<a class="pgnHeaderLink" title="chess games viewer from the pgn4web project" target="_blank" href="javascript:void(0);" onclick="chrome.tabs.create({url: \'about.html\'});">Chess games viewer</a>';

  if ((typeof(chrome.extension.getBackgroundPage().pgnHrefLinks[tab.id]) == "undefined") || (typeof(chrome.extension.getBackgroundPage().pgnWebRequests[tab.id]) == "undefined")) {
    listObject.style.marginRight = "2em";
    listObject.innerHTML = "please reload the page to look for links to PGN chess games";
    headerObject.innerHTML = pgnHeaderInnerHTML + ": error";
    return;
  }
  pgnLinks = chrome.extension.getBackgroundPage().pgnHrefLinks[tab.id];
  pgnLinks = pgnLinks.concat(chrome.extension.getBackgroundPage().pgnWebRequests[tab.id]);

  var pgnLinksDisplay = new Array();
  var pgnLinksId = new Array();
  for (l in pgnLinks) {
    pgnLinksDisplay[l] = displayUrl(pgnLinks[l], tab.url);
    pgnLinksId[l] = l;
  }
  pgnLinksId = pgnLinksId.sort(sortPgnLinks);

  // workaround to cope with http://crbug.com/76899 and http://crbug.com/50192
  // fixing 76899 would avoid the need of the workaround
  // fixing 50192 could make the workaround simpler, for instance with a body max height
  var em = measureObject.offsetHeight; /* measuring em in px */
  var maxLinkListItems = Math.max(1, Math.ceil((0.6 * self.screen.availHeight - 6 * em) / (2 * em)));
  if (pgnLinks.length > maxLinkListItems) {
    listObject.style.maxHeight = (maxLinkListItems * 2) + "em";
    listObject.style.paddingRight = "2em";
  } else { listObject.style.marginRight = "2em"; }

  pgnHeaderInnerHTML += ': <span title="the chess games viewer extension detected on this page ' + 
    pgnLinks.length + (pgnLinks.length == 1 ? ' link' : ' links') + ' to chess games in PGN format">' + 
    pgnLinks.length + (pgnLinks.length == 1 ? ' link' : ' links') + ' on this page</span>';

  var pgnLinkListInnerHTML = "";
  for(ll in pgnLinks) {
    l = pgnLinksId[ll];
    pgnLinkListInnerHTML += '<div class="pgnItem">' +
      '<a title="view on a single board games from\n' + pgnLinks[l] + '" class="pgnListLink" href="javascript:void(0);" onmouseover=\'this.style.cursor="' + cursorDef + '";\' onclick=\'chrome.tabs.create({url: "chess-games-viewer.html?pgnData=' + escape(pgnLinks[l]) + '"}); self.close();\'><img src="alpha-16.png" class="linkImage"></a>' +
      '<a title="view on a single board with live refresh games from\n' + pgnLinks[l] + '" class="pgnListLink" href="javascript:void(0);" onmouseover=\'this.style.cursor="' + cursorDef + '";\' onclick=\'chrome.tabs.create({url: "chess-games-viewer.html?pgnData=' + escape(pgnLinks[l]) + '&refreshMinutes=1.0' + Math.floor(Math.random()*10) + '"}); self.close();\'><img src="refresh.png" class="linkImage"></a>' +
      '<a title="view on multiple boards with live refresh games from\n' + pgnLinks[l] + '" class="pgnListLink" href="javascript:void(0);" onmouseover=\'this.style.cursor="' + cursorDef + '";\' onclick=\'chrome.tabs.create({url: "live-mosaic-viewer.html?pgnData=' + escape(pgnLinks[l]) + '&refreshMinutes=1.0' + Math.floor(Math.random()*10) + '&headlessPage=true"}); self.close();\'><img src="refresh-mosaic.png" class="linkImage"></a>' +
      '<a title="download games from\n' + pgnLinks[l] + '" class="pgnListLink" href="javascript:void(0);" onmouseover=\'this.style.cursor="' + cursorDef + '";\' onclick=\'chrome.tabs.update(' + tab.id + ', {url: "' + pgnLinks[l] + '"}); self.close();\'><img src="download.png" class="linkImage"></a>' +
      '<a id="pgnLinkUrl_' + l + '" title="chess games link #' + (parseInt(ll, 10) + 1) + '\n' + pgnLinks[l] + '" class="pgnFileName" href="javascript:void(0);" onclick=\'toggleFullPgnUrl(' + l + ', "' + pgnLinksDisplay[l] + '", "' + pgnLinks[l] + '");\'>' + pgnLinksDisplay[l] + '</a>' +
      '</div>';
  }

  listObject.innerHTML = pgnLinkListInnerHTML;
  headerObject.innerHTML = pgnHeaderInnerHTML;
});

var toggledFullUrlNum = null;
var toggledFullUrlDisplay;
function toggleFullPgnUrl(l, displayUrl, fullUrl) {
  link = document.getElementById("pgnLinkUrl_" + l);
  if ((link) && (displayUrl !== fullUrl)) { link.innerHTML = (link.innerHTML == displayUrl) ? fullUrl : displayUrl; }
  if ((toggledFullUrlNum !== null) && (toggledFullUrlLink = document.getElementById("pgnLinkUrl_" + toggledFullUrlNum))) { toggledFullUrlLink.innerHTML = toggledFullUrlDisplay; }
  toggledFullUrlNum = ((link) && (link.innerHTML == fullUrl) && (displayUrl !== fullUrl)) ? l : null;
  toggledFullUrlDisplay = displayUrl;
}

</script>

</body>

</html>