<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2012 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<!--

HTML, CSS and Javascript code optimized for use as extension
of Google Chrome. Don't use with any other browser.

-->

<head>

<meta charset="utf-8">

<!-- base64 decoding -->
<script src="js-base64/base64.js" type="text/javascript"></script>
<!-- engine analysis module -->
<script src="engine-glue.js" type="text/javascript"></script>
<!-- tablebase assessment module -->
<script src="tablebase-glue.js" type="text/javascript"></script>

<script type="text/javascript">

var pgnHeaderRegExpGlobal = /((\[\s*(\w+)\s*"([^"]*)"\s*\]\s*)+)/g;

var pgnZipLinkRegExp = new RegExp("^((http|https):\\/\\/|" + chrome.extension.getURL("") + ")[^?#]+\\.(pgn|zip)($|\\?.*$|#.*$)", "i");
function validatePgnZipUrl(pgnUrl) {
  return (pgnUrl && pgnZipLinkRegExp.test(pgnUrl));
}

var pgnLinkRegExp = new RegExp("^((http|https):\\/\\/|" + chrome.extension.getURL("") + ")[^?#]+\\.pgn($|\\?.*$|#.*$)", "i");
function validatePgnUrl(pgnUrl) {
  return (pgnUrl && pgnLinkRegExp.test(pgnUrl));
}

function validateUrl(pgnUrl, live) {
  return (pgnUrl && (live ? validatePgnUrl(pgnUrl) : validatePgnZipUrl(pgnUrl)));
}

// keep this aligned with the one in pgn4web.js
function fixCommonPgnMistakes(text) {
  text = text.replace(/[\u00A0\u180E\u2000-\u200A\u202F\u205F\u3000]/g," "); // some "space" to plain space
  text = text.replace(/\u00BD/g,"1/2"); // "half fraction" to "1/2"
  text = text.replace(/[\u2010-\u2015]/g,"-"); // "hyphens" to "-"
  text = text.replace(/\u2024/g,"."); // "one dot leader" to "."
  text = text.replace(/[\u2025-\u2026]/g,"..."); // "two dot leader" and "ellipsis" to "..."
  text = text.replace(/\\"/g,"'"); // fix parsing headers like: [Opening "King\"s Indian Attack"]
  return text;
}

function validatePgnText(pgnText) {
  testPgnText = pgnText;
  testPgnText = testPgnText.replace(/(^|\n)%[^\n]*(?=\n|$)/g, ""); // remove comments
  testPgnText = testPgnText.replace(/{[^}]*}/g, ""); // remove comments
  testPgnText = testPgnText.replace(pgnHeaderRegExpGlobal, ""); // remove headers
  return (testPgnText.match(/[^\s0-9.a-hx:KQRBNO#+=!?$()*\/\n\r\-]+/) === null);
}

function openRemoteUrl(remoteUrl, live, all) {
  if (!remoteUrl) { return; }
  if (all) {
    liveParam = live ? "&refreshMinutes=1" : "";
    url = "live-mosaic-viewer.html?pgnData=" + escape(remoteUrl) + liveParam + "&hp=t";
  } else {
    liveParam = live ? "&refreshMinutes=1.0" + Math.floor(Math.random()*10) : "";
    url = "chess-games-viewer.html?pgnData=" + escape(remoteUrl) + liveParam;
  }
  chrome.tabs.create({url: url});
}

// until chromium bug http://crbug.com/84024 is resolved, context menus might appear
// for links not validating as PGN, such as http://host/file.html?pgnData=games.pgn

function pgnLinkOnClick(info, tab, live, all) {
  var remoteUrl = info.linkUrl;
  if (!remoteUrl) { return; }
  if (!validateUrl(remoteUrl, live)) {
    alert("warning: because of a limitation of the Google Chrome extensions URL pattern matching capabilities, the clicked link displays the link context menu of the chess games viewer even if the link's URL does not match the usual pattern of PGN chess games URLs; hence the link will not be opened automatically in the chess games viewer; to open the link, copy the link's URL and manually enter the URL using the page context menu.");
    return;
  }
  openRemoteUrl(remoteUrl, live, all);
}

function pgnPageOnClick(info, tab, live, all) {
  var remoteUrl = prompt("Enter PGN chess games URL for viewing" + (all ? " on multiple boards" : " on a single board") + (live ? " with live refresh" : "") + ((info.selectionText && (!validateUrl(info.selectionText, live))) ? "; the supplied URL does not match the usual PGN URL pattern:" : ":"), info.selectionText ? info.selectionText : "");
  if (!remoteUrl) { return; }

  openRemoteUrl(remoteUrl, live, all);
}

function pgnviewLinkOnClick(info, tab) {
  pgnLinkOnClick(info, tab, false);
}

function pgnviewDataUriOnClick(info, tab) {
  openPgnDataUri(info.linkUrl);
}

function pgnliveLinkOnClick(info, tab) {
  pgnLinkOnClick(info, tab, true, false);
}

function pgnliveallLinkOnClick(info, tab) {
  pgnLinkOnClick(info, tab, true, true);
}

function pgnviewPageOnClick(info, tab) {
  pgnPageOnClick(info, tab, false);
}

function pgnlivePageOnClick(info, tab) {
  pgnPageOnClick(info, tab, true, false);
}

function pgnliveallPageOnClick(info, tab) {
  pgnPageOnClick(info, tab, true, true);
}

function openlocalpgnOnClick(info, tab) {
  chrome.tabs.create({url: "chess-games-viewer.html"});
}

var pgnText = new Array();
var pgnTextIndexFromTabId = new Array();
pgnTextIndex = 0;
function pgntextOnClick(info, tab) {
  var needsValidation;
  if (info.selectionText) {
    needsValidation = true;
    pgnText[pgnTextIndex] = info.selectionText;
  } else {
    needsValidation = false;
    pgnText[pgnTextIndex] = prompt("Enter PGN chess games TEXT for viewing on a single board; pasting multi-line PGN data in the textbox is allowed:");
    if (!pgnText[pgnTextIndex]) {
      delete pgnText[pgnTextIndex];
      return;
    }
  }
  if (pgnText[pgnTextIndex].match(/^([\r\n\s]*([1-8rnbkpqRNBKPQ]{1,8}\/){7}[1-8rnbkpqRNBKPQ]{1,8}(\s+[wb]\s+([A-Ha-hKQkq]{1,4}|-)\s+([a-h][36]|-)\s+[\d]+\s+[\d]+){0,1})+[\r\n\s]*$/)) {
    pgnText[pgnTextIndex] = pgnText[pgnTextIndex].replace(/(([1-8rnbkpqRNBKPQ]{1,8}\/){7}[1-8rnbkpqRNBKPQ]{1,8}(\s+[wb]\s+([A-Ha-hKQkq]{1,4}|-)\s+([a-h][36]|-)\s+[\d]+\s+[\d]+){0,1})/g, '[FEN "$1"]\n*\n');
  }
  pgnText[pgnTextIndex] = pgnText[pgnTextIndex].replace(pgnHeaderRegExpGlobal, "\n$1\n"); // add newline after header section
  pgnText[pgnTextIndex] = fixCommonPgnMistakes(pgnText[pgnTextIndex]);

  if (needsValidation && (!validatePgnText(pgnText[pgnTextIndex]))) {
    delete pgnText[pgnTextIndex];
    alert("warning: the supplied text does not match the usual PGN text pattern; copy the text and use the chess games viewer page menu to manually enter the amended PGN text.");
    return;
  }

  url = "chess-games-viewer.html?pgnBackground=" + pgnTextIndex++;
  chrome.tabs.create({url: url});
}

function removePgnTextOnRemoved(tabId) {
  if ((pgnTextIndexFromTabId[tabId] !== null) && (pgnTextIndexFromTabId[tabId] !== undefined)) {
    var thisPgnTextIndex = pgnTextIndexFromTabId[tabId];
    delete pgnTextIndexFromTabId[tabId];
    if (pgnTextIndexFromTabId.indexOf(thisPgnTextIndex) == -1) {
      delete pgnText[thisPgnTextIndex];
    }
  }
}

chrome.tabs.onRemoved.addListener(removePgnTextOnRemoved);

var pgnDataUriRegExp = /^\s*data:application\/(da|x)-chess-pgn([^,]*),(.*)\s*$/;
var pgnDataUriB64RegExp = /^\s*data:application\/(da|x)-chess-pgn([^,]*),([0-9a-zA-Z+\/=]*)\s*$/;
function openPgnDataUri(pgnDataUri) {
  var pgnDataUriMatch;
  pgnDataUri = pgnDataUri.replace(/,pgn4web_download=.*$/, "");
  if (pgnDataUriMatch = pgnDataUri.match(pgnDataUriRegExp)) {
    if (pgnDataUriMatch[2] && pgnDataUriMatch[2].match(/;base64/)) {
      if (pgnDataUri.match(pgnDataUriB64RegExp)) {
        pgnText[pgnTextIndex] = Base64.decode(pgnDataUriMatch[3]);
      } else {
        alert("error: invalid PGN data base64 URI");
        return false;
      }
    } else {
      pgnText[pgnTextIndex] = decodeURIComponent(pgnDataUriMatch[3]);
    }
    url = "chess-games-viewer.html?pgnBackground=" + pgnTextIndex++;
    chrome.tabs.create({url: url});
  } else {
    alert("error: invalid PGN data URI");
    return false;
  }
  return true;
}

function openDataPgnUriIndex(tabId, dataPgnUriIndex) {
  if (pgnHrefLinks && pgnHrefLinks[tabId] && pgnHrefLinks[tabId][dataPgnUriIndex]) {
    openPgnDataUri(pgnHrefLinks[tabId][dataPgnUriIndex]);
  }
}

function showAboutPage(section, tabIdForReuse) {
  if ((typeof(section) == "undefined") || !section) { section = "help"; }
  extviewForReuse = null;
  extviews = chrome.extension.getViews({"type": "tab"});
  for (ee in extviews) {
    if (extviews[ee].location.href.indexOf(chrome.extension.getURL("about.html")) === 0) {
      if (extviewForReuse) {
        extviews[ee].chrome.tabs.getCurrent(function(tab) { chrome.tabs.remove(tab.id); });
      } else {
        extviewForReuse = extviews[ee];
      }
    }
  }
  if (extviewForReuse) {
    extviewForReuse.showSection(section);
    extviewForReuse.document.body.scrollTop = 0;
    extviewForReuse.chrome.tabs.getCurrent(function(tab) { chrome.tabs.update(tab.id, {"selected": true}); });
    if (typeof(tabIdForReuse) != "undefined") { chrome.tabs.remove(tabIdForReuse); }
  } else {
    if (typeof(tabIdForReuse) != "undefined") {
      chrome.tabs.update(tabIdForReuse, {"url": "about.html?" + section, "selected": true});
    } else {
      chrome.tabs.create({"url": "about.html?" + section, "selected": true});
    }
  }
}

function helpAboutChessGamesViewer(info, tab) {
  showAboutPage();
}

// "page" and "selection" context menu to open PGN text

chrome.contextMenus.create({"title": "Enter PGN chess games TEXT for viewing on a single board", "contexts": ["page"], "onclick": pgntextOnClick});

chrome.contextMenus.create({"title": "View selected TEXT as PGN chess games on a single board", "contexts": ["selection"], "onclick": pgntextOnClick});

chrome.contextMenus.create({"type": "separator", "contexts": ["page", "selection"]});

// "page" context menu to open local PGN files

chrome.contextMenus.create({"title": "Open local PGN chess games FILES for viewing on a single board", "contexts": ["page"], "onclick": openlocalpgnOnClick});

chrome.contextMenus.create({"type": "separator", "contexts": ["page"]});

// "page" and "selection" context menu to enter PGN chess games URL for opening

chrome.contextMenus.create({"title": "Enter PGN chess games URL for viewing on a single board", "contexts": ["page", "selection"], "onclick": pgnviewPageOnClick});

chrome.contextMenus.create({"title": "Enter PGN chess games URL for viewing on a single board with live refresh", "contexts": ["page", "selection"], "onclick": pgnlivePageOnClick});

chrome.contextMenus.create({"title": "Enter PGN chess games URL for viewing on multiple boards with live refresh", "contexts": ["page", "selection"], "onclick": pgnliveallPageOnClick});

chrome.contextMenus.create({"type": "separator", "contexts": ["page", "selection"]});

// "link" context menu to open remote PGN chess games URLs

// which URL patters should be considered as PGN chess games
pgnUrlPatterns = ["*://*/*.pgn", "*://*/*.PGN", "*://*/*.Pgn", "*://*/*.pgn?*", "*://*/*.PGN?*", "*://*/*.Pgn?*", chrome.extension.getURL("*.pgn"), chrome.extension.getURL("*.pgn?*")];
zipUrlPatterns = ["*://*/*.zip", "*://*/*.ZIP", "*://*/*.Zip", "*://*/*.zip?*", "*://*/*.ZIP?*", "*://*/*.Zip?*", chrome.extension.getURL("*.zip")];
pgnZipUrlPatterns = pgnUrlPatterns.concat(zipUrlPatterns);
pgnDataUriPatterns = ["data:application/da-chess-pgn*", "data:application/x-chess-pgn*"];
pgnAllUrlPatterns = pgnZipUrlPatterns.concat(pgnDataUriPatterns);

chrome.contextMenus.create({"title": "View chess games link on a single board", "contexts": ["link"], targetUrlPatterns: pgnUrlPatterns, "onclick": pgnviewLinkOnClick});

chrome.contextMenus.create({"title": "View chess games link on a single board", "contexts": ["link"], targetUrlPatterns: pgnDataUriPatterns, "onclick": pgnviewDataUriOnClick});

chrome.contextMenus.create({"title": "View chess games link on a single board with live refresh", "contexts": ["link"], targetUrlPatterns: pgnUrlPatterns, "onclick": pgnliveLinkOnClick});

chrome.contextMenus.create({"title": "View chess games link on multiple boards with live refresh", "contexts": ["link"], targetUrlPatterns: pgnUrlPatterns, "onclick": pgnliveallLinkOnClick});

chrome.contextMenus.create({"title": "Inspect ZIP archive link for PGN chess games", "contexts": ["link"],  targetUrlPatterns: zipUrlPatterns, "onclick": pgnviewLinkOnClick});

chrome.contextMenus.create({"type": "separator", "contexts": ["link"], targetUrlPatterns: pgnAllUrlPatterns});

// "link", "page" and "selection" help menus

chrome.contextMenus.create({"title": "Help about the chess games viewer", "contexts": ["link", "page", "selection"], targetUrlPatterns: pgnAllUrlPatterns, "onclick": helpAboutChessGamesViewer});

// end of context menus entries

var pgnHrefLinks = new Array();
var pgnWebRequests = new Array();
var processedUrls = new Array();

function mergePgnLinksAndShowIcon(tabId) {
  if (! pgnHrefLinks[tabId]) { return; }
  if (! pgnWebRequests[tabId]) { return; }
  pgnHrefLinks[tabId] = pgnHrefLinks[tabId].sort();
  for (r in pgnWebRequests[tabId]) {
    for (l in pgnHrefLinks[tabId]) {
      if (pgnHrefLinks[tabId][l].match(pgnWebRequests[tabId][r].replace(/(\?|#).*$/, ""))) {
        delete pgnWebRequests[tabId][r];
        break;
      }
    }
  }
  pgnWebRequests[tabId] = pgnWebRequests[tabId].filter(function(element, index, array) { return ((element !== null) && (element !== undefined)); }).sort();
  pgnLinksTitle = (pgnHrefLinks[tabId].length + pgnWebRequests[tabId].length) + " chess games " + ((pgnHrefLinks[tabId].length + pgnWebRequests[tabId].length) == 1 ? "link" : "links") + " on this page";
  chrome.pageAction.setTitle({tabId:tabId, title:pgnLinksTitle});
  chrome.pageAction.show(tabId);
}

function pgnHrefLinksRequest(request, sender, sendResponse) {
  if (typeof(request.pgnHrefLinks) != "undefined") {
    if (pgnHrefLinks[sender.tab.id]) {
      for(l in request.pgnHrefLinks) {
        if (pgnHrefLinks[sender.tab.id].indexOf(request.pgnHrefLinks[l]) == -1) {
          pgnHrefLinks[sender.tab.id].push(request.pgnHrefLinks[l]);
        }
      }
    } else {
      pgnHrefLinks[sender.tab.id] = request.pgnHrefLinks;
      pgnWebRequests[sender.tab.id] = new Array();
    }
    mergePgnLinksAndShowIcon(sender.tab.id);
    sendResponse({});
  }
}

chrome.extension.onRequest.addListener(pgnHrefLinksRequest);

function removePgnLinksOnRemoved(tabId) {
  if (pgnHrefLinks[tabId]) { delete pgnHrefLinks[tabId]; }
  if (pgnWebRequests[tabId]) { delete pgnWebRequests[tabId]; }
  if (processedUrls[tabId]) { delete processedUrls[tabId]; }
}

chrome.tabs.onRemoved.addListener(removePgnLinksOnRemoved);

function removePgnLinksOnUpdated(tabId, changeInfo, tab) {
  if (changeInfo.status == "loading") {
    if (changeInfo.url) {
      changeInfoUrlWithoutHash = changeInfo.url.replace(/#.*$/, "");
      if ((processedUrls[tabId]) && (processedUrls[tabId] !== changeInfoUrlWithoutHash)) {
        if (pgnHrefLinks[tabId]) { delete pgnHrefLinks[tabId]; }
        if (pgnWebRequests[tabId]) { delete pgnWebRequests[tabId]; }
      }
      processedUrls[tabId] = changeInfoUrlWithoutHash;
    } else {
      mergePgnLinksAndShowIcon(tabId); // this seems to fix an obscure issue with clicking twice on a hash link
    }
  }
}

chrome.tabs.onUpdated.addListener(removePgnLinksOnUpdated);

var localPgnFilesIndex = 0;
var localPgnFiles = new Array();
var localPgnFilesIndexFromTabId = new Array();

function loadLocalPgnFiles(id, details) {
  if ((id == "view") || (id == "inspect")) {
    localPgnFiles[localPgnFilesIndex] = details.entries;
    url = "chess-games-viewer.html?pgnLocalfilesindex=" + localPgnFilesIndex++;
    chrome.tabs.create({url: url});
  }
}

chrome.fileBrowserHandler.onExecute.addListener(loadLocalPgnFiles);

function removeLocalPgnFilesOnRemoved(tabId) {
  if ((localPgnFilesIndexFromTabId[tabId] !== null) && (localPgnFilesIndexFromTabId[tabId] !== undefined)) {
    if ((localPgnFiles[localPgnFilesIndexFromTabId[tabId]] !== null) && (localPgnFiles[localPgnFilesIndexFromTabId[tabId]] !== undefined)) {
      delete localPgnFiles[localPgnFilesIndexFromTabId[tabId]];
    }
    delete localPgnFilesIndexFromTabId[tabId];
  }
}

chrome.tabs.onRemoved.addListener(removeLocalPgnFilesOnRemoved);

function checkWebRequestForPgnFiles(requestDetails) {
  if (requestDetails.tabId === null) { return; }
  if (!validatePgnUrl(requestDetails.url)) { return; }

  if (pgnWebRequests[requestDetails.tabId]) {
    for (r in pgnWebRequests[requestDetails.tabId]) {
      if (pgnWebRequests[requestDetails.tabId][r].match(requestDetails.url.replace(/(\?|#).*$/, ""))) {
        return;
      }
    }
  } else {
    pgnHrefLinks[requestDetails.tabId] = new Array();
    pgnWebRequests[requestDetails.tabId] = new Array();
  }
  pgnWebRequests[requestDetails.tabId].push(requestDetails.url.replace(/\?noCache=[0-9A-F]{10}$/, ""));
  mergePgnLinksAndShowIcon(requestDetails.tabId);
}

// enables the webRequest API, within a try statement for backward compatibility with chrome before version 17
// see README.txt note about http://crbug.com/60101
try {
  chrome.webRequest.onBeforeRequest.addListener(checkWebRequestForPgnFiles, {"types": ["object", "xmlhttprequest", "other"], "urls": pgnUrlPatterns});
} catch (e) {}

</script>

</head>

<body>

</body>

</html>
