<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2010 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<head>

<script type="text/javascript">

var debugInfo = "the top left chessboard square will flash in case of PGN data errors, click that square for further details";

function openRemoteUrl(remoteUrl, live) {
  if (!remoteUrl) { return; }
  var liveParam = live ? '&refreshMinutes=1.0' + Math.floor(Math.random()*10) + '&search=\\[\\s*Result\\s*"\\*"\\s*\\]' : "";
  url = "chess-games-viewer.html?pgnData=" + remoteUrl + liveParam;
  chrome.tabs.create({url: url});
}

function pgnLinkOnClick(info, tab, live) {
  var remoteUrl = info.linkUrl;
  if (!remoteUrl) { return; }
  if (!remoteUrl.match(/\.pgn$/i)) { return; }
  openRemoteUrl(remoteUrl, live);
}

function pgnPageOnClick(info, tab, live) {
  var promptLabel = "Enter PGN chess games URL for viewing" + (live ? " with live refresh" : "") + " (" + debugInfo + "):";
  var defaultRemoteUrl = info.selectionText ? info.selectionText.replace(/[\n\r]+/g," ") : "";
  var remoteUrl = prompt(promptLabel, defaultRemoteUrl);
  if (!remoteUrl) { return; }
  //
  // allowing any URL when manually eneterd (to cope with some sites using .txt files or using scripts like php
  //
  // if (!remoteUrl.match(/\.pgn$/i)) {
  //  alert("You entered:\n" + remoteUrl + "\n\nError: only PGN chess games URL allowed.");
  //  return;
  // }
  openRemoteUrl(remoteUrl, live);
}

function pgnviewLinkOnClick(info, tab) {
  pgnLinkOnClick(info, tab, false);
}

function pgnliveLinkOnClick(info, tab) {
  pgnLinkOnClick(info, tab, true);
}

function pgnviewPageOnClick(info, tab) {
  pgnPageOnClick(info, tab, false);
}

function pgnlivePageOnClick(info, tab) {
  pgnPageOnClick(info, tab, true);
}

var pgnText = new Array();
pgnTextIndex = 0;
function pgntextOnClick(info, tab) {
  pgnText[pgnTextIndex] = info.selectionText;
  if (!pgnText[pgnTextIndex]) { 
    pgnText[pgnTextIndex] = prompt("Enter PGN chess games TEXT for viewing (pasting multi-line PGN data in the textbox is ok; " + debugInfo + "):");
    var pgnHeaderRegExpGlobal = /((\[\s*(\w+)\s*"([^"]*)"\s*\]\s*)+)/g;
    pgnText[pgnTextIndex] = pgnText[pgnTextIndex].replace(pgnHeaderRegExpGlobal, "\n$1\n");
  }
  if (!pgnText[pgnTextIndex]) { return; }
  url = "chess-games-viewer.html?pgnBackground=" + pgnTextIndex++;
  chrome.tabs.create({url: url});
}

function aboutChessGamesViewer(info, tab) {
  var aboutText = "Chess games viewer extension for Google Chrome: interactive chessboard showing chess games from PGN URLs and from PGN text, using context menus and page actions.";
  aboutText += "\n\nA context menu shows chess games from *.PGN chess games URLs; PGN (Portable Games Notation) files are commonly used to store and share chess games information. The live refresh option reloads the games periodically until all games are ended; use for links to chess games live broadcasts. The mouse cursor icon highlights *.PGN chess games URLs when hovering on them.";
  aboutText += "\n\nA context menu shows chess games from PGN chess games text selecetd in the web page.";
  aboutText += "\n\nA page action looks for PGN chess games URLs in the current page; if found, a page action icon in the address bar provides links for opening the PGN chess games URLs in the chess games viewer.";
  aboutText += "\n\nClick on the viewer's chessboard top right square for user interface help, credits and license; " + debugInfo + ".";
  aboutText += "\n\n\nClick OK to visit the pgn4web homepage and wiki for more info.";
  if (confirm(aboutText)) { chrome.tabs.create({url: "http://pgn4web.casaschi.net"}); }
}

chrome.contextMenus.create({"title": "View chess games link", "contexts": ["link"], targetUrlPatterns:["*://*/*.pgn", "*://*/*.PGN", "*://*/*.Pgn"], "onclick": pgnviewLinkOnClick});

chrome.contextMenus.create({"title": "View chess games link with live refresh", "contexts": ["link"], targetUrlPatterns:["*://*/*.pgn", "*://*/*.PGN", "*://*/*.Pgn"], "onclick": pgnliveLinkOnClick});

chrome.contextMenus.create({"title": "Enter PGN chess games TEXT for viewing", "contexts": ["page"], "onclick": pgntextOnClick});

chrome.contextMenus.create({"title": "View selected TEXT as PGN chess games", "contexts": ["selection"], "onclick": pgntextOnClick});

chrome.contextMenus.create({"type": "separator", "contexts": ["page", "selection"]});

chrome.contextMenus.create({"title": "Enter PGN chess games URL for viewing", "contexts": ["page", "selection"], "onclick": pgnviewPageOnClick});

chrome.contextMenus.create({"title": "Enter PGN chess games URL for viewing with live refresh", "contexts": ["page", "selection"], "onclick": pgnlivePageOnClick});

chrome.contextMenus.create({"type": "separator", "contexts": ["link"], targetUrlPatterns:["*://*/*.pgn", "*://*/*.PGN", "*://*/*.Pgn"]});

chrome.contextMenus.create({"title": "About the chess games viewer extension", "contexts": ["link"], targetUrlPatterns:["*://*/*.pgn", "*://*/*.PGN", "*://*/*.Pgn"], "onclick": aboutChessGamesViewer});

// can NOT add separator/about items to the selection context
// otherwise they would appear twice when selecting a text and
// pointing to a link at the same time

chrome.contextMenus.create({"type": "separator", "contexts": ["page"]});

chrome.contextMenus.create({"title": "About the chess games viewer extension", "contexts": ["page"], "onclick": aboutChessGamesViewer});

var pgnLinks = new Array();
function pgnLinksPopupRequest(request, sender, sendResponse) {
  if ((pgnLinks[sender.tab.id]) && (pgnLinks[sender.tab.id] !== undefined)) {
    pgnLinks[sender.tab.id] = pgnLinks[sender.tab.id].concat(request.pgnLinks);
  } else {
    pgnLinks[sender.tab.id] = request.pgnLinks;
  }
  pgnLinksTitle = pgnLinks[sender.tab.id].length + " chess games PGN link" + (pgnLinks[sender.tab.id].length == 1 ? "" : "s") + " on this page";
  chrome.pageAction.setTitle({tabId:sender.tab.id, title:pgnLinksTitle});
  chrome.pageAction.show(sender.tab.id);
  sendResponse({});
}

chrome.extension.onRequest.addListener(pgnLinksPopupRequest);

function removePgnLinksOnRemoved(tabId) {
  if (pgnLinks[tabId]) { delete pgnLinks[tabId]; }
}

chrome.tabs.onRemoved.addListener(removePgnLinksOnRemoved);

function removePgnLinksOnUpdated(tabId, changeInfo, tab) {
  if ((changeInfo.status == "loading") && (pgnLinks[tabId])) { delete pgnLinks[tabId]; }
}

chrome.tabs.onUpdated.addListener(removePgnLinksOnUpdated);

</script>

</head>

</html>
