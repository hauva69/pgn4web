<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2011 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<head>

<title>pgn4web chess live broadcast</title>

<link rel="shortcut icon" href="pawn.ico" />

<script src="pgn4web-server-config.js" type="text/javascript"></script>

<script src="pgn4web.js" type="text/javascript"></script>

<script type="text/javascript">

  var pgnData_default = "live/live.pgn";
  var maxBoards_default = 8;
  var firstGame_default = 1;
  var refreshMinutes_default = 1;

  var thisRegExp = /(&|\?)(help|h)(&|$)/i;
  if (window.location.search.match(thisRegExp) !== null) {
    alert("pgn4web live-mosaic-viewer.html parameters" + "\n\n" + 
      " - pgnData = file.pgn" + "\n\n" +
      " - maxBoards = max number of boards to display in a page (default " + maxBoards_default +  ")" + "\n\n" +
      " - firstGame = number of first game to show, negative counts backwards (default " + firstGame_default + ")" + "\n\n" +
      " - refreshMinutes = live broadcast delay (default " + refreshMinutes_default + ")" + "\n\n" +
      " - refreshDemo = if set true sets live demo mode (default false)" + "\n\n" +
      " - headlessPage = if set true displays a page without heading (default false)" + "\n\n" +
      " - help");
  }

  var pgnData = pgnData_default;
  // accepts pgnData as alias for pgnFile for consistency with board.html
  thisRegExp = /(&|\?)(pgnData|pd)=([^&]*)(&|$)/i;
  if (! thisRegExp) { thisRegExp = /(&|\?)(pgnFile|pf)=([^&]*)(&|$)/i; }
  if (window.location.search.match(thisRegExp) !== null) {
     pgnData = unescape(window.location.search.match(thisRegExp)[3]);
  } 
  if (pgnData) {
     SetPgnUrl(pgnData); // if set, this has precedence over the inline PGN in the HTML file
  }

  var maxBoards = parseInt(getMaxBoardFromLocalStorage(), 10);
  if (! maxBoards) { maxBoards = maxBoards_default; }
  thisRegExp = /(&|\?)(maxBoards|mb)=([\d]*)(&|$)/i;
  if (window.location.search.match(thisRegExp) !== null) {
    maxBoards = unescape(window.location.search.match(thisRegExp)[3]);
  }
  maxBoards = parseInt(maxBoards, 10);
  setMaxBoardToLocalStorage();

  var firstGame = firstGame_default;
  thisRegExp = /(&|\?)(firstGame|fg)=((\+|-|)[\d]*)(&|$)/i;
  if (window.location.search.match(thisRegExp) !== null) {
    firstGame = unescape(window.location.search.match(thisRegExp)[3]);
  }
  firstGame = parseInt(firstGame, 10);
  if (firstGame > 0) { firstGame--; }

  var alertFlag = demoFlag = false;
  thisRegExp = /(&|\?)(refreshDemo|rd)=([^&]*)(&|$)/i;
  if (window.location.search.match(thisRegExp) !== null) {
    refreshDemo = unescape(window.location.search.match(thisRegExp)[3]);
    if ((refreshDemo == "true") || (refreshDemo == "t")) { alertFlag = demoFlag = true; }
  }
 
  var refreshMinutes = refreshMinutes_default;
  var stepFlag = true;
  thisRegExp = /(&|\?)(refreshMinutes|rm)=([\d.]*)(&|$)/i;
  if (window.location.search.match(thisRegExp) !== null) {
    refreshMinutes = unescape(window.location.search.match(thisRegExp)[3]);
  }
  SetLiveBroadcast(refreshMinutes, alertFlag, demoFlag, stepFlag); // set live broadcast; parameters are delay (refresh delay in minutes, 0 means no broadcast, default 0) alertFlag (if true, displays debug error messages, default false) demoFlag (if true starts broadcast demo mode, default false) stepFlag (if true, autoplays updates in steps, default false)

  function getMaxBoardFromLocalStorage() {
    if (typeof(localStorage) == "undefined") { return 0; }
    try { mb = localStorage.getItem("pgn4web_chess_live_mosaic_viewer_maxBoards"); }
    catch (e) { return 0; }
    return mb;
  }

  function setMaxBoardToLocalStorage() {
    if (typeof(localStorage) == "undefined") { return false; }
    try { localStorage.setItem("pgn4web_chess_live_mosaic_viewer_maxBoards", maxBoards); }
    catch (e) { return false; }
    return true;
  }

  var headlessPage = false;
  thisRegExp = /(&|\?)(headlessPage|hp)=([^&]*)(&|$)/i;
  if (window.location.search.match(thisRegExp) !== null) {
    headlessPageValue = unescape(window.location.search.match(thisRegExp)[3]);
    if ((headlessPageValue == "true") || (headlessPageValue == "t")) { headlessPage = true; }
  }

</script>


<style type="text/css">

@import url("fonts/pgn4web-font-LiberationSans.css");

body {
  color: black;
  background: white;
  font-family: sans-serif;
  padding-top: 20px;
  padding-bottom: 20px;
  padding-left: 20px;
  padding-right: 20px;
}

a:link, a:visited, a:active {
  color: black;
  text-decoration: none;
}

a:hover {
  color: red;
  text-decoration: none;
}

.header,
.header:link,
.header:visited,
.header:hover,
.header:active {
  color: red;
  text-decoration: none;
}

.beforeBoards {
  display: inline-block;
  margin-top: 5px;
  height: 20px;
  width: 100%;
  overflow: hidden;
}

.afterBoards {
  display: inline-block;
  height: 40px;
  width: 100%;
  overflow: hidden;
}

.menuLine {
  font-size: 12px;
  font-family: 'pgn4web Liberation Sans', sans-serif;
  line-height: 20px;
}

.menuLink {
  display: inline-block;
  width: 2em;
}

.commandLink {
}

.hiddenFrame,
.visibleFrame {
  width: 256px;
  height: 306px;
  margin-left: 20px;
  margin-right: 20px;
  margin-top: 15px;
  margin-bottom: 5px;
}

.hiddenFrame {
  display: none;
  visibility: hidden;
}

.visibleFrame {
  display: inline;
  visibility: visible;
}

.infoMessage {
  color: black;
  font-weight: bold;
  text-align: center;
}

</style>

</head>

<body id="body">

<script type="text/javascript">

function fixCSSforHeadelessPage() {
  document.write("<style type='text/css'> body { color: #AAAAAA; background: -webkit-gradient(linear, left top, left bottom, from(#FFFFFF), to(#F0F0F0)); /* chrome 9- */ background: -webkit-linear-gradient(#FFFFFF, #F0F0F0); /* chrome 10+ */ } a:link, a:visited, a:active { color: #AAAAAA; } a:hover { color: black; } .commandLink:hover { background: #FFCC99; box-shadow: 0px 0px 17px #FF8000; -webkit-box-shadow: 0px 0px 17px #FF8000; -moz-box-shadow: 0px 0px 17px #FF8000; } .beforeBoards { margin-top: 10px; } </style>");
}

function printHeader() {
  document.write("<table border='0' cellpadding='0' cellspacing='0' width='100%'><tbody><tr><td align='left' valign='middle'><h1 class='header' name='top'>pgn4web <a class='header' href='#boards' onfocus='this.blur();'>chess live broadcast</a></h1></td><td align='right' valign='middle'><img src='pawns.png' border='0'></td></tr></tbody></table></div>"); 
}

function printMenu() {
  document.write("<div id='rightMenu' class='menuLine' style='text-align:right; float:right;'></div><div id='leftMenu' class='menuLine' style='text-align:left; float:left;'><a id='GameLiveStatus' href='javascript:void(0);' style='display:none;' onclick='displayDebugInfo();' title='live broadcast status'></a></div><div id='infoMessage' class='menuLine infoMessage'>chess games viewer: loading PGN data, please wait...</div>");
}

if (headlessPage) {
  fixCSSforHeadelessPage();
  printMenu();
} else {
  printHeader();
}

document.write("<center><a class='beforeBoards' name='boards' href='#boards' onfocus='this.blur();'>&nbsp</a>");

for (board = 0; board < maxBoards; board++) {
  document.write("<iframe name='board" + board + "' id='board" + board + "' class='hiddenFrame' width='256' height='306' frameborder='0' scrolling='no' marginheight='0' marginwidth='0' src='live-mosaic-tile.html?ut=t&rm=" + refreshMinutes + "'>your web browser and/or your host do not support iframes as required to display the chessboard</iframe>");
}

</script>


<!-- chat box code here -->

<!-- end of chat box code -->


<script type="text/javascript">

document.write("</center><a class='afterBoards' name='bottom'>&nbsp</a>");

if (!headlessPage) {
  printMenu();
}


var pgn4webClearShortCutSquaresForChildFrames =  [ ["DH", "8"], ["H", "7"], ["ABH", "6"] ];

var filteredGames = new Array();
var numberOfGamesForDisplay = numberOfGames;

function filterEndedGames(gamesList) {
  var localFilteredGames = new Array();
  for (g in gamesList) {
    if ((typeof(gameResult[gamesList[g]]) == "undefined") || (gameResult[gamesList[g]] != "*")) { 
      localFilteredGames.push(gamesList[g]);
    }
  }
  return localFilteredGames;
}

function hideEndedGames() {
  n = new Array();
  for (g = 0; g < numberOfGames; g++) { n.push(g); }
  filteredGames = filterEndedGames(n);
  customFunctionOnPgnTextLoad();
}

function restoreEndedGames() {
  filteredGames = new Array();
  customFunctionOnPgnTextLoad();
}

function pgnGameForBoard(gameNum) {
  if (!LiveBroadcastDemo) { return pgnGame[gameNum]; }

  if (gameDemoMaxPly[gameNum] > gameDemoLength[gameNum]) { return pgnGame[gameNum]; } 

  Init(gameNum);

  localPgnGame = "";
  if (gameEvent[gameNum]) { localPgnGame += "[Event \"" + gameEvent[gameNum] + "\"]\n"; }
  if (gameSite[gameNum]) { localPgnGame += "[Site \"" + gameSite[gameNum] + "\"]\n"; }
  if (gameDate[gameNum]) { localPgnGame += "[Date \"" + gameDate[gameNum] + "\"]\n"; }
  if (gameRound[gameNum]) { localPgnGame += "[Round \"" + gameRound[gameNum] + "\"]\n"; }
  if (gameWhite[gameNum]) { localPgnGame += "[White \"" + gameWhite[gameNum] + "\"]\n"; }
  if (gameBlack[gameNum]) { localPgnGame += "[Black \"" + gameBlack[gameNum] + "\"]\n"; }
  if (gameResult[gameNum]) { localPgnGame += "[Result \"" + gameResult[gameNum] + "\"]\n"; }
  if (gameFEN[gameNum]) { localPgnGame += "[FEN \"" + gameFEN[gameNum] + "\"]\n"; }
  if (gameSetUp[gameNum]) { localPgnGame += "[SetUp \"" + gameSetUp[gameNum] + "\"]\n"; }
  if (gameVariant[gameNum]) { localPgnGame += "[Variant \"" + gameVariant[gameNum] + "\"]\n"; }
  if (gameInitialWhiteClock[gameNum]) { localPgnGame += "[WhiteClock \"" + gameInitialWhiteClock[gameNum] + "\"]\n"; }
  if (gameInitialBlackClock[gameNum]) { localPgnGame += "[BlackClock \"" + gameInitialBlackClock[gameNum] + "\"]\n"; }
  if (thisTag = customPgnHeaderTag("Clock")) { localPgnGame += "[Clock \"" + thisTag + "\"]\n"; }
  if (thisTag = customPgnHeaderTag("TimeControl")) { localPgnGame += "[TimeControl \"" + thisTag + "\"]\n"; }
  localPgnGame += "\n";

  for (thisPly = StartPly; thisPly <= gameDemoMaxPly[gameNum]; thisPly++) {
    if (thisPly % 2) {
      if (thisComment = MoveComments[thisPly].replace(/{/g, "")) { 
        localPgnGame += "{" + thisComment + "} " + ((thisPly+1)/2) + "... ";
      }
      localPgnGame += Moves[thisPly] + " \n";
    } else {
      if (thisComment = MoveComments[thisPly].replace(/{/g, "")) { localPgnGame += "{" + thisComment + "} "; }
      localPgnGame += (thisPly/2+1) + ". " + Moves[thisPly] + " ";
    }
  }
  if (thisComment = MoveComments[thisPly].replace(/{/g, "")) { localPgnGame += "{" + thisComment + "} "; }
  localPgnGame += " *";

  return localPgnGame;
}

var firstLoadPgnText = true;

function customFunctionOnPgnTextLoad() {

  /* make sure what was previously filtered still it should be (think new PGN or transmission errors) */
  filteredGames = filterEndedGames(filteredGames);

  unfilteredGames = new Array();
  gamesForHiding = 0;
  for (g = 0; g < numberOfGames; g++) {
    found_g = false;
    for (f in filteredGames) { if (found_g = (filteredGames[f] == g)) { break; } }
    if (! found_g) {
      unfilteredGames.push(g);
      if ((typeof(gameResult[g]) == "undefined") || (gameResult[g].indexOf("*") == -1)) { gamesForHiding++; }
    }
  }
  numberOfGamesForDisplay = unfilteredGames.length;
  if (numberOfGamesForDisplay < 1) { 
    /* this should never happen, so we show all games */
    for (g = 0; g < numberOfGames; g++) { unfilteredGames.push(g); }
    numberOfGamesForDisplay = unfilteredGames.length;
  }

  numBoards = Math.min(numberOfGamesForDisplay, maxBoards);

  startGame = startFromFirstGame(firstGame, numberOfGamesForDisplay);
  for (board = 0; board < maxBoards; board++) {
    if (startGame >= 0) { gameForBoard = (startGame + board) % numberOfGamesForDisplay; }
    else { gameForBoard = (2 * numberOfGamesForDisplay + startGame - board) % numberOfGamesForDisplay; }
    if (thisFrame = document.getElementById("board" + board)) {
      if (board < numberOfGamesForDisplay) {
        thisPgnGame = pgnGameForBoard(unfilteredGames[gameForBoard]);
        thisFrame.className = "visibleFrame";
        try {  
          window.frames["board" + board].pauseLiveBroadcast();
          window.frames["board" + board].document.getElementById("pgnText").value = thisPgnGame;
          window.frames["board" + board].refreshPgnSource();
          window.frames["board" + board].clearShortcutSquares("A","8");
        } catch(e) { myAlert("error: failed accessing iframe for board #" + board, true); }
      } else {
        thisFrame.className = "hiddenFrame";
      }
    }
  }

  if (theObject = document.getElementById("GameLiveStatus")) {
    theObject.title = "live broadcast status";
    if (alertNumSinceReset) { 
      theObject.title += ": " + alertNumSinceReset + " new alert" + (alertNumSinceReset > 1 ? "s" : "");
    }
    if (firstLoadPgnText) {
      theObject.style.display = "inline";
      firstLoadPgnText = false;
    } else {
      document.title = LiveBroadcastStatusString.replace(" &nbsp;", ",");
    }
  }

  if (theRightObject = document.getElementById("rightMenu")) {
    theRightObject.innerHTML = "";

    if (headlessPage) {  theRightObject.innerHTML += "<span class='menuLink' style='width:auto;'><a class='commandLink' href='" + pgnData + "' title='Download chess games PGN source: " + pgnData + "' onfocus='this.blur();'>&nbsp;d&nbsp;</a></span>"; }

    if (numberOfGamesForDisplay > maxBoards) { theRightObject.innerHTML += "<span class='menuLink'><a class='commandLink' href='javascript:void(0);' onclick='previousPage();' title='more games available: show the Earlier set of games' onfocus='this.blur();'>&nbsp;e&nbsp;</a></span><span class='menuLink'><a class='commandLink' href='javascript:void(0);' onclick='nextPage();' title='more games available: show the Next set of games' onfocus='this.blur();'>&nbsp;n&nbsp;</a></span>"; }

    if (maxBoards > 1 && numberOfGamesForDisplay > 1) { theRightObject.innerHTML += "<span class='menuLink'><a class='commandLink' href='javascript:void(0);' onclick='newBoards(" + Math.min(maxBoards - 1, numberOfGamesForDisplay - 1) + ");' title='show one chessboard Less' onfocus='this.blur();'>&nbsp;l&nbsp;</a></span>"; }
    if (numberOfGamesForDisplay > maxBoards) { theRightObject.innerHTML += "<span class='menuLink'><a class='commandLink' href='javascript:void(0);' onclick='newBoards(" + (maxBoards + 1) + ");' title='show one chessboard More' onfocus='this.blur();'>&nbsp;m&nbsp;</a></span>"; }

    if (LiveBroadcastStarted && !LiveBroadcastEnded && gamesForHiding) { theRightObject.innerHTML += "<span class='menuLink'><a class='commandLink' href='javascript:void(0);' onclick='hideEndedGames();' title='Hide games finished so far' onfocus='this.blur();'>&nbsp;h&nbsp;</a></span>"; }
    if (filteredGames.length > 0) { theRightObject.innerHTML += "<span class='menuLink'><a class='commandLink' href='javascript:void(0);' onclick='restoreEndedGames();' title='Unhide the finished games previously hidden' onfocus='this.blur();'>&nbsp;u&nbsp;</a></span>"; }

    if (LiveBroadcastDelay > 0) {
      if (LiveBroadcastEnded) { theRightObject.innerHTML += "<span class='menuLink'><a class='commandLink' href='javascript:void(0);' onclick='restartLiveBroadcast();' title='Check for the start of a new live broadcast event' onfocus='this.blur();'>&nbsp;c&nbsp;</a></span>"; }
      else if (LiveBroadcastPaused && LiveBroadcastStarted) { theRightObject.innerHTML += "<span class='menuLink'><a class='commandLink' href='javascript:void(0);' onclick='restartLiveBroadcast(); customFunctionOnPgnTextLoad();' title='Restart live broadcast automatic refresh of games' onfocus='this.blur();'>&nbsp;r&nbsp;</a></span>"; }
      else if (LiveBroadcastPaused && !LiveBroadcastStarted) { theRightObject.innerHTML += "<span class='menuLink'><a class='commandLink' href='javascript:void(0);' onclick='restartLiveBroadcast(); customFunctionOnPgnTextLoad();' title='Restart polling for a new live broadcast' onfocus='this.blur();'>&nbsp;r&nbsp;</a></span>"; }
      else if (LiveBroadcastStarted) { theRightObject.innerHTML += "<span class='menuLink'><a class='commandLink' href='javascript:void(0);' onclick='pauseLiveBroadcast(); customFunctionOnPgnTextLoad();' title='Pause live broadcast automatic refresh of games' onfocus='this.blur();'>&nbsp;p&nbsp;</a></span>"; }
      else { theRightObject.innerHTML += "<span class='menuLink'><a class='commandLink' href='javascript:void(0);' onclick='pauseLiveBroadcast(); customFunctionOnPgnTextLoad();' title='Pause polling for a new live broadcast' onfocus='this.blur();'>&nbsp;p&nbsp;</a></span>"; }
      theRightObject.innerHTML += "<span class='menuLink'><a class='commandLink' class='commandLink' href='javascript:void(0);' onclick='refreshPgnSource();' title='Force games refresh' onfocus='this.blur();'>&nbsp;f&nbsp;</a></span>";
    }

    theRightObject.innerHTML += "<span class='menuLink'><a class='commandLink' href='#boards' title='scroll page to the top of the Boards section' onfocus='this.blur();'>&nbsp;b&nbsp;</a></span>";

    if (theRightObject && (theLeftObject = document.getElementById("leftMenu"))) {
      theRightObject.style.minWidth = 0;
      theLeftObject.style.minWidth = 0;
      theRightObject.style.minWidth = theLeftObject.offsetWidth;
      theLeftObject.style.minWidth = theRightObject.offsetWidth;
    }
  }
  
  if (theInfoObject = document.getElementById("infoMessage")) {
    theEvent = "";
    theSite = "";
    for (n = 0; n < numberOfGames; n++) {
      if ((theEvent !== false) && (theEvent !== gameEvent[n])) {
        if (theEvent) { theEvent = false; }
        else { theEvent = gameEvent[n]; }
      }
      if ((theSite !== false) && (theSite !== gameSite[n])) {
        if (theSite) { theSite = false; }
        else { theSite = gameSite[n]; }
      }
    }
    if (theEvent == "?") { theEvent = ""; }
    if (theSite == "?") { theSite = ""; }
    if (theEvent) { theEvent = theEvent.replace(/\s/g, "&nbsp;"); }
    if (theSite) { theSite = theSite.replace(/\s/g, "&nbsp;"); }

    if (theEvent || theSite) { 
      theInfoObject.innerHTML = "&nbsp;&nbsp;&nbsp;";
      if (theEvent) { theInfoObject.innerHTML += theEvent; }
      if (theEvent && theSite) { theInfoObject.innerHTML += "&nbsp;&nbsp;&nbsp;"; }
      if (theSite) { theInfoObject.innerHTML += theSite; }
      theInfoObject.innerHTML += "&nbsp;&nbsp;&nbsp;";
      theInfoObject.title = "event currently on display: hover the mouse below each chessboard for more details";
    } else {
      theInfoObject.innerHTML = "&nbsp;";
      theInfoObject.title = "";
    }
  }

}

function startFromFirstGame(firstGame, numberOfGamesForDisplay) {
  if (firstGame >= numberOfGamesForDisplay) { return numberOfGamesForDisplay - 1; }
  if (firstGame < -numberOfGamesForDisplay) { return 0; }
  if (firstGame < 0) { return numberOfGamesForDisplay + firstGame; }
  else { return firstGame; }
}

function nextPage() {
  firstGame = (startFromFirstGame(firstGame, numberOfGamesForDisplay) + maxBoards) % numberOfGamesForDisplay;
  firstGame -= (firstGame < 0 ? numberOfGamesForDisplay : 0); 
  customFunctionOnPgnTextLoad();
}

function previousPage() {
  firstGame = (startFromFirstGame(firstGame, numberOfGamesForDisplay) - maxBoards + numberOfGamesForDisplay) % numberOfGamesForDisplay; 
  firstGame -= (firstGame < 0 ? numberOfGamesForDisplay : 0);
  customFunctionOnPgnTextLoad();
}

function newBoards(newMaxBoards) {
  currentLocationSearch = "";
  if (pgnData !== pgnData_default) { currentLocationSearch += "&pd=" + pgnData; }
  if (refreshMinutes !== refreshMinutes_default) { currentLocationSearch += "&rm=" + refreshMinutes; }
  if (demoFlag) { currentLocationSearch += "&rd=t"; }
  currentLocationSearch += "&mb=" + newMaxBoards;
  if (firstGame !== firstGame_default) { currentLocationSearch += "&fg=" + (firstGame < 0 ? firstGame : firstGame + 1); }
  if (headlessPage) { currentLocationSearch += "&hp=t"; }
  document.location.search = currentLocationSearch.replace(/^&/, "?");
}

function underlineByTicker(text, ticker) {
  position = ticker % text.length;
  return (text.substring(0, position) +
    "<u>" +text.substring(position, position + 1) + "</u>" +
    text.substring(position + 1));
}

function customFunctionOnCheckLiveBroadcastStatus() {
  if (theObject = document.getElementById("GameLiveStatus")) {
    if (LiveBroadcastTicker > 1) {
      theObject.innerHTML =  theObject.innerHTML.replace(/live/, underlineByTicker("live", LiveBroadcastTicker-2));
    }
  }
}

function customShortcutKey_Shift_0() {
  displayPgnData(true);
}

</script>

</body>

</html>
