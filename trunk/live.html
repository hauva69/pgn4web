<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<head>

<title>pgn4web live broadcast</title>

<link href="live.css" type="text/css" rel="stylesheet"></link>

<script src="pgn4web.js" type="text/javascript"></script>
<script>

  if (gup("demo") == "true") { demoFlag = true; alertFlag = true; }
  else { demoFlag = false; alertFlag = false; }

  if ((pgnFile = gup("pgnFile")) == "") { pgnFile = "live.pgn"; }

  if ((refreshMinutes = gup("refreshMinutes")) == "") { 
    refreshMinutes = 1;
  }
  else {
    testMinutes = refreshMinutes + "";
    if ((testMinutes.match(/[^0-9\.]/)) || (refreshMinutes == 0)) {
      if (alertFlag) { 
	      alert("ERROR: refreshMinutes parameter must be a positive number.\n" +
		    "Supplied " + testMinutes + "; defaulting to 1."); 
      }
      refreshMinutes = 1;
    }
  }

  if ((iniGame = gup("initialGame")) == "") {iniGame = 1; }
  iniGameError = "ERROR: initialGame parameter must be a positive number or " +
                 "'first', 'last' or 'random'.\n" +
                 "Supplied " + iniGame + "; defaulting to 1.";
  if (parseInt(iniGame)) {
    if (parseInt(iniGame) < 1) { 
      if (alertFlag) { alert(iniGameError); }
      iniGame = 1; 
    }
  } else {
    if ((iniGame != "first") && (iniGame != "last") && (iniGame != "random")) { 
      if (alertFlag) { alert(iniGameError); }
      iniGame = 1; 
    }
  }
  
  if (gup("help") == "true") { developer_help(); }

  SetPgnUrl(pgnFile); 
  SetImagePath ("uscf/24"); 
  SetImageType("png");
  SetHighlightOption(true); // true or false
  SetGameSelectorOptions("select a game...", true, 0, 0, 0, 15, 15, 3, 0); // (head, num, chEvent, chSite, chRound, chWhite, chBlack, chResult, chDate)
  SetCommentsIntoMoveText(false);
  SetCommentsOnSeparateLines(false);
  SetAutoplayDelay(3000); // milliseconds
  SetAutostartAutoplay(false);
  SetAutoplayNextGame(false); // if set, move to the next game at the end of the current game during autoplay
  SetInitialGame(iniGame); // number of game to be shown at load, from 1 (default); values (keep the quotes) of "first", "last", "random" are also accepted
  SetInitialHalfmove("end",true); // halfmove number to be shown at load, 0 (default) for start position; values (keep the quotes) of "start", "end", "random" and "comment" (go to first comment) are also accepted. Second parameter if true applies the setting to every selected game instead of startup only (default)
  SetShortcutKeysEnabled(false);

  SetLiveBroadcast(refreshMinutes, alertFlag, demoFlag); // set live broadcast; parameters are delay (refresh delay in minutes, 0 means no broadcast, default 0) alertFlag (if true, displays debug error messages, default false) demoFlag (if true starts broadcast demo mode, default false)

  originalTitle = document.title;

  ticker_string = " help";
  ticker_counter = 0;
  function update_ticker() {
    document.getElementById("ticker").innerHTML = ticker_string.substring(0, ticker_counter) +
      ticker_string.substring(ticker_counter, ticker_counter + 1).toUpperCase() +
      ticker_string.substring(ticker_counter + 1);
    ticker_counter = (ticker_counter + 1) % ticker_string.length;
  }

  lastRefreshTime = "";
  function customFunctionOnPgnTextLoad() {
    if ((gameEvent[0] != undefined) && (gameEvent[0] != "")) {
      document.title = originalTitle + ": " + gameEvent[0];
    }
    if ((!LiveBroadcastStarted) || (LiveBroadcastEnded)) {
      document.getElementById("liveStatusDetails").className = "headerHighlighted";
    } else {
      document.getElementById("liveStatusDetails").className = "header";
    }

    update_ticker();

    lastRefreshTime = Date();

  }

  function customFunctionOnPgnGameLoad() {
    if ((gameRound[currentGame] != undefined) && (gameRound[currentGame] != "") && (gameRound[currentGame] != "?")) {
      document.getElementById("roundDetails").innerHTML = "round ";
    } else {
      document.getElementById("roundDetails").innerHTML = "";
      document.getElementById("GameRound").innerHTML = "";
    }
    if ((gameWhite[currentGame] != undefined) && (gameWhite[currentGame] != "") && (gameWhite[currentGame] != "?")) {
      document.getElementById("whiteDetails").className = "headerHighlighted";
    } else {
      document.getElementById("whiteDetails").className = "header";
    }
    if ((gameBlack[currentGame] != undefined) && (gameBlack[currentGame] != "") && (gameBlack[currentGame] != "?")) {
      document.getElementById("blackDetails").className = "headerHighlighted";
    } else {
      document.getElementById("blackDetails").className = "header";
    }
    // if ((gameResult[currentGame] != undefined) && ((gameResult[currentGame] == "*") || (gameResult[currentGame] == "?"))) {
    //  document.getElementById("resultDetails").className = "header";
    // } else {
    //  document.getElementById("resultDetails").className = "headerHighlighted";
    // }
  }

  function customFunctionOnMove() {
    if (pgn4webMoveComments[CurrentPly] != "") {
      document.getElementById("GameLiveStatus").style.display = "none";
      document.getElementById("pgn4webComment").style.display = "inline";
      document.getElementById("pgn4webComment").innerHTML = pgn4webMoveComments[CurrentPly];
    } else {
      document.getElementById("pgn4webComment").style.display = "none";
      document.getElementById("pgn4webComment").innerHTML = "";
      document.getElementById("GameLiveStatus").style.display = "inline";
    }
  }

  defaultStatusChanged = false;

// disable A7 and B7 shortcut squares usually allowing showing move comments
// A7
function boardOnClickCol0Row1() { };
boardAlt[0 + 1 * 8] = "";
// B7
function boardOnClickCol1Row1() { };
boardAlt[1 + 1 * 8] = "";

function gup( name ){

  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  // commented below to match first occurrence (to avoid users overruling setting)
  // regexS = regexS+"(?!.*"+regexS+")"; // matches the LAST occurrence
  var regex = new RegExp( regexS );
  var results = regex.exec( window.location.href );
  if( results != null ) { switch (results[1]) {
    case "t": case "T": return "true";  break;
    case "f": case "F": return "false"; break;
    default: return results[1];
  } }

  // allows for short version of the URL parameters, for instance sC matches squareColor
  compact_name = name.charAt(0);
    for(i=1; i<name.length; i++){
      if (name.charAt(i).match(/[A-Z]/)) { compact_name = compact_name + name.charAt(i).toLowerCase(); }
    }
  name = compact_name;

  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  // commented below to match first occurrence (to avoid users overruling setting)
  // regexS = regexS+"(?!.*"+regexS+")"; // matches the LAST occurrence
  var regex = new RegExp( regexS );

  var results = regex.exec( window.location.href );
  if( results != null ) { switch (results[1]) {
    case "t": case "T": return "true";  break;
    case "f": case "F": return "false"; break;
    default: return results[1];
  } }

  return "";
}

function developer_help() {
  alert("pgn4web live.html parameters" + "\n" + 
        " - pgnFile = " + pgnFile + "; PGN file to load (default live.pgn)" + "\n" +
        " - initialGame = " + iniGame + "; initial game to load, a number or first, last, random (default 1)" + "\n" +
        " - refreshMinutes = " + refreshMinutes + "; refresh interval in minutes, decimals allowed (default 1)" + "\n" +
        " - demo = " + demoFlag + "; if set true, sets live demo mode (default false)" + "\n" +
        " - help = if set true, prints this help (default false)");
}

function user_help() {

  if (refreshMinutes != 1) { plural = "s"; }
  else { plural = ""; }

  if (demoFlag) { demoString = "demo mode enabled" + "\n"; }
  else { demoString = ""; }

  helpText = "Chess games live broadcast using pgn4web v" + version + "\n" +
	     "\n" +
	     "Games are automatically updated every " + 
	     refreshMinutes + " minute" + plural  + " from the remote file " +
	     "(" + pgnFile + "). " +
	     "If the shown game is kept at the last available move, " +
	     "upon refresh the chessboard steps forward automatically " +
	     "to the game's latest position. " + 
	     "The refresh stops once all games are finished. " + 
	     "If no games are shown, just wait for the live broadcast to start. " +
	     "There is no need to reload the webpage to refresh games, " +
	     "but it's possible to manually force a refresh by clicking on square B6." + "\n" + 
	     "\n" +
	     "Chessboard squares are input buttons to control the games display:" + "\n" +
	     "\n" +
	     "A1 / H1: game start / end" + "\n" + 
	     "D1 / E1: move back / forwards" + "\n" +
	     "A3 / H3: load first / last game" + "\n" +
	     "C3 / F3: load previous / next game" + "\n" +
	     "C4 / F4: jump to previous / next finished game" + "\n" +
	     "D4 / E4: jump to previous / next unfinished game" + "\n" +
	     "A6 / C6: pause / restart live broadcast automatic refresh" + "\n" +
	     "B6: force games refresh during live broadcast" + "\n" +
	     "G8 / H8: shortcut squares help / pgn4web help" + "\n" +
	     "\n" +
	     "Status:" + "\n" + 
	     "\n" +
	     demoString +
	     "last refresh: " + lastRefreshTime + "\n" +
	     "live broadcast started:" + LiveBroadcastStarted + 
	     " ended:" + LiveBroadcastEnded + 
	     " paused:" + LiveBroadcastPaused + "\n" +
	     "\n" + 
	     "Press OK for more pgn4web help information" +
	     "\n ";

  if (confirm(helpText)) { displayHelp(); }
}

</script>

</head>

<body>

<!-- paste your PGN below and make sure you dont specify an external source with SetPgnUrl() -->
<span style="display:none" id="pgnText">

</span>
<!-- paste your PGN above and make sure you dont specify an external source with SetPgnUrl() -->

<center>

<!-- 460 is the max width for a 480 wide screen (like the blackberry 8900) allowing for scrollbars -->
<!-- 360 is the max height for a 260 tall screen (like the blackberry 8900) -->
<table width=460px height=360px cellpadding=0 cellspacing=0 border=0>
<tr><td align=center valign=top>

<!-- same width as abobe with cellspacing 5 (over 2 columns) -->
<table id="liveTable" width=460px cellpadding=0 cellspacing=5 border=0>

<tr>

<!-- width is 450 = (460 table width) - (2 columns) * (5 cellspacing) --> 
<!-- padding-top 4 -->
<td align=left colspan=2 width=450px style="padding-top: 4px;">
<div id="GameSelector"></div>
</td>

</tr>

<tr>

<!-- left column width 246 (chessboard size) = 8 * (26 square size + 2 * (2 square border)) + 2 * (3 chessboard border) -->
<td width=246px align=left>

<!-- left column width 246, 3 cellpadding -->
<table class="header" id="whiteDetails" width=246px cellpadding=3 cellspacing=0><tr><td align=left>
<span id="GameWhite"></span>
</td><td align=right>
<span id="GameWhiteClock"></span>
</td></tr></table>

<!-- left column width 246, 3 cellpadding -->
<table class="header" id="blackDetails" width=246px cellpadding=3 cellspacing=0><tr><td align=left>
<span id="GameBlack"></span>
</td><td align=right>
<span id="GameBlackClock"></span>
</td></tr></table>

</td>

<!-- right column width 199 = (460 table width) - (246 left column width) - (3 * (5 cellspacing)) -->
<td width=199px align=left>

<!-- right column width 199, cellpadding = 3 -->
<table class="header" width=199px cellpadding=3 cellspacing=0><tr><td align=left>
<span id="GameEvent"></span>
</td><td align=right>
<span id="roundDetails"></span><span id="GameRound"></span>
</td></tr></table>

<!-- right column width 199, cellpadding = 3 -->
<table class="header" width=199px cellpadding=3 cellspacing=0><tr><td align=left>
<span id="GameSite"></span>
</td><td align=right>
<span id="GameDate"></span>
</td></tr></table>

</td>

</tr>

<tr valign=top>

<!-- left column width 246 -->
<td width=246px align=left>
<span id="GameBoard"></span>
</td>

<!-- right column width 199 -->
<td width=199px align=left valign=top>
<!-- padding left/right 3, height 243 = (246 chessboard size) - (3 padding) -->
<div class="movebox" id="GameText" style="height: 243px; padding-left: 3px; padding-right: 3px; overflow: auto;">
</div>
</td>

<tr>

<!-- left column width 246 -->
<td width=246px align=left valign=middle>

<!-- left column width 246 -->
<table width=246px cellpadding=0 cellspacing=0><tr><td id="resultDetails" class="header" width="50%" align=left valign=middle>
<!-- padding left 3 -->
<span style="padding-left: 3px;" id="GameResult"></span>
</td><td width="50%" align=right valign=middle>
<!-- padding right 3 -->
<a class="helplink" id="ticker" style="padding-right: 3px;" href="javascript: user_help();" onFocus="this.blur()" title="pgn4web live broadcast help">HELP</a>
</td></tr></table>
</td>

<!-- right column width 199 -->
<td class="header" id="liveStatusDetails" width=199px align=center valign=middle">
<span style="display: none;" id="pgn4webComment"></span>
<span style="display: inline;" id="GameLiveStatus"></span>
</td>

</tr>

</table>

</td></tr>
</table>
</center>

</body>

</html>

