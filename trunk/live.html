<html>

<head>

<title>pgn4web live boradcast</title>

<link href="live.css" type="text/css" rel="stylesheet"></link>

<script src="pgn4web.js" type="text/javascript"></script>
<script>

  if (gup("demo") == "true") { demoFlag = true; alertFlag = true; }
  else { demoFlag = false; alertFlag = false; }

  if ((pgnFile = gup("pgnFile")) == "") { pgnFile = "live.pgn"; }

  if ((refreshMinutes = gup("refreshMinutes")) == "") { 
    refreshMinutes = 1;
  }
  else {
    testMinutes = refreshMinutes + "";
    if ((testMinutes.match(/[^0-9\.]/)) || (refreshMinutes == 0)) {
      if (alertFlag) { 
	      alert("ERROR: refreshMinutes parameter must be a positive number.\n" +
		    "Supplied " + testMinutes + "; defaulting to 1."); 
      }
      refreshMinutes = 1;
    }
  }

  if ((iniGame = gup("initialGame")) == "") {iniGame = 1; }
  iniGameError = "ERROR: initialGame parameter must be a positive number or " +
                 "'first', 'last' or 'random'.\n" +
                 "Supplied " + iniGame + "; defaulting to 1.";
  if (parseInt(iniGame)) {
    if (parseInt(iniGame) < 1) { 
      if (alertFlag) { alert(iniGameError); }
      iniGame = 1; 
    }
  } else {
    if ((iniGame != "first") && (iniGame != "last") && (iniGame != "random")) { 
      if (alertFlag) { alert(iniGameError); }
      iniGame = 1; 
    }
  }
  
  if (gup("help") == "true") { developer_help(); }

  SetPgnUrl(pgnFile); 
  SetImagePath ("uscf/24"); 
  SetImageType("png");
  SetHighlightOption(true); // true or false
  SetGameSelectorOptions("Select a live game...", true, 0, 0, 0, 15, 15, 3, 0); // (head, num, chEvent, chSite, chRound, chWhite, chBlack, chResult, chDate)
  SetCommentsIntoMoveText(false);
  SetCommentsOnSeparateLines(false);
  SetAutoplayDelay(3000); // milliseconds
  SetAutostartAutoplay(false);
  SetAutoplayNextGame(false); // if set, move to the next game at the end of the current game during autoplay
  SetInitialGame(iniGame); // number of game to be shown at load, from 1 (default); values (keep the quotes) of "first", "last", "random" are also accepted
  SetInitialHalfmove("end",true); // halfmove number to be shown at load, 0 (default) for start position; values (keep the quotes) of "start", "end", "random" and "comment" (go to first comment) are also accepted. Second parameter if true applies the setting to every selected game instead of startup only (default)
  SetShortcutKeysEnabled(false);

  SetLiveBroadcast(refreshMinutes, alertFlag, demoFlag); // set live broadcast; parameters are delay (refresh delay in minutes, 0 means no broadcast, default 0) alertFlag (if true, displays debug error messages, default false) demoFlag (if true starts broadcast demo mode, default false)

  originalTitle = document.title;

  ticker_length = 5;
  ticker_string =  new Array(ticker_length);
  ticker_string[0] = "help";
  ticker_string[1] = "Help";
  ticker_string[2] = "hElp";
  ticker_string[3] = "heLp";
  ticker_string[4] = "helP";
  ticker_counter = 0;
  function customFunctionOnPgnTextLoad() {
    if ((gameEvent[0] != undefined) && (gameEvent[0] != "")) {
      document.title = originalTitle + ": " + gameEvent[0];
    }
    if ((!LiveBroadcastStarted) || (LiveBroadcastEnded)) {
      document.getElementById("liveStatusDetails").style.background = "#F5B371";
    } else {
      document.getElementById("liveStatusDetails").style.background = "#EEEEEE";
    }
    document.getElementById("ticker").innerHTML = ticker_string[ticker_counter];
    ticker_counter = (ticker_counter + 1) % ticker_length;

    lastRefreshTime = Date();
  }

  lastRefreshTime = "";

  function customFunctionOnPgnGameLoad() {
    if ((gameRound[currentGame] != undefined) && (gameRound[currentGame] != "") && (gameRound[currentGame] != "?")) {
      document.getElementById("roundDetails").innerHTML = "round ";
    } else {
      document.getElementById("roundDetails").innerHTML = "";
      document.getElementById("GameRound").innerHTML = "";
    }
    if ((gameWhite[currentGame] != undefined) && (gameWhite[currentGame] != "") && (gameWhite[currentGame] != "?")) {
      document.getElementById("whiteDetails").style.background = "#F5B371";
    } else {
      document.getElementById("whiteDetails").style.background = "#EEEEEE";
    }
    if ((gameBlack[currentGame] != undefined) && (gameBlack[currentGame] != "") && (gameBlack[currentGame] != "?")) {
      document.getElementById("blackDetails").style.background = "#F5B371";
    } else {
      document.getElementById("blackDetails").style.background = "#EEEEEE";
    }
    // if ((gameResult[currentGame] != undefined) && ((gameResult[currentGame] == "*") || (gameResult[currentGame] == "?"))) {
    //  document.getElementById("GameResult").innerHTML = "";
    // }
  }

// disable A7 and B7 shortcut squares usually allowing showing move comments
// A7
function boardOnClickCol0Row1() { };
boardAlt[0 + 1 * 8] = "";
// B7
function boardOnClickCol1Row1() { };
boardAlt[1 + 1 * 8] = "";

function gup( name ){

  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  // commented below to match first occurrence (to avoid users overruling setting)
  // regexS = regexS+"(?!.*"+regexS+")"; // matches the LAST occurrence
  var regex = new RegExp( regexS );
  var results = regex.exec( window.location.href );
  if( results != null ) { switch (results[1]) {
    case "t": case "T": return "true";  break;
    case "f": case "F": return "false"; break;
    default: return results[1];
  } }

  // allows for short version of the URL parameters, for instance sC matches squareColor
  compact_name = name.charAt(0);
    for(i=1; i<name.length; i++){
      if (name.charAt(i).match(/[A-Z]/)) { compact_name = compact_name + name.charAt(i).toLowerCase(); }
    }
  name = compact_name;

  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  // commented below to match first occurrence (to avoid users overruling setting)
  // regexS = regexS+"(?!.*"+regexS+")"; // matches the LAST occurrence
  var regex = new RegExp( regexS );

  var results = regex.exec( window.location.href );
  if( results != null ) { switch (results[1]) {
    case "t": case "T": return "true";  break;
    case "f": case "F": return "false"; break;
    default: return results[1];
  } }

  return "";
}

function developer_help() {
  alert("pgn4web live.html parameters" + "\n" + 
        " - pgnFile = " + pgnFile + "; PGN file to load (default live.pgn)" + "\n" +
        " - initialGame = " + iniGame + "; initial game to load, a number or first, last, random (default 1)" + "\n" +
        " - refreshMinutes = " + refreshMinutes + "; refresh interval in minutes, decimals allowed (default 1)" + "\n" +
        " - demo = " + demoFlag + "; if set true, sets live demo mode (default false)" + "\n" +
        " - help = if set true, prints this help (default false)");
}

function user_help() {

  if (refreshMinutes != 1) { plural = "s"; }
  else { plural = ""; }

  if (demoFlag) { demoString = " (demo mode)"; }
  else { demoString = ""; }

  helpText = "pgn4web chess games live broadcast" + demoString + "\n" + 
             "\n" + 
	     "Chess games live broadcast using pgn4web v" + version + "\n" +
	     "\n" +
	     "Games are automatically updated every " + 
	     refreshMinutes + " minute" + plural  + " from remote file " + pgnFile + ". " + "\n" +
	     "If the shown game is at the last available move, " +
	     "on refresh the position is updated again to the last available move. " +
	     "The refresh stops once all games are ended. " +
	     "If no games are shown, just wait for the live broadcast to start. " +
	     "There is no need to reload the webpage to refresh games; " +
	     "to manually force a refresh, click on square A6." + "\n" + 
	     "\n" +
	     "Chessboard squares are input buttons to control the games display:" + "\n" +
	     "\n" +
	     "\tD1 / E1\tmove back / forwards" + "\n" +
	     "\tA1 / H1\tgame start / end" + "\n" + 
	     "\tC3 / F3\tprevious / next game" + "\n" +
	     "\tA3 / H3\tfirst / last game" + "\n" +
	     "\tA6     \tforce games refresh during live broadcast" + "\n" +
	     "\tB6 / C6\tpause / restart live broadcast automatic refresh" + "\n" +
	     "\tG8 / H8\tshortcuts help / pgn4web help" + "\n" +
	     "\n" +
	     "Status info:" + "\n" + 
	     "- last refresh: " + lastRefreshTime + "\n" +
	     "- live broadcast started:" + LiveBroadcastStarted + 
	     " ended:" + LiveBroadcastEnded + 
	     " paused:" + LiveBroadcastPaused + "\n" +
	     "\n" + 
	     "Press OK to visit the pgn4web project website " + project_url +
	     "\n\t";

  if (confirm(helpText)) { window.open(project_url); }
}

</script>

</head>

<body>

<!-- paste your PGN below and make sure you dont specify an external source with SetPgnUrl() -->
<span style="display:none" id="pgnText">

</span>
<!-- paste your PGN above and make sure you dont specify an external source with SetPgnUrl() -->

<center>

<table id="liveTable" width=460px cellpadding=0 cellspacing=5 border=0>

<tr>

<td align=left colspan=2 width=450px>
<div id="GameSelector"></div>
</td>

</tr>

<tr>

<td width=246px align=left>

<table id="whiteDetails" cellpadding=3 cellspacing=0 width=246px><tr><td align=left>
<span style="font-size: 75%" id="GameWhite"></span>
</td><td align=right>
<span style="font-size: 75%" id="GameWhiteClock"></span>
</td></tr></table>

<table id="blackDetails" cellpadding=3 cellspacing=0 width=246px><tr><td align=left>
<span style="font-size: 75%" id="GameBlack"></span>
</td><td align=right>
<span style="font-size: 75%" id="GameBlackClock"></span>
</td></tr></table>

</td>

<td width=199px align=left>

<table cellpadding=3 cellspacing=0 width=199px><tr><td align=left>
<span style="font-size: 75%" id="GameEvent"></span>
</td><td align=right>
<span style="font-size: 75%"><span id="roundDetails"></span><span id="GameRound"></span></span>
</td></tr></table>

<table cellpadding=3 cellspacing=0 width=199px><tr><td align=left>
<span style="font-size: 75%" id="GameSite"></span>
</td><td align=right>
<span style="font-size: 75%" id="GameDate"></span>
</td></tr></table>

</td>

</tr>

<tr valign=top>

<td width=246px align=left>
<span id="GameBoard"></span>
</td>

<td width=199px align=left valign=top>	
<div id="GameText" style="height: 243px; font-size: 66%; padding-left: 3px; padding-right: 3px; overflow: auto; scrollbar-base-color: #E4E4E4;">
</div>
</td>

<tr>

<td width=246px align=left valign=middle>
<table width=246px cellpadding=0 cellspacing=0><tr><td align=left valign=middle>
<span style="padding-left: 3px; font-size: 75%" id="GameResult"></span>
</td><td align=right valign=middle>
<a id="ticker" style="padding-right: 3px; color: #CCCCCC; font-family: monospace; font-size: 75%; font-weight: normal; text-decoration: none;" href="javascript: user_help();" onFocus="this.blur()">HELP</a>
</td></tr></table>
</td>

<td id="liveStatusDetails" width=199px align=center valign=middle>
<span style="font-size: 75%;" id="GameLiveStatus"></span>
</td>

</tr>

</table>

</center>

</body>

</html>

