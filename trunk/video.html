<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2011 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<head>

<link rel="shortcut icon" href="pawn.ico" />

<style type="text/css">

body {
  color: black;
  background: white;
  font-family: sans-serif;
}

.boardTable {
  border-style: solid;
  border-color: #663300;
  border-width: 3px;
  height: 270x;
  width: 270px;
  box-shadow: 0px 0px 20px #663300;
  -webkit-box-shadow: 0px 0px 20px #663300;
  -moz-box-shadow: 0px 0px 20px #663300;
}

.pieceImage {
  width: 26px;
  height: 26px;
}

.whiteSquare,
.blackSquare,
.highlightWhiteSquare,
.highlightBlackSquare {
  width: 33px;
  height: 33px;
  border-style: solid;
  border-width: 2px;
}

.whiteSquare,
.highlightWhiteSquare {
  border-color: #FFCC99;
  background: #FFCC99;
}

.blackSquare,
.highlightBlackSquare {
  border-color: #CC9966;
  background: #CC9966;
}

.highlightWhiteSquare,
.highlightBlackSquare {
  border-color: #663300;
  border-style: solid;
}

</style>

<script type="text/javascript" src="swfobject/swfobject.js"></script>

<script src="pgn4web.js" type="text/javascript"></script>

</head>

<body>

<!-- paste your PGN below and make sure you dont specify an external source with SetPgnUrl() -->
<form style="display: none;"><textarea style="display: none;" id="pgnText">

</textarea></form>

<table><tr valign="middle"><td>

<div style="font-weight:bold;">
<span id="GameEvent"></span>
&nbsp; &nbsp;
<span id="GameSite"></span>
&nbsp; &nbsp;
<span id="GameDate"></span>
</div>

</td><td width="20"></td><td>

<div id="debug"></div>

</td></tr><tr valign="middle"><td>

<div id="videodiv">
depending on your chosen video,<br>you need HTML5 video support or<br>flash player support
</div>

</td><td width=20></td><td>

<div style="font-weight:bold; margin-bottom:1em;">
<div id="GameBlackClock" style="float:right;"></div>
<div id="GameBlack"></div>
</div>
<div id="GameBoard"></div>
<div style="font-weight:bold; margin-top:1em;">
<div id="GameWhiteClock" style="float:right;"></div>
<div id="GameWhite"></div>
</div>

</td></tr><tr valign="middle"><td colspan="3">

<div id="warning" style="color:lightgray; font-style:italic; text-align:right; margin-top: 0.5em; margin-bottom: 0.5em;"></div>

</td></tr></table>

<script type="text/javascript">

var pgnFile_default = "video.pgn";
// accepts pgnData as alias for pgnFile for consistency with board.html
if ((pgnFile = gup("pgnData")) === "") {
  if ((pgnFile = gup("pgnFile")) === "") {
    pgnFile = pgnFile_default;
  }
}

var videoUrl_default = "video.ogv";
if ((videoUrl = gup("videoUrl")) === "") {
  videoUrl = videoUrl_default;
}

var youtubeVideoid_default = "";
if ((youtubeVideoid = gup("youtubeVideoid")) === "") {
  youtubeVideoid = youtubeVideoid_default;
}

var videoWidth_default = youtubeVideoid ? "480" : "";
if ((videoWidth = gup("videoWidth")) === "") {
  videoWidth = videoWidth_default;
}

var videoHeight_default = youtubeVideoid ? "360" : "";
if ((videoHeight = gup("videoHeight")) === "") {
  videoHeight = videoHeight_default;
}

if ((gup("debug") == "true") || (gup("debug") == "t")) {
  document.getElementById("debug").style.display = "inline";
} else {
  document.getElementById("debug").style.display = "none";
}

if ((gup("help") == "true") || (gup("help") == "t")) {
  alert("pgn4web youtube.html parameters" + "\n" +
        " - pgnData = " + pgnFile + "; PGN file to load (default " + pgnFile_default + ")" + "\n" +
        " - videoUrl = " + videoUrl + "; video URL to load (default " + videoUrl_default + ")" + "\n" +
        " - youtubeVideoid = " + youtubeVideoid + "; youtube video id, overrides videoUrl (default " + youtubeVideoid_default + ")" + "\n" +
        " - videoWidth = " + videoWidth + "; video width (default " + videoWidth_default + ")" + "\n" +
        " - videoHeigth = " + videoHeight + "; video height (default " + videoHeight_default + ")" + "\n" +
        " - debug = true|false; if true timing info is shown to help adjuting the PGN file (default false)" + "\n" +
        " - help = true; prints this help (default false)");
}

function gup( name ){

  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  // commented below to match first occurrence (to avoid users overruling setting)
  // regexS = regexS+"(?!.*"+regexS+")"; // matches the LAST occurrence
  var regex = new RegExp( regexS, "i" );
  var results = regex.exec( window.location.href );
  if( results !== null ) { return decodeURIComponent(results[1]); }

  // allows for short version of the URL parameters, for instance sC matches squareColor
  compact_name = name.charAt(0);
    for(i=1; i<name.length; i++){
      if (name.charAt(i).match(/[A-Z]/)) { compact_name = compact_name + name.charAt(i).toLowerCase(); }
    }
  name = compact_name;

  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  regexS = "[\\?&]"+name+"=([^&#]*)";
  // commented below to match first occurrence (to avoid users overruling setting)
  // regexS = regexS+"(?!.*"+regexS+")"; // matches the LAST occurrence
  regex = new RegExp( regexS, "i" );

  results = regex.exec( window.location.href );
  if( results !== null ) { return decodeURIComponent(results[1]); }

  return "";
}

if (youtubeVideoid) {
  document.getElementById("warning").innerHTML = "experimental integration of pgn4web with youtube";
  var expressInstall = null;
  var flashvars = { };
  var params = { allowScriptAccess: "always", play: "true", loop: "false", menu: "false" };
  var atts = { id: "videoPlayer" };
  swfobject.embedSWF("http://www.youtube.com/e/" + youtubeVideoid + "?enablejsapi=1&playerapiid=ytplayer&autoplay=1&loop=0&rel=0&disablekb=1", "videodiv", videoWidth, videoHeight, "8", expressInstall, flashvars, params, atts);
} else {
  document.getElementById("warning").innerHTML = "experimental integration of pgn4web with HTML5 video";
  document.getElementById("videodiv").innerHTML = '<video id="videoPlayer" src="' + videoUrl + '" controls="controls" autoplay="autoplay"' + (videoWidth ? ' width="' + videoWidth + '"' : '') + (videoHeight ? ' height="' + videoHeight + '"' : '') + '></video>'; 
}

SetPgnUrl(pgnFile); // if set, this has precedence over the inline PGN below
SetImagePath ("alpha/26"); // use "" path if images are in the same folder as this javascript file
SetImageType("png");
SetHighlightOption(true); // true or false
SetShortcutKeysEnabled(false);

clearShortcutSquares("A", "123456");
clearShortcutSquares("BCDEFGH", "1234567");

var videotimeForGame = new Array();
function getVideotimeForGame() {
  videotimeForGame = new Array();
  for(thisGame=0; thisGame<numberOfGames; thisGame++) {
    videotimeForGame[thisGame] = parseFloat(customPgnHeaderTag("VideoTime", null, thisGame));
    if (!videotimeForGame[thisGame]) { videotimeForGame[thisGame] = 0; }
  }
}

var videotimeAtPly = new Array();
function getVideotimeAtPly() {
  videotimeAtPly = new Array();
  for(thisPly=StartPly; thisPly<=StartPly+PlyNumber; thisPly++) {
    videotimeAtPly[thisPly] = parseFloat(customPgnCommentTag("vt", null, thisPly));
    if (!videotimeAtPly[thisPly]) { videotimeAtPly[thisPly] = 0; }
  }
}

function customFunctionOnPgnGameLoad() {
  getVideotimeAtPly();
}

var syncInterval = 456; // milliseconds
var syncTimer = null;
function customFunctionOnPgnTextLoad() {
  getVideotimeForGame();
  if (syncTimer) { clearTimeout(syncTimer); }
  syncTimer = setTimeout("syncBoard();", syncInterval);
}

function syncBoard() {
  var videoCurrentTime = 0;
  if (syncTimer) { clearTimeout(syncTimer); }

  videoPlayer = document.getElementById("videoPlayer");
  if (videoPlayer.currentTime) { videoCurrentTime = videoPlayer.currentTime; }
  else if (videoPlayer.getCurrentTime) { videoCurrentTime = videoPlayer.getCurrentTime(); }
  document.getElementById("debug").innerHTML = videoCurrentTime;

  for (thisGame=1; thisGame<numberOfGames; thisGame++) {
    if (videotimeForGame[thisGame] && (videotimeForGame[thisGame] > videoCurrentTime)) { break; }
  }
  if (currentGame != (thisGame-1)) { Init(thisGame-1); }

  for (thisPly=StartPly; thisPly<=StartPly+PlyNumber; thisPly++) {
    if (videotimeAtPly[thisPly] && (videotimeAtPly[thisPly] > videoCurrentTime)) { break; }
    GoToMove(thisPly);
  } 
  syncTimer = setTimeout("syncBoard();", syncInterval);
}

</script>

</body>

</html>
