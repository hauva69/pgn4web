<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009-2012 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<head>

<title>engine analysis</title>

<link rel="shortcut icon" href="pawn.ico" />

<style type="text/css">

body {
  margin: 0;
  padding: 28px;
  background: #F4F4F4;
  overflow: hidden;
}

a {
  color: black;
  text-decoration: none;
}

.boardTable {
  border-style: solid;
  border-color: #DDDDDD;
  border-width: 3px;
  background: #F4F4F4;
  width: 230px;
  height: 230px;
}

.pieceImage {
  width: 24px;
  height: 24px;
}

.whiteSquare,
.blackSquare,
.highlightWhiteSquare,
.highlightBlackSquare {
  width: 26px;
  height: 26px;
  border-style: solid;
  border-width: 1px;
}

.whiteSquare,
.highlightWhiteSquare {
  border-color: #F4F4F4;
  background: #F4F4F4;
}

.blackSquare,
.highlightBlackSquare {
  border-color: #DDDDDD;
  background: #DDDDDD;
}

.highlightWhiteSquare,
.highlightBlackSquare {
  border-style: inset;
  border-color: #DDDDDD;
}

.move,
.variation,
.comment {
}

.moveOn,
.variationOn {
  background: #DDDDDD;
}

.container {
  width: 230px;
  overflow: hidden;
}

.gameAnalysis {
  margin-top: 28px;
  color: black;
  font-family: sans-serif;
  font-size: 12px;
  font-weight: bold;
}

.gameToMove {
  margin-left: 3px;
  height: 5px;
  width: 5px;
  border-color: black;
}

.gameMoves {
  width: 154px;
  overflow: hidden;
  white-space: nowrap;
}

.gameEval {
  margin-right: 3px;
  font-size: 14px;
}

</style>

<script src="pgn4web.js" type="text/javascript"></script>
<script src="chess-informant-NAG-symbols.js" type="text/javascript"></script>
<script type="text/javascript">
   SetImagePath ("alpha/24");
   SetImageType("png");
   SetShortcutKeysEnabled(false);

   clearShortcutSquares("A", "23456");
   clearShortcutSquares("BCDEFGH", "2345678");
</script>

</head>

<body>


<!-- paste your PGN below and make sure you dont specify an external source with SetPgnUrl() -->
<form style="display: none;"><textarea style="display: none;" id="pgnText">

</textarea></form>
<!-- paste your PGN above and make sure you dont specify an external source with SetPgnUrl() -->


<center>
<div class="container">
<div id="GameBoard"></div>
<table class="gameAnalysis" width="230" height="18" cellpadding="0" cellspacing="0" border="0"><tr>
<td width="31" align="left" valign="bottom">
<img class="gameToMove" id="GameToMove" src="alpha/24/clear.png" border="1" />&nbsp;
</td><td width="154" align="left" valign="bottom">
<div class="gameMoves" id="GameMoves"><span class="gamePv" id="GamePv"></span><span id="GameText"></span></div>
</td><td width="45" align="right" valign="bottom">
&nbsp;<span class="gameEval" id="GameEval"></span>
</td></tr></table>
</center>

<script type="text/javascript">

var pgnFile = FenStringStart;
thisRegExp = /(&|\?)(fenString|fs)=([^&]*)(&|$)/i;
if (window.location.search.match(thisRegExp) !== null) {
   fenString = unescape(window.location.search.match(thisRegExp)[3]);
}
document.getElementById("pgnText").innerHTML = '[Setup "1"]\n[FEN "' + fenString + '"]\n';

var minAnalysisTime = 1;
var maxAnalysisTime = 300;
var analysisTime = 10;
thisRegExp = /(&|\?)(analysisTime|at)=([^&]*)(&|$)/i;
if (window.location.search.match(thisRegExp) !== null) {
   analysisTimeCandidate = unescape(window.location.search.match(thisRegExp)[3]);
   if (!isNaN(analysisTimeCandidate) && (analysisTimeCandidate >= minAnalysisTime) && (analysisTimeCandidate <= maxAnalysisTime)) {
      analysisTime = analysisTimeCandidate;
   }
}

var g_backgroundEngineValid = true;
var g_backgroundEngine;

function InitializeBackgroundEngine() {
   if (!g_backgroundEngineValid) { return false; }

   if (!g_backgroundEngine) {
      g_backgroundEngineValid = true;
      try {
          g_backgroundEngine = new Worker("garbochess/garbochess.js");
          g_backgroundEngine.onmessage = function (e) {
             if (e.data.match("^pv") == "pv") {
                if (matches = e.data.substr(3, e.data.length - 3).match(/Ply:(\d+) Score:(-*\d+) Nodes:(\d+) NPS:(\d+) (.*)/)) {
                   ply = parseInt(matches[1], 10);
                   if (isNaN(ev = parseInt(matches[2], 10))) {
                      ev = "";
                   } else {
                      maxEv = 99.9;
                      ev = Math.round(ev / 100) / 10;
                      if (ev < -maxEv) { ev = -maxEv; } else if (ev > maxEv) { ev = maxEv; }
                      if (fenString.indexOf(" b ") !== -1) { ev = -ev; }
                   }
                   document.getElementById("GameEval").innerHTML = ev2NAG(ev);
                   document.getElementById("GameEval").title = (ev > 0 ? "+" : "") + ev + (ev == Math.floor(ev) ? ".0" : "");
                   nodes = parseInt(matches[3], 10);
                   nodesPerSecond = parseInt(matches[4], 10);
                   pv = matches[5].replace(/\s*(\+|stalemate)/g, "").replace(/\s*checkmate/, "#");
                   document.getElementById("GamePv").innerHTML = pv;
                   document.getElementById("GameMoves").title = pv;
                }
             }
          };
      } catch (e) {
        g_backgroundEngineValid = false;
        document.getElementById("GameMoves").innerHTML = "analysis engine unavailable";
        document.getElementById("GameMoves").title = "analysis engine not supported by this web browser";
      }
   }
   return g_backgroundEngineValid;
}

function ev2NAG(ev) {
   if ((ev === null) || (ev === "") || (isNaN(ev = parseFloat(ev)))) { return ""; }
   if (ev < -3.95) { return NAG[19]; } // -+
   if (ev >  3.95) { return NAG[18]; } // +-
   if (ev < -1.35) { return NAG[17]; } // -/+
   if (ev >  1.35) { return NAG[16]; } // +/-
   if (ev < -0.35) { return NAG[15]; } // =/+
   if (ev >  0.35) { return NAG[14]; } // +/=
   return NAG[11];                     // =
}

function StopBackgroundEngine() {
   g_backgroundEngine.terminate();
   g_backgroundEngine = null;
   document.getElementById("pgnText").innerHTML += document.getElementById("GamePv").innerHTML;
   document.getElementById("GamePv").innerHTML = "";
   start_pgn4web();
}

function setAnalysisTimeout(analysisSeconds) {
   setTimeout(StopBackgroundEngine, analysisSeconds * 1000);
}

if (InitializeBackgroundEngine()) {
   g_backgroundEngine.postMessage("position " + fenString);
   g_backgroundEngine.postMessage("analyze");
   setAnalysisTimeout(analysisTime);
}


function customFunctionOnMove() {
   if (theObject = document.getElementById("GameToMove")) {
      theObject.style.backgroundColor = CurrentPly % 2 ? "black" : "white";
      theObject.title = (CurrentPly % 2 ? "black" : "white") + " to move";
   }
}

</script>

</body>

</html>
