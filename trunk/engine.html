<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009-2012 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<head>

<title>engine analysis</title>

<link rel="shortcut icon" href="pawn.ico" />

<style type="text/css">

body {
  margin: 0;
  padding: 28px;
  padding-bottom: 18px;
  color: black;
  background: #F4F4F4;
  font-family: sans-serif;
  font-size: 14px;
  font-weight: bold;
  overflow: hidden;
}

a {
  color: black;
  text-decoration: none;
}

.boardTable {
  border-style: solid;
  border-color: #DDDDDD;
  border-width: 3px;
  background: #F4F4F4;
  width: 230px;
  height: 230px;
}

.pieceImage {
  width: 24px;
  height: 24px;
}

.whiteSquare,
.blackSquare,
.highlightWhiteSquare,
.highlightBlackSquare {
  width: 26px;
  height: 26px;
  border-style: solid;
  border-width: 1px;
}

.whiteSquare,
.highlightWhiteSquare {
  border-color: #F4F4F4;
  background: #F4F4F4;
}

.blackSquare,
.highlightBlackSquare {
  border-color: #DDDDDD;
  background: #DDDDDD;
}

.highlightWhiteSquare,
.highlightBlackSquare {
  border-style: inset;
  border-color: #DDDDDD;
}

.move,
.variation,
.comment {
}

.moveOn,
.variationOn {
  background: #DDDDDD;
}

.container {
  width: 230px;
  overflow: hidden;
  position: relative;
}

.gameEval {
  padding-left: 14px;
  padding-right: 3px;
  padding-bottom: 10px;
  background: #F4F4F4;
  position: absolute;
  right: 0;
}

.gameAnalysis {
  height: 18px;
  white-space: nowrap;
  text-align: left;
  padding-top: 28px;
  padding-bottom: 10px;
}

.gameAnalysisHidden {
  visibility: hidden;
}

.gameFlagAndMoves {
}

.gameFlagToMove {
  margin-left: 3px;
  margin-right: 14px;
  height: 5px;
  width: 5px;
  border-color: black;
}

.gameMoves {
  white-space: nowrap;
  font-size: 12px;
}

</style>

<script src="pgn4web.js" type="text/javascript"></script>
<script src="chess-informant-NAG-symbols.js" type="text/javascript"></script>
<script type="text/javascript">
   SetImagePath ("alpha/24");
   SetImageType("png");
   SetShortcutKeysEnabled(true);

   clearShortcutSquares("A", "23456");
   clearShortcutSquares("BCDEFGH", "2345678");
   boardShortcut("A1", "go to the analyzed position", function(t,e){ startButton(e); }, true);
   boardShortcut("H1", "go to the principal variation end", function(t,e){ endButton(e); }, true);
</script>

</head>

<body>


<!-- paste your PGN below and make sure you dont specify an external source with SetPgnUrl() -->
<form style="display: none;"><textarea style="display: none;" id="pgnText">

</textarea></form>
<!-- paste your PGN above and make sure you dont specify an external source with SetPgnUrl() -->

<center>
<div class="container">
<div id="GameBoard"></div>
<div class="gameAnalysis gameAnalysisHidden" id="GameAnalysis">
<div class="gameEval" id="GameEval">&middot;</div>
<div class="gameFlagAndMoves">
<a href="javascript:void(0);" onclick="GoToMove(StartPlyVar[0], 0); this.blur();"><img class="gameFlagToMove" id="GameFlagToMove" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoEAYAAADcbmQuAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAAZiS0dEAMAAwADAGp0HVAAAAAlwSFlzAAAASAAAAEgARslrPgAAAAl2cEFnAAAAKAAAACgAo3CU+AAAACNJREFUaN7twQENAAAAwqD3T20PBxQAAAAAAAAAAAAAAAAPBjIoAAFxtd2pAAAAAElFTkSuQmCC" border="1" /></a>
<span class="gameMoves" id="GameMoves"><span class="gamePv" id="GamePv"></span><span id="GameText"></span></span>
</div>
</div>
</center>

<script type="text/javascript">

var pgnFile = FenStringStart;
thisRegExp = /(&|\?)(fenString|fs)=([^&]*)(&|$)/i;
if (window.location.search.match(thisRegExp) !== null) {
   fenString = unescape(window.location.search.match(thisRegExp)[3]);
}
document.getElementById("pgnText").innerHTML = '[Setup "1"]\n[FEN "' + fenString + '"]\n';

var minAnalysisSeconds = 3;
var maxAnalysisSeconds = 313;
var analysisSeconds = 13;
thisRegExp = /(&|\?)(analysisSeconds|as)=([1-9][0-9]*)(&|$)/i;
if (window.location.search.match(thisRegExp) !== null) {
   analysisSeconds = parseInt(unescape(window.location.search.match(thisRegExp)[3]), 10);
   if (analysisSeconds < minAnalysisSeconds) { analysisSeconds = minAnalysisSeconds; }
   if (analysisSeconds > maxAnalysisSeconds) { analysisSeconds = maxAnalysisSeconds; }
}


var engineWorker = "garbochess/garbochess.js";

var g_backgroundEngineValid = true;
var g_backgroundEngine;
var g_nodesPerSecond = 0;

function InitializeBackgroundEngine() {
   if (!g_backgroundEngineValid) { return false; }

   if (!g_backgroundEngine) {
      g_backgroundEngineValid = true;
      try {
          g_backgroundEngine = new Worker(engineWorker);
          g_backgroundEngine.onmessage = function (e) {
             if (e.data.match("^pv") == "pv") {
                if (matches = e.data.substr(3, e.data.length - 3).match(/Ply:(\d+) Score:(-*\d+) Nodes:(\d+) NPS:(\d+) (.*)/)) {
                   ply = parseInt(matches[1], 10);
                   if (isNaN(ev = parseInt(matches[2], 10))) {
                      ev = "";
                   } else {
                      maxEv = 99.9;
                      ev = Math.round(ev / 100) / 10;
                      if (ev < -maxEv) { ev = -maxEv; } else if (ev > maxEv) { ev = maxEv; }
                      if (fenString.indexOf(" b ") !== -1) { ev = -ev; }
                   }
                   document.getElementById("GameEval").innerHTML = ev2NAG(ev);
                   document.getElementById("GameEval").title = "position evaluation: " + (ev > 0 ? "+" : "") + ev + (ev == Math.floor(ev) ? ".0" : "");
                   nodes = parseInt(matches[3], 10);
                   g_nodesPerSecond = parseInt(matches[4], 10);
                   pv = matches[5].replace(/\s*(\+|stalemate)/g, "").replace(/\s*checkmate/, "#");
                   document.getElementById("GamePv").innerHTML = pv;
                   document.getElementById("GameMoves").title = "principal variation:" + pv;
                }
             }
          };
      } catch (e) {
        g_backgroundEngineValid = false;
        document.getElementById("GameMoves").innerHTML = "analysis engine unavailable";
        document.getElementById("GameMoves").title = "analysis engine not supported by this web browser";
      }
   }
   return g_backgroundEngineValid;
}

function ev2NAG(ev) {
   if ((ev === null) || (ev === "") || (isNaN(ev = parseFloat(ev)))) { return ""; }
   if (ev < -3.95) { return NAG[19]; } // -+
   if (ev >  3.95) { return NAG[18]; } // +-
   if (ev < -1.35) { return NAG[17]; } // -/+
   if (ev >  1.35) { return NAG[16]; } // +/-
   if (ev < -0.35) { return NAG[15]; } // =/+
   if (ev >  0.35) { return NAG[14]; } // +/=
   return NAG[11];                     // =
}

function StopBackgroundEngine() {
   g_backgroundEngine.terminate();
   g_backgroundEngine = null;
   document.getElementById("pgnText").innerHTML += document.getElementById("GamePv").innerHTML;
   document.getElementById("GamePv").innerHTML = "";
   start_pgn4web();
}

function setAnalysisTimeout(seconds) {
   setTimeout(StopBackgroundEngine, seconds * 1000);
}

function StartEngineAnalysis() {
   if (InitializeBackgroundEngine()) {
      g_backgroundEngine.postMessage("position " + CurrentFEN());
      g_backgroundEngine.postMessage("analyze");
      setAnalysisTimeout(analysisSeconds);
   }
}


var beginningOfTime = true;
function customFunctionOnPgnTextLoad() {
   if (theObject = document.getElementById("GameAnalysis")) {
      theObject.className = "gameAnalysis";
   }
   if (beginningOfTime) {
      StartEngineAnalysis();
      beginningOfTime = false;
   }
}

function customFunctionOnMove() {
   if (theObject = document.getElementById("GameFlagToMove")) {
      theObject.style.backgroundColor = CurrentPly % 2 ? "black" : "white";
      theObject.title = (CurrentPly % 2 ? "black" : "white") + " to move";
   }
}

function customDebugInfo() {
   return "engine=" + engineWorker + " analysisSeconds=" + analysisSeconds + " nodesPerSecond=" + num2string(g_nodesPerSecond);
}

function num2string(num) {
   if (num >= Math.pow(10, 9)) { num = Math.floor(num / Math.pow(10, 9)) + "G"; }
   else if (num >= Math.pow(10, 6)) { num = Math.floor(num / Math.pow(10, 6)) + "M"; }
   else if (num >= Math.pow(10, 3)) { num = Math.floor(num / Math.pow(10, 3)) + "K"; }
   else { num = num + ""; }
   return num;
}

</script>

</body>

</html>
