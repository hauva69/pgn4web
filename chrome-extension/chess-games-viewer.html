<html id="html">

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2011 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<!-- 

HTML, CSS and Javascript code optimized for use as extension 
of Google Chrome. Don't use with any other browser.

-->

<head>

<title>chess games viewer</title>

<link href="chess-games-viewer.css" type="text/css" rel="stylesheet" />

<!-- not needed within a google chrome extension
<link rel="shortcut icon" href="pawn.ico" />
-->

<script src="js-unzip/js-unzip.js" type="text/javascript"></script>
<script src="js-unzip/js-inflate.js" type="text/javascript"></script>
<script src="pgn4web.js" type="text/javascript"></script>

</head>

<body>

<!-- paste your PGN below and make sure you dont specify an external source with SetPgnUrl() -->
<form style="display: none;"><textarea style="display: none;" id="pgnText">

{ chess games viewer }

</textarea></form>
<!-- paste your PGN above and make sure you dont specify an external source with SetPgnUrl() -->

<script type="text/javascript">

   var backgroundPage;
   if ((typeof(chrome) != "undefined") && (chrome.extension)) {
      backgroundPage = chrome.extension.getBackgroundPage();
   }

   var highlightOption_default = true;
   var commentsOnSeparateLines_default = false;

   thisRegExp = /(&|\?)(help|h)([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      alert("pgn4web google chrome chess games viewer" + "\n" + 
            "chess-games-viewer.html parameters" + "\n\n" +
            " - pgnBackground = index" + "\n\n" +
            " - pgnData = URL.pgn" + "\n\n" +
            " - refreshMinutes = live broadcast delay (default 0 = live broadcast disabled)" + "\n\n" +
            " - refreshDemo = if set true sets live demo mode (default false)" + "\n\n" +
            " - search = search expression (default first game for normal view and first unfinished game for live broadcast view)" + "\n\n" +
            " - help");
   }

   function setPgnTextIndexFromTabId(tab) {
      if (backgroundPage) {
         if ((backgroundPage.pgnTextIndexFromTabId[tab.id] !== null) && (backgroundPage.pgnTextIndexFromTabId[tab.id] !== undefined) && (backgroundPage.pgnTextIndexFromTabId[tab.id] !== pgnBackground)) {
            backgroundPage.removePgnTextOnRemoved(tab.id);
         }
         backgroundPage.pgnTextIndexFromTabId[tab.id] = pgnBackground;
         theObject = document.getElementById("pgnText");
         if ((theObject) && (theObject.value) && (theObject.value != backgroundPage.pgnText[pgnBackground]))
         { backgroundPage.pgnText[pgnBackground] = theObject.value; }
      }
   }

   pgnBackground = null;
   if (backgroundPage) {
      thisRegExp = /(&|\?)(pgnBackground|pb)=([^&]*)(&|$)/i;
      if (window.location.search.match(thisRegExp) !== null) {
         if ((pgnBackground = unescape(window.location.search.match(thisRegExp)[3])) !== "") {
            theObject = document.getElementById("pgnText");
            theBackgroundPgnText = backgroundPage.pgnText[pgnBackground];
            if ((theObject) && (theBackgroundPgnText) && (theBackgroundPgnText !== undefined)) 
            { theObject.value = theBackgroundPgnText; }
            chrome.tabs.getCurrent(setPgnTextIndexFromTabId);
         }
      }
   }

   pgnData = "";
   thisRegExp = /(&|\?)(pgnData|pd)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      pgnData = unescape(window.location.search.match(thisRegExp)[3]);
   }
      
   SetImagePath("alpha/128");
   SetImageType("png");
   SetHighlightOption(getHighlightOptionFromLocalStorage());
   SetGameSelectorOptions(null, true, 12, 12, 2, 15, 15, 3, 10);
   SetCommentsIntoMoveText(true);
   SetCommentsOnSeparateLines(getCommentsOnSeparateLinesFromLocalStorage());
   SetAutostartAutoplay(false);
   SetAutoplayNextGame(false);
   SetShortcutKeysEnabled(true);

   alertFlag = demoFlag = false;
   thisRegExp = /(&|\?)(refreshDemo|rd)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      refreshDemo = unescape(window.location.search.match(thisRegExp)[3]);
      if ((refreshDemo == "true") || (refreshDemo == "t")) { alertFlag = demoFlag = true; }
   }

   refreshMinutes = 0;
   stepFlag = true;
   thisRegExp = /(&|\?)(refreshMinutes|rm)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      refreshMinutes = unescape(window.location.search.match(thisRegExp)[3]);
   }

   searchGame = "";
   thisRegExp = /(&|\?)(search|s)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      searchGame = unescape(window.location.search.match(thisRegExp)[3]);
   }

   function setInitialGameFromSearchGame() {
      if (searchGame) { SetInitialGame(searchGame); }
      else if (LiveBroadcastDelay > 0) { SetInitialGame("\\[\\s*Result\\s*\"\\*\"\\s*\\]"); }
      else { SetInitialGame(1); }
   }

   function getHighlightOptionFromLocalStorage() {
      try { ho = (localStorage.getItem("pgn4web_chess_games_viewer_highlightOption") != "false"); }
      catch (e) { return highlightOption_default; }
      return ho;
   }
   function setHighlightOptionToLocalStorage() {
      try { localStorage.setItem("pgn4web_chess_games_viewer_highlightOption", highlightOption ? "true" : "false"); }
      catch (e) { return false; }
      return true;
   }

   function getCommentsOnSeparateLinesFromLocalStorage() {
      try { cosl = (localStorage.getItem("pgn4web_chess_games_viewer_commentsOnSeparateLines") == "true"); }
      catch (e) { return commentsOnSeparateLines_default; }
      return cosl;
   }
   function setCommentsOnSeparateLinesToLocalStorage() {
      try { localStorage.setItem("pgn4web_chess_games_viewer_commentsOnSeparateLines", commentsOnSeparateLines ? "true" : "false"); }
      catch (e) { return false; }
      return true;
   }

   // A7
   if ((typeof(chrome) != "undefined") && (typeof(chrome.tabs) != "undefined") && (typeof(chrome.tabs.create) != "undefined")) { boardShortcut("A7", "about the chess games viewer extension for google chrome", function(){ chrome.tabs.create({url: "about.html"}); }); }
   // C7
   boardShortcut("C7", "toggle show comments on separate lines in game text and save setting", function(){ SetCommentsOnSeparateLines(!commentsOnSeparateLines); oldPly = CurrentPly; Init(); GoToMove(oldPly); setCommentsOnSeparateLinesToLocalStorage(); });
   // D7
   boardShortcut("D7", "toggle highlight last move and save setting", function(){ SetHighlight(!highlightOption); setHighlightOptionToLocalStorage(); });
   // F5
   boardShortcut("F5", "scroll to chessboard's top", function(){ scrollToEmOffset(2); });
   // G5
   boardShortcut("G5", "toggle scrolling between page's top and bottom", function(){ toggleScrollPosition(); });

   function fixHeaderTag(elementId) {
      var headerId = ["GameEvent", "GameSite", "GameDate", "GameRound", "GameWhite", "GameBlack", "GameResult", "GameSection", "GameStage", "GameBoardNum", "Timecontrol", "GameWhiteTitle", "GameBlackTitle", "GameWhiteElo", "GameBlackElo", "GameECO", "GameOpening", "GameVariation", "GameSubVariation", "GameTermination", "GameWhiteClock", "GameBlackClock", "GameTimeControl"];
      var headerLabel = ["event", "site", "date", "round", "white player", "black player", "result", "section", "stage", "board", "time control", "white title", "black title", "white elo", "black elo", "eco", "opening", "variation", "subvariation", "termination", "white clock", "black clock", "time control"];
      theObject = document.getElementById(elementId);
      if (theObject) { 
        theObject.className = (theObject.innerHTML === "") ? "innerHeaderItemNoMargin" : "innerHeaderItem"; 
        theObject.title = (headerId.indexOf(elementId) < 0 ? elementId : headerLabel[headerId.indexOf(elementId)] ) + ": " + theObject.innerHTML;
      }
   }

   function customPgnHeaderTagWithFix(tag, elementId) {
      customPgnHeaderTag(tag, elementId);
      fixHeaderTag(elementId);
   }

   function customFunctionOnMove() {
      wObject = document.getElementById('GameWhiteClock');
      bObject = document.getElementById('GameBlackClock');
      if (wObject && bObject) {
         if ((!wObject.innerHTML.match(/\S/)) && (bObject.innerHTML.match(/\S/))) { wObject.innerHTML = '-'; }
         if ((!bObject.innerHTML.match(/\S/)) && (wObject.innerHTML.match(/\S/))) { bObject.innerHTML = '-'; }
      }
      fixHeaderTag('GameWhiteClock');
      fixHeaderTag('GameBlackClock');
      if (theObject = document.getElementById('GameLastMove')) {
         if (CurrentPly == StartPly) {
            theObject.innerHTML = ((CurrentPly%2) ? "black" : "white") + " to move";
         }
      }
   }

   function customFunctionOnPgnGameLoad() {
      fixHeaderTag('GameDate');
      fixHeaderTag('GameSite');
      fixHeaderTag('GameEvent');
      customPgnHeaderTagWithFix('Section', 'GameSection');
      customPgnHeaderTagWithFix('Stage', 'GameStage');
      fixHeaderTag('GameRound');
      if (theObject = document.getElementById("GameRound")) {
         if (theObject.innerHTML) {
            theObject.innerHTML = "round " + theObject.innerHTML;
         }
      }
      customPgnHeaderTagWithFix('Board', 'GameBoardNum');
      if (theObject = document.getElementById("GameBoardNum")) {
         if (theObject.innerHTML) {
            theObject.innerHTML = "board " + theObject.innerHTML;
         }
      }
      customPgnHeaderTagWithFix('TimeControl', 'GameTimeControl');
      fixHeaderTag('GameWhite');
      fixHeaderTag('GameBlack');
      customPgnHeaderTagWithFix('WhiteTitle', 'GameWhiteTitle');
      customPgnHeaderTagWithFix('BlackTitle', 'GameBlackTitle');
      customPgnHeaderTagWithFix('WhiteElo', 'GameWhiteElo');
      customPgnHeaderTagWithFix('BlackElo', 'GameBlackElo');
      customPgnHeaderTagWithFix('ECO', 'GameECO');
      customPgnHeaderTagWithFix('Opening', 'GameOpening');
      customPgnHeaderTagWithFix('Variation', 'GameVariation');
      customPgnHeaderTagWithFix('SubVariation', 'GameSubVariation');
      fixHeaderTag('GameResult');
      customPgnHeaderTagWithFix('Termination', 'GameTermination');
      // if (PlyNumber > 0) { customPgnHeaderTag('Result', 'ResultAtGametextEnd'); }
      // else { if (theObject = document.getElementById('ResultAtGametextEnd')) { theObject.innerHTML = ""; } }
      if (theObject = document.getElementById('lastMoveAndComment')) {
         var lastDisplayStyle = "none";
         if ((PlyNumber > 0) || (gameFEN[currentGame])) {
            for(ii=StartPly; ii<=StartPly+PlyNumber; ii++) {
               if (strippedMoveComment(ii)) {
                  lastDisplayStyle = "block";
                  break;
               }
            }
         }
         theObject.style.display = lastDisplayStyle;
      }
   }

   function customFunctionOnPgnTextLoad() {
      noGamesLoaded = (numberOfGames == 1) && (PlyNumber === 0) && (StartPly === 0) && (!gameWhite[0]) && (!gameBlack[0]) && (!gameResult[0]) && (!gameFEN[0]); 
      if (theObject = document.getElementById("moveText")) { theObject.style.minHeight = noGamesLoaded ? "1.4em" : "7em"; }
      if (LiveBroadcastDelay > 0) {
         document.title = LiveBroadcastStatusString.replace(" &nbsp;", ",");
      } else {
         if (noGamesLoaded) { document.title = alertNum ? "PGN data error" : "chess games viewer"; }
         else { document.title = numberOfGames + " game" + (numberOfGames == 1 ? "" : "s"); }
      }
      scrollToEmOffset(noGamesLoaded ? 32.5 : 0);

      // H5
      if ((typeof(chrome) != "undefined") && (chrome.extension) && (pgnUrl) && (LiveBroadcastDelay > 0)) {
         boardShortcut("H5", "zoom out to the multiple small boards view", switchBoardView);
      } else {
         clearShortcutSquares("H", "5");
      }
   }

   function underlineByTicker(text, ticker) {
      position = ticker % text.length;
      return (text.substring(0, position) + "<u>" +text.substring(position, position + 1) + "</u>" + text.substring(position + 1));
   }

   function customFunctionOnCheckLiveBroadcastStatus() {
      if (theObject = document.getElementById("GameLiveStatus")) {
         if (LiveBroadcastTicker > 1) {
            theObject.innerHTML =  theObject.innerHTML.replace(/live/, underlineByTicker("live", LiveBroadcastTicker-2));
         }
      }
   }

   function scrollToEmOffset(offset) {
      boardTableInEm = 24.5;
      if (theObject = document.getElementById("boardTable")) {
         if (offset < 0) {
            window.scrollTo(0, document.body.offsetHeight - document.body.clientHeight + offset * theObject.offsetHeight / boardTableInEm);
         } else {
            window.scrollTo(0, offset * theObject.offsetHeight / boardTableInEm);
         }
      }
   }
   function customShortcutKey_Shift_1() { window.scrollTo(0, 0); }
   function customShortcutKey_Shift_2() { scrollToEmOffset(1); }
   function customShortcutKey_Shift_3() { scrollToEmOffset(2); }
   function customShortcutKey_Shift_4() { scrollToEmOffset(3); }
   function customShortcutKey_Shift_5() { scrollToEmOffset(4); }
   function customShortcutKey_Shift_6() { scrollToEmOffset(28.5); }
   function customShortcutKey_Shift_7() { scrollToEmOffset(32.5); }
   function customShortcutKey_Shift_8() { scrollToEmOffset(-6); }
   function customShortcutKey_Shift_9() { scrollToEmOffset(-1.5); }
   function customShortcutKey_Shift_0() { window.scrollTo(0, document.body.offsetHeight); }

   function toggleScrollPosition() {
      if (document.body.scrollTop) { window.scrollTo(0, 0); }
      else { window.scrollTo(0, document.body.scrollHeight); }
   }

   function lookupFidePlayer(name) {
      if (name) {
         window.open("http://ratings.fide.com/seek.phtml?idcode=&name=" + escape(name) + "&offset=0");
      }
   }

   function switchBoardView() {
      if ((typeof(chrome) != "undefined") && (chrome.extension) && (pgnUrl) && (LiveBroadcastDelay > 0)) {
         url = "live-mosaic-viewer.html?pgnData=" + escape(pgnUrl) + "&refreshMinutes=" + escape(refreshMinutes) + "&hp=t";
         if (demoFlag) { url += "&refreshDemo=true"; }
         url += "&firstGame=" + (currentGame + 1);
         location.href = url;
      }
   }

   window.onload = function() {
      if (pgnData) { useNewPgnUrl(pgnData, refreshMinutes); }
      else { 
         setInitialGameFromSearchGame();
         start_pgn4web();
      }
   };

</script>

<div class="columnsContainer">

<div class="boardColumn">
<center>
<div id="GameBoard" class="gameBoard"></div>
<div id="GameButtons" class="gameButtons"></div>
</center>
</div>

<div class="headerColumn">
<div class="headerItem"><span class="innerHeaderItem" id="GameDate"></span><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameSite"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameEvent"></span><span class="innerHeaderItem" id="GameSection"></span><span class="innerHeaderItem" id="GameStage"></span><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameRound"></span><span class="innerHeaderItem" id="GameBoardNum"></span><span class="innerHeaderItem" id="GameTimeControl"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameECO"></span><span class="innerHeaderItem" id="GameOpening"></span><span class="innerHeaderItem" id="GameVariation"></span><span class="innerHeaderItem" id="GameSubVariation"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameWhiteClock"></span><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="javascript:void(0);" onclick="lookupFidePlayer(this.innerHTML);" class="innerHeaderItem" id="GameWhite"></a></b><span class="innerHeaderItem" id="GameWhiteTitle"></span><span class="innerHeaderItem" id="GameWhiteElo"></span><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="javascript:void(0);" onclick="lookupFidePlayer(this.innerHTML);" class="innerHeaderItem" id="GameBlack"></a></b><span class="innerHeaderItem" id="GameBlackTitle"></span><span class="innerHeaderItem" id="GameBlackElo"></span><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameBlackClock"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><b><span class="innerHeaderItem" id="GameResult"></span></b><span class="innerHeaderItem" id="GameTermination"></span><b>&nbsp;</b></div>
</div>

</div>

<div class="lastMoveAndComment" id="lastMoveAndComment"><a href="javascript:MoveToNextComment();" class="lastMove" title="last move" id="GameLastMove"></a><a href="javascript:MoveToPrevComment();" class="lastComment" title="current position comment" id="GameLastComment"></a></div>

<div id="moveText" class="moveText"><span id="GameText"></span> <span class="move" id="ResultAtGametextEnd"></span></div>

<div id="GameSearch"></div>
<div id="GameSelector"></div>

<a id="toolbarSpacer" class="toolbarSpacer" href="javascript:void(0);" onclick="window.scrollTo(0, 0);">&nbsp</a>

<div id="notes" class="notes">
<div title="live broadcast status" id="GameLiveStatus" class="gameLiveStatus"></div>
<div id="loadButtons" class="loadButtons">
<input type="button" id="remoteLivePgnUrl" name="remoteLivePgnUrl" class="bottomButton" onclick="fetchNewPgnUrl(true);" value="Enter Live URL" title="enter PGN chess games URL for viewing with live refresh"/>
<input type="button" id="remotePgnUrl" name="remotePgnUrl" class="bottomButton" onclick="fetchNewPgnUrl(false);" value="Enter URL" title="enter PGN chess games URL for viewing; ZIP archives containing PGN chess games files are also accepted"/>
<input type="button" id="inputPgnText" name="inputPgnText" class="bottomButton" onclick="fetchInputPgnText();" value="Enter Text" title="enter PGN chess games TEXT for viewing"/>
<input type="file" id="localPgnFiles" name="localPgnFiles[]" multiple="multiple" class="localPgnFiles" size="4" title="choose local PGN chess games file or drag and drop local PGN chess games files on this page for viewing; ZIP archives containing PGN chess games files are also accepted"/>
</div>
</div>

<script type="text/javascript">

   function fetchNewPgnUrl(live) {
      if (newPgnUrl = prompt("Enter PGN chess games URL for viewing" + (live ? " with live refresh:" : ":"), "")) {
         if (live) { newRefreshMinutes = refreshMinutes ? refreshMinutes : 1 + 0.01 * Math.floor(Math.random()*10); }
         else { newRefreshMinutes = 0; }
         useNewPgnUrl(newPgnUrl, newRefreshMinutes);
      }
   }

   function useNewPgnUrl(newPgnUrl, newRefreshMinutes) {
      refreshMinutes = newRefreshMinutes;
      SetPgnUrl(newPgnUrl);
      SetLiveBroadcast(refreshMinutes, alertFlag, demoFlag, stepFlag);
      setInitialGameFromSearchGame();
      if (refreshMinutes) {
         SetAutoplayDelay(1000);
         SetInitialHalfmove("end", true);
      } else {
         SetAutoplayDelay(2000);
         SetInitialHalfmove(0, true);
      }
      firstStart = true;
      if (theObject = document.getElementById("pgnText")) { theObject.value = ""; }
      if (theObject = document.getElementById("GameLiveStatus")) { theObject.innerHTML = ""; }
      if (theObject = document.getElementById("localPgnFiles")) { theObject.value = ""; }
      LiveBroadcastStarted = false;
      LiveBroadcastEnded = false;
      LiveBroadcastPaused = false;
      LiveBroadcastTicker = 0;
      LiveBroadcastStatusString = "";
      LiveBroadcastLastModified_Reset();
      LiveBroadcastLastReceivedLocal_Reset();
      start_pgn4web();
   }

   var newPgnText;
   var pgnFilesLeft;
   var invalidFiles;
   var validFiles;
   var errorFiles;
   function handleFileSelect(evt) {
      evt.stopPropagation();
      evt.preventDefault();

      var files = new Array();
      if (evt.target.files) { files = evt.target.files; }
      else if (evt.dataTransfer.files) { files = evt.dataTransfer.files; }

      try {
         newPgnText = "";
         pgnFilesLeft = files.length;
         invalidFiles = new Array();
         validFiles = new Array();
         errorFiles = new Array();
         for (f=0; f<files.length; f++) {
            if (files[f].name.match(/\.(pgn|zip)$/i)) {
               var reader = new FileReader();
               reader.onload = (function(theFileName) {
                  return function(e) {
                     if (e.target.result) {
                        if (theFileName.match(/\.(pgn)$/i)) {
                           newPgnText += e.target.result + "\n\n\n";
                           validFiles.push(theFileName);
                        } else if (theFileName.match(/\.(zip)$/i)) {
                           var unzippedPgnText = "";
                           try {
                              var unzipper = new JSUnzip(e.target.result);
                              if (unzipper.isZipFile()) {
                                 unzipper.readEntries();
                                 for (u in unzipper.entries) {
                                    if (unzipper.entries[u].fileName.match(/\.pgn$/i)) {
                                       switch (unzipper.entries[u].compressionMethod) {
                                          case 0:
                                             unzippedPgnText += "\n" + unzipper.entries[u].data + "\n";
                                             break;
                                          case 8:
                                             unzippedPgnText += "\n" + JSInflate.inflate(unzipper.entries[u].data) + "\n";
                                             break;
                                          default:
                                             // unsupported compression method
                                             break;
                                       }
                                    }
                                 } 
                              }
                           } catch(e) { /* missing unzip library or unzip error */ }
                           if (unzippedPgnText) {
                              newPgnText += unzippedPgnText + "\n\n\n";
                              validFiles.push(theFileName);
                           } else {
                              errorFiles.push(theFileName);
                           }
                        } else {
                           errorFiles.push(theFileName);
                        }
                     } else {
                        errorFiles.push(theFileName);
                     }
                     if (! --pgnFilesLeft) { useNewPgnTextFromFiles(); }                            
                  };
               })(files[f].name);
               reader.onerror = (function(theFileName) {
                  return function(e) {
                     errorFiles.push(theFileName);
                     if (! --pgnFilesLeft) { useNewPgnTextFromFiles(); }                            
                  };
               })(files[f].name);
               if (files[f].name.match(/\.(zip)$/i)) { reader.readAsBinaryString(files[f]); }
               else { reader.readAsText(files[f]); }
            } else {
               invalidFiles.push(files[f].name);
               if (! --pgnFilesLeft) { useNewPgnTextFromFiles(); }
            }
         }
      } catch(e) {}
      if (theObject = document.getElementById("localPgnFiles")) { theObject.value = ""; }
   }

   function handleDragOver(evt) {
      evt.stopPropagation();
      evt.preventDefault();
   }

   try {
      if (theObject = document.getElementById("localPgnFiles")) {
         theObject.addEventListener("change", handleFileSelect, false);
      }

      if (theObject = document.getElementById("html")) {
         theObject.addEventListener("dragover", handleDragOver, false);
         theObject.addEventListener("drop", handleFileSelect, false);
      }
   } catch(e) {}

   function useNewPgnTextFromFiles() {
      if (noNewPgnText = !newPgnText) { newPgnText = alertPgnHeader; }
      useNewPgnText(newPgnText);
      allRejectedFiles = invalidFiles.concat(errorFiles).sort();
      if (allRejectedFiles.length) {
         msg = (noNewPgnText ? "error" : "warning");
         msg += ": failed reading PGN games from ";
         msg += (allRejectedFiles.length) + " local ";
         msg += (allRejectedFiles.length == 1 ? "file" : "files");
         for (f in allRejectedFiles) { msg += "\n" + allRejectedFiles[f]; }
         myAlert(msg, noNewPgnText);
      }
   }

   function useNewPgnText(newPgnText) {
      SetPgnUrl("");
      SetLiveBroadcast(0, true, false, false);
      SetAutoplayDelay(2000);
      setInitialGameFromSearchGame();
      SetInitialHalfmove(0, true);
      firstStart = true;
      if (theObject = document.getElementById("pgnText")) { theObject.value = newPgnText; }
      if (theObject = document.getElementById("GameLiveStatus")) { theObject.innerHTML = ""; }
      if (theObject = document.getElementById("localPgnFiles")) { theObject.value = ""; }
      start_pgn4web();
   }

   function fetchInputPgnText() {
      if ((inputPgnText = prompt("Enter PGN chess games TEXT for viewing; pasting multi-line PGN data in the textbox is allowed:", "")) !== null) {
         pgnHeaderRegExpGlobal = /((\[\s*(\w+)\s*"([^"]*)"\s*\]\s*)+)/g;
         inputPgnText = inputPgnText.replace(pgnHeaderRegExpGlobal, "\n$1\n"); // add newline after header section
         inputPgnText = fixCommonPgnMistakes(inputPgnText);
         useNewPgnText(inputPgnText);
      }
   }

</script>

<div class="footer"><a name="bottom"></a></div>

</body>

</html>