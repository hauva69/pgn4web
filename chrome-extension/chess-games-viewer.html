<html id="html">

<!--
  pgn4web javascript chessboard
  copyright (C) 2009-2012 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<!--

HTML, CSS and Javascript code optimized for use as extension
of Google Chrome. Don't use with any other browser.

-->

<head>

<title>chess games viewer</title>

<link href="chess-games-viewer.css" type="text/css" rel="stylesheet" />

<!-- not needed within a google chrome extension
<link rel="shortcut icon" href="pawn.ico" />
-->

<script src="js-unzip/js-unzip.js" type="text/javascript"></script>
<script src="js-unzip/js-inflate.js" type="text/javascript"></script>
<script src="pgn4web.js" type="text/javascript"></script>
<script src="chess-informant-NAG-symbols.js" type="text/javascript"></script>
<script src="fide-lookup.js" type="text/javascript"></script>

</head>

<body onresize="if (typeof(updateAnnotationGraph) != 'undefined') { updateAnnotationGraph(); }">

<!-- paste your PGN below and make sure you dont specify an external source with SetPgnUrl() -->
<form style="display: none;"><textarea style="display: none;" id="pgnText">

</textarea></form>
<!-- paste your PGN above and make sure you dont specify an external source with SetPgnUrl() -->

<script type="text/javascript">

   // alert message redefined to take advantage of page layout
   alertPgnHeader = '[Site "chess games error"]\n[Event "click the top left board square for info"]\n';

   var backgroundPage;
   if ((typeof(chrome) != "undefined") && (typeof(chrome.extension) != "undefined")) {
      backgroundPage = chrome.extension.getBackgroundPage();
   }

   var highlightOption_default = true;
   var commentsOnSeparateLines_default = false;
   var commentsIntoMoveText_default = true;

   thisRegExp = /(&|\?)(help|h)([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      alert("pgn4web google chrome chess games viewer" + "\n" +
            "chess-games-viewer.html parameters" + "\n\n" +
            " - pgnBackground = index" + "\n\n" +
            " - pgnData = URL.pgn" + "\n\n" +
            " - pgnLocalfilesindex = index" + "\n\n" +
            " - refreshMinutes = live broadcast delay (default 0 = live broadcast disabled)" + "\n\n" +
            " - search = search expression (default first game for normal view and first unfinished game for live broadcast view)" + "\n\n" +
            " - help");
   }

   function setPgnTextIndexFromTabId(tab) {
      if (backgroundPage) {
         if ((backgroundPage.pgnTextIndexFromTabId[tab.id] !== null) && (backgroundPage.pgnTextIndexFromTabId[tab.id] !== undefined) && (backgroundPage.pgnTextIndexFromTabId[tab.id] !== pgnBackground)) {
            backgroundPage.removePgnTextOnRemoved(tab.id);
         }
         backgroundPage.pgnTextIndexFromTabId[tab.id] = pgnBackground;
         theObj = document.getElementById("pgnText");
         if ((theObj) && (theObj.value) && (theObj.value != backgroundPage.pgnText[pgnBackground]))
         { backgroundPage.pgnText[pgnBackground] = theObj.value; }
      }
   }

   pgnBackground = null;
   if (backgroundPage) {
      thisRegExp = /(&|\?)(pgnBackground|pb)=([^&]*)(&|$)/i;
      if (window.location.search.match(thisRegExp) !== null) {
         if ((pgnBackground = unescape(window.location.search.match(thisRegExp)[3])) !== "") {
            theObj = document.getElementById("pgnText");
            theBackgroundPgnText = backgroundPage.pgnText[pgnBackground];
            if ((theObj) && (theBackgroundPgnText) && (theBackgroundPgnText !== undefined)) { theObj.value = theBackgroundPgnText; }
            chrome.tabs.getCurrent(setPgnTextIndexFromTabId);
         }
      }
   }

   function setLocalPgnFilesIndexFromTabId(tab) {
      if (backgroundPage) { backgroundPage.localPgnFilesIndexFromTabId[tab.id] = pgnLocalfilesindex; }
   }

   pgnLocalfilesindex = null;
   if (backgroundPage) {
      thisRegExp = /(&|\?)(pgnLocalfilesindex|pl)=([^&]*)(&|$)/i;
      if (window.location.search.match(thisRegExp) !== null) {
         if ((pgnLocalfilesindex = unescape(window.location.search.match(thisRegExp)[3])) !== "") {
            chrome.tabs.getCurrent(setLocalPgnFilesIndexFromTabId);
         }
      }
   }

   pgnData = "";
   thisRegExp = /(&|\?)(pgnData|pd)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      pgnData = unescape(window.location.search.match(thisRegExp)[3]);
   }


   // when opening the plain bookmark, once every N times, as a surprise, one of Tim Krabbe's most fantastic moves is shown
   if (!pgnData && !pgnBackground && !pgnLocalfilesindex) {
      tkFEN = new Array(
         '[FEN "r3kbnr/p1pp1qpp/b1n1P3/6N1/1p6/8/Pp3PPP/RNBQR1K1 b kq - 0 12"] 12... O-O-O',
         '[FEN "r2qkb1r/pb1p1p1p/1pn2np1/2p1p3/2P1P3/2NP1NP1/PP3PBP/R1BQ1RK1 w kq - 0 9"] 9. Nxe5',
         '[FEN "5rk1/pp4pp/4p3/2R3Q1/3n4/2q4r/P1P2PPP/5RK1 b - - 1 23"] 23. Qg3',
         '[FEN "r1bq1rk1/3nbppp/pp1p1n2/2pPp3/P1P1P3/2N3P1/1P2QPBP/R1B1K1NR w KQ - 0 10"] 10. Kd1',
         '[FEN "1nbk1b1r/r3pQpp/pq2P3/1p1P2B1/2p5/2P5/5PPP/R3KB1R b KQ - 0 15"] 15... Rd7',
         '[FEN "5r2/q3ppkp/3p2p1/3P4/Nr2PPn1/1R3BP1/P3N2P/R2Q2K1 w - - 1 24"] 24. Nb6',
         '[FEN "4r1k1/1p4p1/pPp2r1p/P1Pp1p2/3P1Pn1/2NR1P2/3Q2Bq/R4K2 b - - 0 31"] 31... Re4 ',
         '[FEN "2kr3r/ppp1qpp1/2p5/2b2b2/2P1pPP1/1P2P1p1/PBQPB3/RN2K1R1 b Q - 1 14"] 14... Rh1',
         '[FEN "1nq3k1/r3b1p1/pp2prNp/2p5/4Q3/2P1P1B1/P4PPP/2R2RK1 w - - 6 21"] 21. Qa8 ',
         '[FEN "rn1q1r1k/2pp4/5pQ1/1b1PB3/8/4P3/PP1K1P1P/R7 b - - 2 19"] 19... Bd3',
         '[FEN "4r1k1/q6p/2p4P/2P2QP1/1p6/rb2P3/1B6/1K4RR w - - 1 38"] 38. Qxh7+',
         '[FEN "rnq2rk1/1pn3bp/p2p2p1/2pPp1PP/P1P1Pp2/2N2N2/1P1B1P2/R2QK2R b KQ - 1 16"] 16... Nc6',
         '[FEN "r3kb1r/1p2pppp/1pn5/3p1b2/3P4/4PN2/PP1B1PPP/R3KB1R b KQkq - 2 10"] 10... Bd7 ',
         '[FEN "r1b2r1k/4qp1p/p2ppb1Q/4nP2/1p1NP3/2N5/PPP4P/2KR1BR1 w - - 4 18"] 18. Nc6',
         '[FEN "8/8/4kpp1/3p1b2/p6P/2B5/6P1/6K1 b - - 2 47"] 47... Bh3',
         '[FEN "r2q1rk1/3nbpp1/4p2p/p1p1P3/1p1P3P/3B1b1R/PPQB1PP1/R3K3 w Q - 0 18"] 18. Bxh6 ',
         '[FEN "r4k1r/1b2bPR1/p4n2/3p4/4P2P/1q2B2B/PpP5/1K4R1 w - - 0 26"] 26. Bh6',
         '[FEN "rn1r2k1/pq1p1ppp/3Rp3/2p5/2P1b3/4QNP1/P3PPBP/3R2K1 w - - 2 17"] 17. Rxe6 ',
         '[FEN "k4b1r/p3pppp/B1p2n2/3rB1N1/7q/8/PPP2P2/R2Q1RK1 w - - 1 18"] 18. c4',
         '[FEN "8/5B2/6Kp/6pP/5b2/p7/1k3P2/8 b - - 3 69"] 69... Be3',
         '[FEN "5r2/7k/1pPP3P/8/4p3/3p4/P4R1P/7K b - - 0 48"] 48... e3',
         '[FEN "8/8/p2k1p2/1p1p3p/1P1P3p/P3NPP1/5K2/1b6 w - - 0 47"] 47. Ng2 ',
         '[FEN "1r6/4k3/r2p2p1/2pR1p1p/2P1pP1P/pPK1P1P1/P7/1B6 b - - 0 48"] 48... Rxb3+',
         '[FEN "6k1/3Q4/5p2/5P2/8/1KP5/PP4qp/2B5 w - - 0 99"] 99. Bg5',
         '[FEN "r2qk2r/1b3ppp/p2p1b2/2nNp3/1R2P3/2P5/1PN2PPP/3QKB1R w Kkq - 3 17"] 17. Rxb7',
         '[FEN "3rrk2/2p1n1bQ/1p3pp1/1q2B1N1/p1b1PP2/6PB/P1P5/3R1RK1 w - - 4 25"] 25. Rd5 ',
         '[FEN "rnb1kr2/pp1p1pQp/6q1/4PpB1/1P6/8/1PP2PPP/2KR3R w q - 2 15"] 15. e6',
         '[FEN "r1bq1rk1/1p3ppp/p1pp2n1/3N3Q/B1PPR2b/8/PP3PPP/R1B3K1 w - - 0 14"] 14. Rxh4',
         '[FEN "7k/1p1P2pp/p7/3P4/1Q5P/5pPK/PP3r2/1q5B b - - 1 37"] 37... h5',
         '[FEN "r2q1rk1/pp2bpp1/4p2p/2pPB2P/2P3n1/3Q2N1/PP3PP1/2KR3R w - - 1 17"] 17. Bxg7',
         '[FEN "r2q1k1r/p3bpp1/2p4p/2Bp4/4B1PP/4Q3/PPP5/2K1R3 w - - 1 22"] 22. Bh7 ',
         '[FEN "2k2b1r/pb1r1p2/5P2/1qnp4/Npp3Q1/4B1P1/1P3PBP/R4RK1 w - - 4 21"] 21. Qg7',
         '[FEN "r7/pp1qrBkb/1npb4/8/2pP3Q/7P/PP3P2/2K3R1 b - - 2 24"] 24... Qg4',
         '[FEN "r1bqkb1r/1p3ppp/p1nppn2/8/2P1P3/N1N5/PP3PPP/R1BQKB1R b KQkq - 1 8"] 8... d5' );
      hints = new Array(
         "use commands at the page top right to enter PGN text, to load local PGN files or to view a remote PGN URL, optionally with live refresh on a single board or on multiple boards",
         "drag and drop local PGN files or zipped PGN files on the single large chessboard page for viewing",
         "interact with the chessboard clicking chessboard squares; hovering the mouse on each square displays an help summary",
         "click square A8 for help on the chessboard user interface",
         "click square B8 for the FEN string of the current position",
         "click square C8 for the PGN data of the current game and click square D8 for the PGN data of all games",
         "interact with the chessboard using keyboard shortcuts keys; click square F8 for a comprehensive list",
         "click square A7 for help on the chess games viewer extension",
         "click square B5 to search games in large PGN files: click square E8 for help",
         "click square F5 for the chess puzzler of the day",
         "click square F2 to probe the endgame tablebase",
         "click square G2 to annotate the game from the current position",
         "click square H2 to toggle the analysis engine",
         "when in live broadcast mode, click square H5 to switch between the single large board view and the multiple small boards view",
         "in case of errors, the top left chessboard square will flash; click the flashing square for detailed error info" );
      if (theObj = document.getElementById("pgnText")) {
         showTKfenEveryN = 20;
         showHintEveryN = showTKfenEveryN - 1;
         if ((randomPick = Math.floor(showTKfenEveryN * tkFEN.length * Math.random())) < tkFEN.length) {
            theObj.innerHTML = '[Site "amazing moves collection"] [Event "#' + (randomPick+1) + '"] ' + tkFEN[randomPick];
            SetInitialVariation(0);
            SetInitialHalfmove("end", true);
         } else if ((randomPick = Math.floor(showHintEveryN * hints.length * Math.random())) < hints.length) {
            theObj.innerHTML = "{chess games viewer tip: " + hints[randomPick] + "}";
         }
      }
   }


   SetImagePath("alpha/128");
   SetImageType("png");
   SetHighlightOption(getHighlightOptionFromLocalStorage());
   SetGameSelectorOptions("", true, 12, 12, 2, 15, 15, 3, 10);
   SetCommentsIntoMoveText(getCommentsIntoMoveTextFromLocalStorage());
   SetCommentsOnSeparateLines(getCommentsOnSeparateLinesFromLocalStorage());
   SetAutostartAutoplay(false);
   SetAutoplayNextGame(false);
   SetShortcutKeysEnabled(true);

   alertFlag = demoFlag = false;
   // undocumented URL parameter, use only in the about page and for testing purposes
   thisRegExp = /(&|\?)(refreshDemo|rd)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      refreshDemo = unescape(window.location.search.match(thisRegExp)[3]);
      if ((refreshDemo == "true") || (refreshDemo == "t")) { alertFlag = demoFlag = true; }
   }

   // undocumented URL parameter, use only for switching between single/multiple boards views
   thisRegExp = /(&|\?)(demoPly|dp)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      gameDemoMaxPly = unescape(window.location.search.match(thisRegExp)[3]).split(",");
      for (g in gameDemoMaxPly) { gameDemoMaxPly[g] = isNaN(p = parseInt(gameDemoMaxPly[g], 10)) ? 0 : p; }
   }

   refreshMinutes = inputRefreshMinutes = 0;
   stepFlag = true;
   thisRegExp = /(&|\?)(refreshMinutes|rm)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      refreshMinutes = inputRefreshMinutes = unescape(window.location.search.match(thisRegExp)[3]);
   }

   searchGame = "";
   thisRegExp = /(&|\?)(search|s)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      searchGame = unescape(window.location.search.match(thisRegExp)[3]);
   }

   function setInitialGameFromSearchGame() {
      if (searchGame) { SetInitialGame(searchGame); }
      else if (LiveBroadcastDelay > 0) { SetInitialGame("\\[\\s*Result\\s*\"\\*\"\\s*\\]"); }
      else { SetInitialGame(1); }
   }

   // undocumented URL parameter: use only when opened from the mosaic view
   rememberHiddenValue = "";
   thisRegExp = /(&|\?)(rememberHidden|rh)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      rememberHiddenValue = unescape(window.location.search.match(thisRegExp)[3]);
   }

   function getHighlightOptionFromLocalStorage() {
      try { ho = (localStorage.getItem("pgn4web_chess_games_viewer_highlightOption") != "false"); }
      catch (e) { return highlightOption_default; }
      return ho;
   }
   function setHighlightOptionToLocalStorage() {
      try { localStorage.setItem("pgn4web_chess_games_viewer_highlightOption", highlightOption ? "true" : "false"); }
      catch (e) { return false; }
      return true;
   }

   function getCommentsIntoMoveTextFromLocalStorage() {
      try { cimt = !(localStorage.getItem("pgn4web_chess_games_viewer_commentsIntoMoveText") == "false"); }
      catch (e) { return commentsIntoMoveText_default; }
      return cimt;
   }
   function setCommentsIntoMoveTextToLocalStorage() {
      try { localStorage.setItem("pgn4web_chess_games_viewer_commentsIntoMoveText", commentsIntoMoveText ? "true" : "false"); }
      catch (e) { return false; }
      return true;
   }

   function getCommentsOnSeparateLinesFromLocalStorage() {
      try { cosl = (localStorage.getItem("pgn4web_chess_games_viewer_commentsOnSeparateLines") == "true"); }
      catch (e) { return commentsOnSeparateLines_default; }
      return cosl;
   }
   function setCommentsOnSeparateLinesToLocalStorage() {
      try { localStorage.setItem("pgn4web_chess_games_viewer_commentsOnSeparateLines", commentsOnSeparateLines ? "true" : "false"); }
      catch (e) { return false; }
      return true;
   }

   function searchTag(tag, key) {
      searchPgnGame('\\[\\s*' + tag + '\\s*"' + fixRegExp(key) + '"\\s*\\]', event.shiftKey);
   }
   function searchTagDifferent(tag, key) {
      searchPgnGame('\\[\\s*' + tag + '\\s*"(?!' + fixRegExp(key) + '"\\s*\\])', event.shiftKey);
   }

   function fixHeaderTag(elementId) {
      var headerId = ["GameEvent", "GameSite", "GameDate", "GameRound", "GameWhite", "GameBlack", "GameResult", "GameSection", "GameStage", "GameBoardNum", "Timecontrol", "GameWhiteTeam", "GameBlackTeam", "GameWhiteTitle", "GameBlackTitle", "GameWhiteElo", "GameBlackElo", "GameECO", "GameOpening", "GameVariation", "GameSubVariation", "GameTermination", "GameWhiteClock", "GameBlackClock", "GameTimeControl"];
      var headerLabel = ["event", "site", "date", "round", "white player", "black player", "result", "section", "stage", "board", "time control", "white team", "black team", "white title", "black title", "white elo", "black elo", "eco", "opening", "variation", "subvariation", "termination", "white clock", "black clock", "time control"];
      theObj = document.getElementById(elementId);
      if (theObj) {
        theObj.className = (theObj.innerHTML === "") ? "innerHeaderItemNoMargin" : "innerHeaderItem";
        theObj.title = (headerId.indexOf(elementId) < 0 ? elementId : headerLabel[headerId.indexOf(elementId)] ) + ": " + theObj.innerHTML;
      }
   }

   function customPgnHeaderTagWithFix(tag, elementId, fixForDisplay) {
      var theObj;
      customPgnHeaderTag(tag, elementId);
      fixHeaderTag(elementId);
      if (fixForDisplay && (theObj = document.getElementById(elementId)) && theObj.innerHTML) {
         theObj.innerHTML = fixCommentForDisplay(theObj.innerHTML);
      }
   }

   var previousCurrentVar = -1;
   function customFunctionOnMove() {

      if (analysisStarted) {
         if (engineUnderstandsGame(currentGame)) {
            if (previousCurrentVar !== CurrentVar) { scanGameForFen(); }
            restartAnalysis();
         }
         else { stopAnalysis(true); }
      } else {
         clearAnalysisHeader();
         clearAnnotationGraph();
      }
      previousCurrentVar = CurrentVar;

      fixHeaderTag('GameWhiteClock');
      fixHeaderTag('GameBlackClock');

      if ((annotateInProgress) && (CurrentPly === StartPly + PlyNumber)) {
         annotateInProgress = false;
         SetAutoplayDelay(2000);
      }

      showProbeTablebaseResults();
   }

   var PlyNumberMax;
   function customFunctionOnPgnGameLoad() {
      fixHeaderTag('GameDate');
      fixHeaderTag('GameSite');
      fixHeaderTag('GameEvent');
      customPgnHeaderTagWithFix('Section', 'GameSection');
      customPgnHeaderTagWithFix('Stage', 'GameStage');
      fixHeaderTag('GameRound');
      if (theObj = document.getElementById("GameRound")) {
         if (theObj.innerHTML) {
            theObj.innerHTML = "round " + theObj.innerHTML;
         }
      }
      customPgnHeaderTagWithFix('Board', 'GameBoardNum');
      if (theObj = document.getElementById("GameBoardNum")) {
         if (theObj.innerHTML) {
            theObj.innerHTML = "board " + theObj.innerHTML;
         }
      }
      customPgnHeaderTagWithFix('TimeControl', 'GameTimeControl');
      fixHeaderTag('GameWhite');
      fixHeaderTag('GameBlack');
      customPgnHeaderTagWithFix('WhiteTeam', 'GameWhiteTeam');
      customPgnHeaderTagWithFix('BlackTeam', 'GameBlackTeam');
      customPgnHeaderTagWithFix('WhiteTitle', 'GameWhiteTitle');
      customPgnHeaderTagWithFix('BlackTitle', 'GameBlackTitle');
      customPgnHeaderTagWithFix('WhiteElo', 'GameWhiteElo');
      customPgnHeaderTagWithFix('BlackElo', 'GameBlackElo');
      customPgnHeaderTagWithFix('ECO', 'GameECO');
      customPgnHeaderTagWithFix('Opening', 'GameOpening', true);
      customPgnHeaderTagWithFix('Variation', 'GameVariation', true);
      customPgnHeaderTagWithFix('SubVariation', 'GameSubVariation', true);
      fixHeaderTag('GameResult');
      customPgnHeaderTagWithFix('Termination', 'GameTermination');
      // if (PlyNumber > 0) { customPgnHeaderTag('Result', 'ResultAtGametextEnd'); }
      // else { if (theObj = document.getElementById('ResultAtGametextEnd')) { theObj.innerHTML = ""; } }

      if (theObj = document.getElementById('lastMoveAndComment')) {
         if ((PlyNumber === 0) && (gameFEN[currentGame])) {
            lastDisplayStyle = "block";
         } else if (commentsIntoMoveText && ((PlyNumber > 0) || (gameFEN[currentGame]))) {
            lastDisplayStyle = GameHasComments ? "block" : "none";
         } else {
            lastDisplayStyle = "none";
         }
         theObj.style.display = lastDisplayStyle;
      }
      if (theObj = document.getElementById("toggleCommentsLink")) {
         if (GameHasComments) {
            theObj.innerHTML = commentsIntoMoveText ? "&times;" : "+";
         } else {
            theObj.innerHTML = "";
         }
      }

      PlyNumberMax = 0;
      for (ii = 0; ii < numberOfVars; ii++) {
         PlyNumberMax = Math.max(PlyNumberMax, StartPlyVar[ii] + PlyNumberVar[ii] - StartPly);
      }

      if (previousCurrentGame !== currentGame) {
         previousPlyNumber = PlyNumber;
         previousCurrentGame = currentGame;
      }
      if (analysisStarted) {
         if (engineUnderstandsGame(currentGame)) { scanGameForFen(); }
         else { stopAnalysis(true); }
      }
      if (theObj = document.getElementById("toggleAnalysisLink")) {
         theObj.style.visibility = engineUnderstandsGame(currentGame) ? "" : "hidden";
      }
      previousCurrentVar = CurrentVar;
   }

   var liveBroadcastUpdateTicker = 1;
   var previousPlyNumber = -1;
   var previousCurrentGame = -1;
   function customFunctionOnPgnTextLoad() {
      var noGamesLoaded = (numberOfGames == 1) && (PlyNumber === 0) && (StartPly === 0) && (!gameWhite[0]) && (!gameBlack[0]) && (!gameResult[0]) && (!gameFEN[0]);
      if (LiveBroadcastDelay > 0) {
         if (previousPlyNumber !== PlyNumber) {
            previousPlyNumber = PlyNumber;
            liveBroadcastUpdateTicker++;
         }
         document.title = liveBroadcastUpdateTicker + "." + LiveBroadcastStatusString.replace(/^(\d*)\D*(\d*)$/, "$1.$2") + " live broadcast" + (demoFlag ? " demo" : "");
      } else {
         if (noGamesLoaded) { document.title = alertNum ? "PGN data error" : "chess games viewer"; }
         else { document.title = numberOfGames + " game" + (numberOfGames == 1 ? "" : "s"); }
      }
      if (theObj = document.getElementById("GameLiveStatusDemo")) { theObj.innerHTML = (LiveBroadcastDelay > 0) && LiveBroadcastDemo ? "demo" : ""; }

      // H5
      if ((typeof(chrome) != "undefined") && (chrome.extension) && (pgnUrl) && (LiveBroadcastDelay > 0)) {
         boardShortcut("H5", "zoom out to the multiple small boards view", function(t,e){ switchBoardView(); });
      } else {
         boardShortcut("H5", "", function(t,e){ alert("warning: zoom out to the multiple small boards view is only available in live refresh mode"); } );
      }

      if (pgnData.indexOf(puzzlerUrl) === 0) {
         if (analysisStarted) { stopAnalysis(true); }
         if (theObj = document.getElementById("GameText")) { theObj.style.visibility = "hidden"; }
         if (theObj = document.getElementById("GameLastComment")) { theObj.style.visibility = "hidden"; }
         alert((pgnData == puzzlerUrl ? "chess puzzler of the day: " : "chess puzzler: ") + (CurrentPly%2 === 0 ? "White" : "Black") + " to move\n\nclick OK to view the solution");
         if (theObj = document.getElementById("GameText")) { theObj.style.visibility = ""; }
         if (theObj = document.getElementById("GameLastComment")) { theObj.style.visibility = ""; }
         MoveForward(1);
      }
   }

   function searchPlayer(name, FideId) {
      if (name) {
         if (event.shiftKey) {
            if (typeof(openFidePlayerUrl) == "function") { openFidePlayerUrl(name, FideId); }
         } else {
            searchPgnGame('\\[\\s*(White|Black)\\s*"' + fixRegExp(name) + '"\\s*\\]', false);
         }
      }
   }

   function searchTeam(name) {
      searchPgnGame('\\[\\s*(White|Black)Team\\s*"' + fixRegExp(name) + '"\\s*\\]', false);
   }

   function switchBoardView() {
      if ((typeof(chrome) != "undefined") && (chrome.extension) && (pgnUrl) && (LiveBroadcastDelay > 0)) {
         if (pgnUrl.match(/\.zip(\?|#|$)/i)) {
            alert("warning: zoom out to the multiple small boards view is not available with ZIP files");
         } else {
            url = "live-mosaic-viewer.html?pgnData=" + escape(pgnUrl) + "&refreshMinutes=" + escape(refreshMinutes) + "&hp=t";
            if (demoFlag) { url += "&refreshDemo=true&demoPly=" + gameDemoMaxPly.join(); }
            url += "&displayGame=" + (currentGame + 1);
            if (rememberHiddenValue) { url += "&rememberHidden=" + escape(rememberHiddenValue); }
            location.href = url;
         }
      }
   }


   function cycleHash() {
      switch (location.hash) {
         case "#board": goToHash("bottom"); break;
         case "#bottom": goToHash(""); break;
         default: goToHash("board"); break;
      }
   }

   function goToHash(hash) {
      if (hash) { location.hash = ""; }
      else { location.hash = "board"; }
      location.hash = hash;
   }


   function showProbeTablebaseResults(res, fenString) {
      if (theObj = document.getElementById("GameTablebaseProbe")) {
         if (typeof(res) != "undefined") {
            if ((typeof(fenString) != "undefined") && (fenString !== CurrentFEN())) { res = "error"; }
            if (secondObject = document.getElementById("GameAnalysisMove")) { secondObject.style.visibility = "hidden"; }
            if (secondObject = document.getElementById("GameAnalysisEval")) { secondObject.style.visibility = "hidden"; }
            if (secondObject = document.getElementById("GameAnalysisPv")) { secondObject.style.visibility = "hidden"; }
            theObj.className = "innerHeaderItem notranslate";
            theObj.innerHTML = translateNAGs("<span class='egtbHead'>$148</span>" + res);
            if (secondObject = document.getElementById("toggleTablebaseLink")) {
               secondObject.innerHTML = "&times;";
               secondObject.style.visibility = "";
            }
         } else {
            if (secondObject = document.getElementById("GameAnalysisMove")) { secondObject.style.visibility = ""; }
            if (secondObject = document.getElementById("GameAnalysisEval")) { secondObject.style.visibility = ""; }
            if (secondObject = document.getElementById("GameAnalysisPv")) { secondObject.style.visibility = ""; }
            theObj.className = "innerHeaderItemNoMargin notranslate";
            theObj.innerHTML = "";
            if (secondObject = document.getElementById("toggleTablebaseLink")) {
               secondObject.innerHTML = "+";
               secondObject.style.visibility = (tablebaseUnderstandsGame(currentGame) && backgroundPage && backgroundPage.tablebaseSupportsFen(CurrentFEN())) ? "" : "hidden";
            }
         }
      }
   }

   function toggleProbeTablebase() {
      if (theObj = document.getElementById("GameTablebaseProbe")) {
         if (theObj.innerHTML) { showProbeTablebaseResults(); }
         else if (checkTablebaseUnderstandsGameAndWarn()) {
            showProbeTablebaseResults("");
            backgroundPage.probeTablebase(CurrentFEN(), showProbeTablebaseResults);
         }
      }
   }

   function tablebaseUnderstandsGame(gameNum) {
      return gameIsNormalChess(gameNum);
   }

   function checkTablebaseUnderstandsGameAndWarn() {
      retVal = tablebaseUnderstandsGame(currentGame);
      if (!retVal) { alert("warning: endgame tablebase not available for chess variants"); }
      return retVal;
   }


   function customShortcutKey_Shift_1() { chrome.tabs.create({url: "https://www.google.com/search?q=chess+games+PGN"}); }

   function customShortcutKey_Shift_2() { cycleHash(); }

   function customShortcutKey_Shift_3() { cycleLastCommentArea(); }

   function customShortcutKey_Shift_4() { toggleProbeTablebase(); }

   function customShortcutKey_Shift_5() { userToggleAnalysis(); }
   function customShortcutKey_Shift_6() { goToMissingAnalysis(true); }

   function customShortcutKey_Shift_7() { fetchInputPgnText(); }
   function customShortcutKey_Shift_8() { openPgnFiles(); }
   function customShortcutKey_Shift_9() { fetchNewPgnUrl(false); }
   function customShortcutKey_Shift_0() { fetchNewPgnUrl(true); }


   function gameIsNormalChess(gameNum) {
      return ((typeof(gameVariant[gameNum]) == "undefined") || (gameVariant[gameNum].match(/^(chess|normal|standard|)$/i) !== null));
   }


   function emPixels(em) { return em * document.getElementById("boardTable").offsetHeight / 24.5; }

   var cycleLCA = 0;
   function cycleLastCommentArea() {
      if (theObj = document.getElementById("GameLastComment")) {
         switch (cycleLCA++ % 3) {
            case 0:
               if (theObj.scrollHeight === theObj.clientHeight) { cycleLastCommentArea(); }
               else { fitLastCommentArea(); }
               break;
            case 1:
               if (theObj.offsetHeight == emPixels(21)) { cycleLastCommentArea(); }
               else { maximizeLastCommentArea(); }
               break;
            case 2:
               if (theObj.offsetHeight == emPixels(4.2)) { cycleLastCommentArea(); }
               else { resetLastCommentArea(); }
               break;
            default:
               break;
         }
      }
   }

   function toggleFitResetLastCommentArea() {
      if (theObj = document.getElementById("GameLastComment")) {
         if ((theObj.scrollHeight === theObj.clientHeight) || (theObj.offsetHeight == emPixels(21))) { resetLastCommentArea(); }
         else { fitLastCommentArea(); }
      }
   }

   function resetLastCommentArea() {
      if (theObj = document.getElementById("GameLastComment")) {
         theObj.style.height = "";
      }
   }

   function fitLastCommentArea() {
      if (theObj = document.getElementById("GameLastComment")) {
         theObj.style.height = "";
         theObj.style.height = theObj.scrollHeight;
      }
   }

   function maximizeLastCommentArea() {
      if (theObj = document.getElementById("GameLastComment")) {
         theObj.style.height = "21em";
      }
   }

   puzzlerUrl = "http://pgn4web.casaschi.net/puzzler.php?pgnMini=true";
   function showPuzzler() {
      alertFlag = demoFlag = false;
      gameDemoMaxPly = new Array();
      resetFenPositions(-1);
      // replace the following line with the commented code to show the last 10 puzzlers when clicking F5 in sequence
      useNewPgnUrl(puzzlerUrl, 0);
      // if (pgnData.indexOf(puzzlerUrl) == -1) { useNewPgnUrl(puzzlerUrl, 0); }
      // else if (pgnData == puzzlerUrl) { useNewPgnUrl(puzzlerUrl + "&gameNum=-1", 0); }
      // else if (match = pgnData.match(/gameNum=(-[1-8])$/)) { useNewPgnUrl(puzzlerUrl + "&gameNum=" + (match[1]-1), 0); }
      // else { useNewPgnUrl(puzzlerUrl, 0); }
   }


   window.onload = function() {
      if (pgnData) { useNewPgnUrl(pgnData, refreshMinutes); }
      else if (pgnLocalfilesindex) { processLocalPgnFilesIndex(); }
      else {
         setInitialGameFromSearchGame();
         start_pgn4web();
      }
   };

</script>

<div class="topMenu">
<table width="100%" cellpadding="0" cellspacing="0" border="0"><tr valign="middle"><td>
<a id="showHelp" name="showHelp" class="topButton" href="javascript:void(0);" onclick="if (backgroundPage && (typeof(backgroundPage.showAboutPage)) != 'undefined') { backgroundPage.showAboutPage(); }" title="chess games viewer extension help"><img class="topButtonImage" src="help.png"/></a>
</td><td>
<select class="hiddenSelect" />
</td><td width="99%">
<div id="GameSelector" class="gameSelector"></div>
</td><td>
<input type="file" id="localPgnFiles" name="localPgnFiles[]" multiple="multiple" class="localPgnFiles" />
</td><td>
<a id="inputPgnText" name="inputPgnText" class="topButton" href="javascript:void(0);" onclick="fetchInputPgnText();" title="enter PGN chess games TEXT for viewing on a single board"><img class="topButtonImage" src="edit.png"/></a>
</td><td>
<a id="openLocalPgnFiles" name="openLocalPgnFiles" class="topButton" href="javascript:void(0);" onclick="openPgnFiles();" title="open local PGN chess games FILES or drag and drop local PGN chess games FILES on this page for viewing on a single board; ZIP archives containing PGN chess games FILES are also accepted"><img class="topButtonImage" src="files.png"/></a>
</td><td>
<a id="remotePgnUrl" name="remotePgnUrl" class="topButton" href="javascript:void(0);" onclick="fetchNewPgnUrl(false);" title="enter PGN chess games URL for viewing on a single board; ZIP archives containing PGN chess games files are also accepted"><img class="topButtonImage" src="download.png"/></a>
</td><td>
<a id="remoteLivePgnUrl" name="remoteLivePgnUrl" class="topButton" href="javascript:void(0);" onclick="fetchNewPgnUrl(true);" title="enter PGN chess games URL for viewing on a single board with live refresh"><img class="topButtonImage" src="refresh.png"/></a>
</td><td>
<a id="remoteLiveMosaicPgnUrl" name="remoteLiveMosaicPgnUrl" class="topButton" href="javascript:void(0);" onclick="fetchNewMosaicPgnUrl();" title="enter PGN chess games URL for viewing on multiple boards with live refresh"><img class="topButtonImage" src="refresh-mosaic.png"/></a>
</td></tr></table>
</div>

<a class="positionLink" name="board" href="javascript:void(0);" onclick="goToHash('board')" onfocus="this.blur();">&nbsp;</a>

<div class="mainContainer">

<div class="columnsContainer">

<div class="boardColumn">
<center>
<div id="GameBoard" class="gameBoard"></div>
<div id="GameButtons" class="gameButtons"></div>
</center>
</div>

<div class="headerColumn">
<div class="headerItem"><a class="innerHeaderItem" id="GameDate" href="javascript:void(0);" onclick="searchTagDifferent('Date', this.innerHTML);"></a><b>&nbsp;</b></div>
<div class="headerItem"><a class="innerHeaderItem" id="GameSite" href="javascript:void(0);" onclick="searchTagDifferent('Site', this.innerHTML);"></a><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><a class="innerHeaderItem" id="GameEvent" href="javascript:void(0);" onclick="searchTagDifferent('Event', this.innerHTML);"></a><a class="innerHeaderItem" id="GameSection" href="javascript:void(0);" onclick="searchTagDifferent('Section', this.innerHTML);"></a><a class="innerHeaderItem" id="GameStage" href="javascript:void(0);" onclick="searchTagDifferent('Stage', this.innerHTML);"></a><b>&nbsp;</b></div>
<div class="headerItem"><a class="innerHeaderItem" id="GameRound" href="javascript:void(0);" onclick="searchTagDifferent('Round', this.innerHTML.replace('round ', ''));"></a><a class="innerHeaderItem" id="GameBoardNum" href="javascript:void(0);" onclick="searchTagDifferent('Board', this.innerHTML);"></a><a class="innerHeaderItem" id="GameTimeControl"  href="javascript:void(0);" onclick="searchTagDifferent('TimeControl', this.innerHTML);"></a><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><a class="innerHeaderItem" id="GameECO" href="javascript:void(0);" onclick="searchTag('ECO', this.innerHTML);"></a><a class="innerHeaderItem" id="GameOpening" href="javascript:void(0);" onclick="searchTag('Opening', customPgnHeaderTag('Opening'));"></a><a class="innerHeaderItem" id="GameVariation" href="javascript:void(0);" onclick="searchTag('Variation', customPgnHeaderTag('Variation'));"></a><a class="innerHeaderItem" id="GameSubVariation" href="javascript:void(0);" onclick="searchTag('SubVariation', customPgnHeaderTag('SubVariation'));"></a><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameWhiteClock"></span><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="javascript:void(0);" onclick="searchPlayer(this.innerHTML, customPgnHeaderTag('WhiteFideId'));" class="innerHeaderItem" id="GameWhite"></a></b><span class="innerHeaderItem" id="GameWhiteTitle"></span><span class="innerHeaderItem" id="GameWhiteElo"></span><a class="innerHeaderItem" id="GameWhiteTeam" href="javascript:void(0);" onclick="searchTeam(this.innerHTML);"></a><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="javascript:void(0);" onclick="searchPlayer(this.innerHTML, customPgnHeaderTag('BlackFideId'));" class="innerHeaderItem" id="GameBlack"></a></b><span class="innerHeaderItem" id="GameBlackTitle"></span><span class="innerHeaderItem" id="GameBlackElo"></span><a class="innerHeaderItem" id="GameBlackTeam" href="javascript:void(0);" onclick="searchTeam(this.innerHTML);"></a><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameBlackClock"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="javascript:void(0);" onclick="searchPgnGame(lastSearchPgnExpression, !event.shiftKey);" class="innerHeaderItem" id="GameResult"></a></b><span class="innerHeaderItem" id="GameTermination"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><a class="innerHeaderItem" id="GameLiveStatus" href="javascript:void(0);" onclick="refreshPgnSource();"></a><span class="innerHeaderItem" id="GameLiveStatusDemo" title="this is a simulation of the live broadcast functionality"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItemNoMargin notranslate" id="GameTablebaseProbe" onmouseout="showProbeTablebaseResults();" title="endgame tablebase assessment"></span><span class="innerHeaderItem analysisMove move notranslate" id="GameAnalysisMove"></span><a href="javascript:void(0);" onclick="showExtraAnalysisInfo();" onmouseout="hideExtraAnalysisInfo();" class="innerHeaderItem analysisEval" id="GameAnalysisEval" title="position's evaluation from the analysis engine"></a><a href="javascript:void(0);" onclick="goToMissingAnalysis();" class="innerHeaderItem move analysisPv notranslate" id="GameAnalysisPv" title="principal variation from the analysis engine"></a><b>&nbsp;</b></div>
<div class="headerItem headerSpacer" id="GameAnnotationMeasure"><b>&nbsp;</b></div>
<canvas class="gameAnnotationGraph" id="GameAnnotationGraph" height="1" width="1" onclick="annotationGraphClick();" onmousemove="annotationGraphMousemove();" onmouseover="annotationGraphMouseover();" onmouseout="annotationGraphMouseout();" title="annotation graph from the analysis engine"></canvas>
</div>

</div>

<div class="toggleAnalysis" id="toggleAnalysis"><a class="toggleTablebaseLink" id="toggleTablebaseLink" href="javascript:void(0);" onclick="toggleProbeTablebase();" title="probe endgame tablebase"></a><a class="toggleAnalysisLink" id="toggleAnalysisLink" href="javascript:void(0);" onclick="userToggleAnalysis();" title="toggle analysis engine">+</a></div>
<div class="toggleComments" id="toggleComments"><a class="toggleCommentsLink" id="toggleCommentsLink" href="javascript:void(0);" onClick="SetCommentsIntoMoveText(!commentsIntoMoveText); var oldPly = CurrentPly; var oldVar = CurrentVar; Init(); GoToMove(oldPly, oldVar);" title="toggle show comments in game text for this page; click square F7 instead to save setting"></a></div>

<div class="lastMoveAndComment" id="lastMoveAndComment">
<div class="lastMoveAndVariations">
<span class="lastMove" id="GameLastMove" title="last move"></span>
<span class="lastVariations" id="GameLastVariations" title="last move alternatives"></span>&nbsp;
</div>
<div class="nextMoveAndVariations">
<span class="nextVariations" id="GameNextVariations" title="next move alternatives"></span>&nbsp;
<span class="nextMove" id="GameNextMove" title="next move"></span><a class="nextButton" href="javascript:void(0);" onclick="GoToMove(event.shiftKey ? StartPlyVar[CurrentVar] : CurrentPly - 1);" title="move backward">&lt;</a>
</div>
<div>&nbsp;</div>
<div class="lastComment" title="current position comment" id="GameLastComment"></div>
</div>

<div id="moveText" class="moveText"><span id="GameText"></span> <span class="move" id="ResultAtGametextEnd"></span></div>

<a class="positionLink" name="bottom" href="javascript:void(0);" onclick="goToHash('')" onfocus="this.blur();">&nbsp;</a>

</div>

<script type="text/javascript">

   var analysisStarted = false;
   function toggleAnalysis() {
      if (analysisStarted) { stopAnalysis(true); }
      else { restartAnalysis(); }
   }

   function restartAnalysis() {
      chrome.extension.sendRequest({analysisCommand: 'analysis', FEN: CurrentFEN()}, function(res){});
      analysisStarted = true;
      if (theObj = document.getElementById("toggleAnalysisLink")) { theObj.innerHTML = "&times;"; }
      updateAnnotationGraph();
      updateAnalysisHeader();
      showProbeTablebaseResults();
   }

   function stopAnalysis(notifyBackgroundPage) {
      if (notifyBackgroundPage) { chrome.extension.sendRequest({analysisCommand: 'stop', FEN: ""}, function(res){}); }
      analysisStarted = false;
      if (theObj = document.getElementById("toggleAnalysisLink")) { theObj.innerHTML = "+"; }
      clearAnnotationGraph();
      clearAnalysisHeader();
      showProbeTablebaseResults();
   }

   window.onunload = function() {
      if (analysisStarted) { stopAnalysis(true); }
      if (backgroundPage) { backgroundPage.saveAnalysisToLocalStorage(); }
   };

   chrome.extension.onRequest.addListener(analysisOutputHandler);

   function analysisOutputHandler(request, sender, sendResponse) {
      if (typeof(request.analysisNotification) != "undefined") {
         switch (request.analysisNotification) {
            case "newData":
               updateAnnotationGraph();
               updateAnalysisHeader();
               break;
            case "stopped":
               stopAnalysis(false);
               break;
            default:
               break;
         }
         sendResponse({});
      }
   }

   var fenPositions;
   resetFenPositions(-1);

   function resetFenPositions(annGame) {
      if (annGame == -1) { fenPositions = new Array(); }
      else { fenPositions[annGame] = new Array(); }
   }

   var annotationBarWidth;
   function updateAnnotationGraph() {
      var index;
      if (!analysisStarted) { clearAnnotationGraph(); }
      else if (theObj = document.getElementById("GameAnnotationGraph")) {
         annEval = new Array();
         for (annPly = StartPly; annPly <= StartPly+PlyNumber; annPly++) {
            annEval[annPly] = annPly === CurrentPly ? 0 : null;
            if (backgroundPage && (typeof(fenPositions[currentGame]) != "undefined") && (typeof(fenPositions[currentGame][annPly]) != "undefined")) {
               index = backgroundPage.getAnalysisIndexFromFEN(fenPositions[currentGame][annPly]);
               if (index != -1) { annEval[annPly] = backgroundPage.getAnalysisEvFromIndex(index); }
            }
            if (annEval[annPly] !== null) { annEval[annPly] = annEval[annPly] < 0 ? -1 + Math.pow(2, annEval[annPly]) : 1 - Math.pow(2, -annEval[annPly]); }
         }

         theObj.width = canvasWidth = graphCanvasWidth();
         theObj.height = canvasHeight = graphCanvasHeight();

         annotationPlyBlock = 20;
         annotationBarWidth = canvasWidth / (Math.ceil((PlyNumberMax + 2) / annotationPlyBlock) * annotationPlyBlock);
         barOverlap = Math.ceil(annotationBarWidth / 20);
         lineHeight = Math.ceil(canvasHeight / 80);
         lineTop = Math.floor((canvasHeight - lineHeight) / 2);
         lineBottom = lineTop + lineHeight;
         maxBarHeight = lineTop + barOverlap;

         context = theObj.getContext("2d");
         context.beginPath();
         thisBarTopLeftX = 0;
         thisBarHeight = lineHeight;
         thisBarTopLeftY = lineTop;
         context.rect(thisBarTopLeftX, thisBarTopLeftY, (PlyNumber + 1) * annotationBarWidth + barOverlap, thisBarHeight);
         context.fillStyle = "#D9D9D9";
         context.fill();
         context.fillStyle = "#666666";
         highlightTopLeftX = highlightTopLeftY = highlightBarHeight = null;
         for (annPly = StartPly; annPly <= StartPly + PlyNumber; annPly++) {
            if ((annEval[annPly] !== null) || (annPly === CurrentPly)) {
               thisBarTopLeftX = (annPly - StartPly) * annotationBarWidth;
               if (annEval[annPly] >= 0) {
                  thisBarHeight = Math.max(  annEval[annPly] * maxBarHeight, lineHeight);
                  thisBarTopLeftY = lineBottom - thisBarHeight;
               } else {
                  thisBarHeight = Math.max(- annEval[annPly] * maxBarHeight, lineHeight);
                  thisBarTopLeftY = lineTop;
               }
               if (annPly !== CurrentPly) {
                  context.beginPath();
                  context.rect(thisBarTopLeftX, thisBarTopLeftY, annotationBarWidth + barOverlap, thisBarHeight);
                  context.fill();
               } else {
                  highlightTopLeftX = thisBarTopLeftX;
                  highlightTopLeftY = thisBarTopLeftY;
                  highlightBarHeight = thisBarHeight;
               }
            }
         }
         if (highlightBarHeight !== null) {
            context.beginPath();
            context.rect(highlightTopLeftX, highlightTopLeftY, annotationBarWidth + barOverlap, highlightBarHeight);
            context.fillStyle = "#FF6633";
            context.fill();
         }
      }
   }

   function clearAnnotationGraph() {
      if (theObj = document.getElementById("GameAnnotationGraph")) {
         context = theObj.getContext("2d");
         theObj.width = graphCanvasWidth();
         theObj.height = graphCanvasHeight();
         context.clearRect(0, 0, theObj.width, theObj.height);
      }
   }

   // set canvas size, check calculations if headerItem and headerSpacer are changed in chess-games-viewer.css
   function graphCanvasWidth() {
      if (theMeasureObject = document.getElementById("GameAnnotationMeasure")) {
         return (theMeasureObject.offsetWidth - theMeasureObject.offsetHeight * 1.25 / 0.7);
      } else { return 300; }
   }
   function graphCanvasHeight() {
      if (theMeasureObject = document.getElementById("GameAnnotationMeasure")) {
         return (theObj.height = 7 * theMeasureObject.offsetHeight);
      } else { return 100; }
   }

   function updateAnalysisHeader() {
      if (freezeAnalysisHeader) { return; }
      if (!analysisStarted) { clearAnalysisHeader(); return; }

      annPly = (lastMousemoveAnnPly == -1) ? CurrentPly : lastMousemoveAnnPly;

      if (theObj = document.getElementById("GameAnalysisMove")) {
         if ((annPly > StartPly) && (annPly <= StartPly + PlyNumber)) {
            annMove = (Math.floor(annPly / 2) + (annPly % 2)) + (annPly % 2 ? ". " : "... ") + Moves[annPly - 1];
         } else {
            annMove = "&middot;";
         }
         theObj.innerHTML = annMove;
      }

      annEval = (lastMousemoveAnnPly == -1) ? "&middot;" : "";
      annPv = "";
      if (backgroundPage && (typeof(fenPositions[currentGame]) != "undefined") && (typeof(fenPositions[currentGame][annPly]) != "undefined")) {
         var index = backgroundPage.getAnalysisIndexFromFEN(fenPositions[currentGame][annPly]);
         if (index != -1) {
            annEval = backgroundPage.getAnalysisEvFromIndex(index);
            annPv = backgroundPage.getAnalysisPvFromIndex(index);
         }
      }

      if (theObj = document.getElementById("GameAnalysisEval")) {
         theObj.innerHTML = (annEval || annEval === 0) ? annEvalNag(annEval) : "";
      }
      if (theObj = document.getElementById("GameAnalysisPv")) {
         theObj.innerHTML = (annPv ? ((annPv != "#") ? (NAG[140] + " " + annPv) : annPv) : "");
      }
   }

   function annEvalNag(ev) {
     if ((ev === null) || (ev === "") || (isNaN(ev = parseFloat(ev)))) { return ""; }
     if (ev < -3.95) { return NAG[19]; } // -+
     if (ev >  3.95) { return NAG[18]; } // +-
     if (ev < -1.35) { return NAG[17]; } // -/+
     if (ev >  1.35) { return NAG[16]; } // +/-
     if (ev < -0.35) { return NAG[15]; } // =/+
     if (ev >  0.35) { return NAG[14]; } // +/=
     return NAG[11];                     // =
   }

   function clearAnalysisHeader() {
      if (freezeAnalysisHeader) { return; }
      if (theObj = document.getElementById("GameAnalysisMove")) { theObj.innerHTML = ""; }
      if (theObj = document.getElementById("GameAnalysisEval")) { theObj.innerHTML = ""; }
      if (theObj = document.getElementById("GameAnalysisPv")) { theObj.innerHTML = ""; }
   }


   lastMousemoveAnnPly = -1;
   lastMousemoveAnnGame = -1;

   function annotationGraphMouseover() {
      showProbeTablebaseResults();
   }

   function annotationGraphMouseout() {
      if (theObj = document.getElementById("GameAnalysisMove")) { theObj.style.display = ""; }
      if (theObj = document.getElementById("GameAnalysisEval")) { theObj.style.fontWeight = ""; }
      lastMousemoveAnnPly = -1;
      lastMousemoveAnnGame = -1;
      if (analysisStarted) { updateAnalysisHeader(); }
   }

   function annotationGraphMousemove() {
      newMousemoveAnnPly = StartPly + Math.floor((window.event.pageX - document.getElementById("GameAnnotationGraph").offsetLeft) / annotationBarWidth);
      if ((newMousemoveAnnPly !== lastMousemoveAnnPly) || (currentGame !== lastMousemoveAnnGame)) {
         lastMousemoveAnnPly = newMousemoveAnnPly <= StartPly + PlyNumber ? newMousemoveAnnPly : -1;
         lastMousemoveAnnGame = currentGame;
         onGraph = ((lastMousemoveAnnPly >= StartPly) && (lastMousemoveAnnPly <= StartPly + PlyNumber));
         if (theObj = document.getElementById("GameAnalysisMove")) { theObj.style.display = onGraph ? "inline-block" : ""; }
         if (theObj = document.getElementById("GameAnalysisEval")) { theObj.style.fontWeight = onGraph ? "normal" : ""; }
         if (analysisStarted) { updateAnalysisHeader(); }
      }
   }

   function annotationGraphClick() {
      if ((analysisStarted) && (typeof(annotationBarWidth) != "undefined")) {
         annPly = StartPly + Math.floor((window.event.pageX - document.getElementById("GameAnnotationGraph").offsetLeft) / annotationBarWidth);
         if ((annPly >= StartPly) && (annPly <= StartPly + PlyNumber)) {
            if (event.shiftKey) { if (backgroundPage) { backgroundPage.saveAnalysisToLocalStorage(); } }
            else { GoToMove(annPly); }
         }
      }
   }

   var freezeAnalysisHeader = false;
   function showExtraAnalysisInfo() {
      if ((backgroundPage) && (theObj = document.getElementById("GameAnalysisPv"))) {
         freezeAnalysisHeader = true;
         var index = backgroundPage.getAnalysisIndexFromFEN(fenPositions[currentGame][CurrentPly]);
         theObj.innerHTML = "<span class='analysisExtraInfo'>" + (index != -1 ? "eval " + backgroundPage.getAnalysisEvFromIndex(index) + "<span class='move'>p</span>": "&middot;") + "<span style='margin-left:2em;'>nps &le; " + num2string(backgroundPage.getAnalysisMaxNodesPerSecond()) + "</span></span>";
         if (theObj = document.getElementById("GameAnalysisEval")) { theObj.style.color = "transparent"; }
      }
   }

   function hideExtraAnalysisInfo() {
      if (freezeAnalysisHeader) {
         freezeAnalysisHeader = false;
         if (theObj = document.getElementById("GameAnalysisEval")) { theObj.style.color = ""; }
         updateAnalysisHeader();
      }
   }

   function num2string(num) {
      if (num >= Math.pow(10, 9)) { num = Math.floor(num / Math.pow(10, 9)) + "G"; }
      else if (num >= Math.pow(10, 6)) { num = Math.floor(num / Math.pow(10, 6)) + "M"; }
      else if (num >= Math.pow(10, 3)) { num = Math.floor(num / Math.pow(10, 3)) + "K"; }
      else { num = num + ""; }
      return num;
   }


   annotateInProgress = false;
   minAnnotationDelay = minAutoplayDelay;
   maxAnnotationDelay = maxAutoplayDelay;
   annotationDelayDefault = 15;
   function annotateGame() {
      if ((checkEngineUnderstandsGameAndWarn()) && (annotationDelay = prompt("Automatic game annotation from the current position, please do not interact with the chessboard until the analysis has reached the last available move.\n\nEnter engine's time per move, in seconds, between " + (minAnnotationDelay/1000) + " and " + (maxAnnotationDelay/1000) + ":", annotationDelayDefault))) {
         if (isNaN(annotationDelay = parseInt(annotationDelay, 10))) { annotationDelay = annotationDelayDefault; }
         else { annotationDelay = annotationDelay * 1000; }
         annotationDelay = Math.min(maxAnnotationDelay, Math.max(minAnnotationDelay, annotationDelay));
         SetAutoPlay(false);
         if (!analysisStarted) {
           scanGameForFen();
           toggleAnalysis();
         }
         SetAutoplayDelay(annotationDelay);
         SetAutoPlay(true);
         annotateInProgress = true;
      }
   }

   function engineUnderstandsGame(gameNum) {
      return gameIsNormalChess(gameNum);
   }

   function checkEngineUnderstandsGameAndWarn() {
      retVal = engineUnderstandsGame(currentGame);
      if (!retVal) { alert("warning: analysis engine not available for chess variants"); }
      return retVal;
   }

   function userToggleAnalysis() {
      if (checkEngineUnderstandsGameAndWarn()) {
         if (!analysisStarted) { scanGameForFen(); }
         toggleAnalysis();
      }
   }

   function scanGameForFen() {
      savedCurrentPly = CurrentPly;
      savedCurrentVar = CurrentVar;
      if (wasAutoPlayOn = isAutoPlayOn) { SetAutoPlay(false); }
      MoveForward(StartPly + PlyNumber - savedCurrentPly, CurrentVar, true);
      resetFenPositions(currentGame);
      while (true) {
         fenPositions[currentGame][CurrentPly] = CurrentFEN();
         if (CurrentPly === StartPly) { break; }
         MoveBackward(1, true);
      }
      MoveForward(savedCurrentPly - StartPly, savedCurrentVar, true);
      updateAnnotationGraph();
      updateAnalysisHeader();
      if (wasAutoPlayOn) { SetAutoPlay(true); }
   }

   function goToMissingAnalysis(forward) {
      if ((!backgroundPage) || (!analysisStarted)) { return; }
      if ((typeof(fenPositions[currentGame]) == "undefined") || (typeof(fenPositions[currentGame][CurrentPly]) == "undefined")) { return; }
      if (backgroundPage.getAnalysisIndexFromFEN(fenPositions[currentGame][CurrentPly]) == -1) { return; }

      if (typeof(forward) == "undefined") {
         forward = ((typeof(event) != "undefined") && (typeof(event.shiftKey) != "undefined")) ? !event.shiftKey : true;
      }
      if (wasAutoPlayOn = isAutoPlayOn) { SetAutoPlay(false); }
      for (var thisPly = CurrentPly + (forward ? 1 : -1); ; thisPly = thisPly + (forward ? 1 : -1)) {
         if (forward) { if (thisPly > StartPly + PlyNumber) { thisPly = StartPly; } }
         else { if (thisPly < StartPly) { thisPly = StartPly + PlyNumber; } }
         if (thisPly === CurrentPly) { break; }
         if ((typeof(fenPositions[currentGame]) == "undefined") || (typeof(fenPositions[currentGame][thisPly]) == "undefined")) { break; }
         if (backgroundPage.getAnalysisIndexFromFEN(fenPositions[currentGame][thisPly]) == -1) { GoToMove(thisPly); break; }
      }
      if (wasAutoPlayOn) { SetAutoPlay(true); }
   }


   // A7
   if (backgroundPage && (typeof(backgroundPage.showAboutPage)) != "undefined") { boardShortcut("A7", "chess games viewer extension help", function(t,e){ setTimeout("backgroundPage.showAboutPage();", 99); }); }
   // D7
   boardShortcut("D7", "toggle highlight last move and save setting", function(t,e){ SetHighlight(!highlightOption); setHighlightOptionToLocalStorage(); });
   // F7
   boardShortcut("F7", "toggle show comments in game text and save setting", function(t,e){ if (e.shiftKey) { SetCommentsOnSeparateLines(!commentsOnSeparateLines); } else { SetCommentsIntoMoveText(!commentsIntoMoveText); } oldPly = CurrentPly; Init(); GoToMove(oldPly); if (e.shiftKey) { setCommentsOnSeparateLinesToLocalStorage(); } else { setCommentsIntoMoveTextToLocalStorage(); } });
   // F5
   boardShortcut("F5", "show the chess puzzler of the day", function(t,e){ showPuzzler(); });
   // G5
   boardShortcut("G5", "adjust last move and current comment text area, if present", function(t,e){ toggleFitResetLastCommentArea(); });
   // E2
   boardShortcut("E2", "autoplay custom delay", function(t,e){ setCustomAutoplayDelay(); });
   // F2
   boardShortcut("F2", "probe endgame tablebase", function(t,e){ toggleProbeTablebase(); });
   // G2
   boardShortcut("G2", "annotate game", function(t,e){ annotateGame(); });
   // H2
   boardShortcut("H2", "toggle analysis engine", function(t,e){ userToggleAnalysis(); });


   function openPgnFiles() {
      if (theObj = document.getElementById("localPgnFiles")) { theObj.click(); }
   }

   function fetchNewMosaicPgnUrl() {
      newPgnUrl = prompt("Enter PGN chess games URL for viewing on multiple boards with live refresh:", pgnData);
      if (newPgnUrl && newPgnUrl.replace(/^\s*/, "")) {
         if ((newPgnUrl === pgnData) && (newPgnUrl === pgnUrl) && (LiveBroadcastDelay > 0) && (!newPgnUrl.match(/\.zip(\?|#|$)/i))) {
            switchBoardView();
         } else {
            location.href = "live-mosaic-viewer.html?pgnData=" + escape(newPgnUrl) + "&refreshMinutes=1&hp=t";
         }
      }
   }

   function fetchNewPgnUrl(live) {
      newPgnUrl = prompt("Enter PGN chess games URL for viewing on a single board" + (live ? " with live refresh:" : ":"), pgnData);
      if (newPgnUrl && newPgnUrl.replace(/^\s*/, "")) {
         if (pgnData.indexOf(puzzlerUrl) != -1) { live = false; } // assume the puzzler URL is not a live broadcast
         if (live) { newRefreshMinutes = inputRefreshMinutes ? inputRefreshMinutes : 1 + 0.01 * Math.floor(Math.random()*10); }
         else { newRefreshMinutes = 0; }
         alertFlag = demoFlag = false;
         gameDemoMaxPly = new Array();
         searchGame = "";
         resetFenPositions(-1);
         useNewPgnUrl(newPgnUrl, newRefreshMinutes);
      }
   }

   function useNewPgnUrl(newPgnUrl, newRefreshMinutes) {
      refreshMinutes = newRefreshMinutes;
      SetPgnUrl(pgnData = newPgnUrl);

      // force the page action on the chessboard page, for backward compatibility  with chrome before version 17
      // see README.txt note about http://crbug.com/60101
      try {
         if (typeof(chrome.webRequest) == "undefined") {
            chrome.tabs.getCurrent( function(tab) { backgroundPage.checkWebRequestForPgnFiles({ "tabId": tab.id, url: newPgnUrl }); });
         }
      } catch (e) {}

      // special mode for the about.html page of the chess games viewer extension for google chrome
      if ((typeof(chrome) != "undefined") && (typeof(chrome.extension) != "undefined") && (typeof(chrome.extension.getURL) != "undefined") && (pgnData == chrome.extension.getURL("demoLiveGames.pgn")) && (refreshMinutes)) {
         refreshMinutes = 0.1;
         alertFlag = demoFlag = true;
         if ((!gameDemoMaxPly) || (gameDemoMaxPly.length === 0)) { gameDemoMaxPly = new Array(1, 2, 3, 4); }
      }

      SetLiveBroadcast(refreshMinutes, alertFlag, demoFlag, stepFlag);
      setInitialGameFromSearchGame();
      SetAutoplayDelay(2000);
      SetInitialVariation(0);
      SetInitialHalfmove(refreshMinutes ? "end" : "start", true);
      firstStart = true;
      if (theObj = document.getElementById("pgnText")) { theObj.value = ""; }
      if (theObj = document.getElementById("GameLiveStatus")) { theObj.innerHTML = ""; }
      if (theObj = document.getElementById("localPgnFiles")) { theObj.value = ""; }
      LiveBroadcastStarted = false;
      LiveBroadcastEnded = false;
      LiveBroadcastPaused = false;
      LiveBroadcastTicker = 0;
      LiveBroadcastStatusString = "";
      LiveBroadcastLastModified_Reset();
      LiveBroadcastLastReceivedLocal_Reset();
      liveBroadcastUpdateTicker = 1;
      start_pgn4web();
   }

   function handleFileSelect(evt) {
      evt.stopPropagation();
      evt.preventDefault();

      var files = new Array();
      if (evt.target.files) { files = evt.target.files; }
      else if (evt.dataTransfer.files) { files = evt.dataTransfer.files; }

      readLocalPgnFiles(files);

      if (theObj = document.getElementById("localPgnFiles")) { theObj.value = ""; }
   }

   function handleDragOver(evt) {
      evt.stopPropagation();
      evt.preventDefault();
   }

   if (theObj = document.getElementById("localPgnFiles")) {
      theObj.addEventListener("change", handleFileSelect, false);
   }

   if (theObj = document.getElementById("html")) {
      theObj.addEventListener("dragover", handleDragOver, false);
      theObj.addEventListener("drop", handleFileSelect, false);
   }


   function readLocalPgnFiles(files) {
      var newPgnText;
      var pgnFilesLeft;
      var invalidFiles;
      var validFiles;
      var errorFiles;

      newPgnText = "";
      pgnFilesLeft = files.length;
      invalidFiles = new Array();
      validFiles = new Array();
      errorFiles = new Array();
      for (f=0; f<files.length; f++) {
         if (files[f].name.match(/\.(pgn|zip)$/i)) {
            var reader = new FileReader();
            reader.onload = (function(theFileName) {
               return function(e) {
                  if (e.target.result) {
                     if (theFileName.match(/\.(pgn)$/i)) {
                        newPgnText += e.target.result + "\n\n\n";
                        validFiles.push(theFileName);
                     } else if (theFileName.match(/\.(zip)$/i)) {
                        var unzippedPgnText = "";
                        var unzippingError = false;
                        try {
                           var unzipper = new JSUnzip(e.target.result);
                           if (unzipper.isZipFile()) {
                              unzipper.readEntries();
                              for (u in unzipper.entries) {
                                 if (unzipper.entries[u].fileName.match(/\.pgn$/i)) {
                                    switch (unzipper.entries[u].compressionMethod) {
                                       case 0:
                                          unzippedPgnText += "\n" + unzipper.entries[u].data + "\n";
                                          break;
                                       case 8:
                                          unzippedPgnText += "\n" + JSInflate.inflate(unzipper.entries[u].data) + "\n";
                                          break;
                                       default:
                                          // unsupported compression method
                                          break;
                                    }
                                 }
                              }
                           }
                        } catch (e) { unzippingError = true; }
                        if (unzippedPgnText) {
                           newPgnText += unzippedPgnText + "\n\n\n";
                        }
                        if (unzippingError) {
                           errorFiles.push(theFileName);
                        } else {
                           validFiles.push(theFileName);
                        }
                     } else {
                        errorFiles.push(theFileName);
                     }
                  } else {
                     errorFiles.push(theFileName);
                  }
                  if (!--pgnFilesLeft) { useNewPgnTextFromFiles(newPgnText, validFiles, invalidFiles, errorFiles); }
               };
            })(files[f].name);
            reader.onerror = (function(theFileName) {
               return function(e) {
                  errorFiles.push(theFileName);
                  if (!--pgnFilesLeft) { useNewPgnTextFromFiles(newPgnText, validFiles, invalidFiles, errorFiles); }
               };
            })(files[f].name);
            if (files[f].name.match(/\.(zip)$/i)) { reader.readAsBinaryString(files[f]); }
            else { reader.readAsText(files[f]); }
         } else {
            invalidFiles.push(files[f].name);
            if (!--pgnFilesLeft) { useNewPgnTextFromFiles(newPgnText, validFiles, invalidFiles, errorFiles); }
         }
      }
   }

   function useNewPgnTextFromFiles(newPgnText, validFiles, invalidFiles, errorFiles) {
      if (noNewPgnText = !newPgnText) { newPgnText = alertPgnHeader; }
      useNewPgnText(newPgnText);
      allRejectedFiles = invalidFiles.concat(errorFiles).sort();
      if (allRejectedFiles.length) {
         msg = (noNewPgnText ? "error" : "warning");
         msg += ": failed reading PGN games from ";
         msg += (allRejectedFiles.length) + " local ";
         msg += (allRejectedFiles.length == 1 ? "file" : "files");
         for (f in allRejectedFiles) { msg += "\n" + allRejectedFiles[f]; }
         myAlert(msg, noNewPgnText);
      }
   }

   function useNewPgnText(newPgnText) {
      SetPgnUrl(pgnData = "");
      SetLiveBroadcast(0, true, false, false);
      SetAutoplayDelay(2000);
      setInitialGameFromSearchGame();
      SetInitialVariation(0);
      SetInitialHalfmove(0, true);
      firstStart = true;
      if (theObj = document.getElementById("pgnText")) { theObj.value = newPgnText; }
      if (theObj = document.getElementById("GameLiveStatus")) { theObj.innerHTML = ""; }
      if (theObj = document.getElementById("localPgnFiles")) { theObj.value = ""; }
      resetFenPositions(-1);
      start_pgn4web();
   }

   function fetchInputPgnText() {
      if ((inputPgnText = prompt("Enter PGN chess games TEXT for viewing on a single board; pasting multi-line PGN data in the textbox is allowed:", "")) !== null) {
         if (inputPgnText.match(/^([\r\n\s]*([1-8rnbkpqRNBKPQ]{1,8}\/){7}[1-8rnbkpqRNBKPQ]{1,8}(\s+[wb]\s+([A-Ha-hKQkq]{1,4}|-)\s+([a-h][36]|-)\s+[\d]+\s+[\d]+){0,1})+[\r\n\s]*$/)) {
            inputPgnText = inputPgnText.replace(/(([1-8rnbkpqRNBKPQ]{1,8}\/){7}[1-8rnbkpqRNBKPQ]{1,8}(\s+[wb]\s+([A-Ha-hKQkq]{1,4}|-)\s+([a-h][36]|-)\s+[\d]+\s+[\d]+){0,1})/g, '[FEN "$1"]\n*\n');
         }
         pgnHeaderRegExpGlobal = /((\[\s*(\w+)\s*"([^"]*)"\s*\]\s*)+)/g;
         inputPgnText = inputPgnText.replace(pgnHeaderRegExpGlobal, "\n$1\n"); // add newline after header section
         inputPgnText = fixCommonPgnMistakes(inputPgnText);
         useNewPgnText(inputPgnText);
      }
   }

   var localPgnFiles;
   var localPgnFilesCount;
   function processLocalPgnFilesIndex() {
      if (backgroundPage && (pgnLocalfilesindex !== null)) {
         localPgnFiles = new Array();
         localPgnFilesCount = 0;
         if (backgroundPage.localPgnFiles[pgnLocalfilesindex]) {
            for (f in backgroundPage.localPgnFiles[pgnLocalfilesindex]) {
               backgroundPage.localPgnFiles[pgnLocalfilesindex][f].filesystem.root.getFile(backgroundPage.localPgnFiles[pgnLocalfilesindex][f].fullPath, {}, function(thisFile){ thisFile.file(function(oneFile){ localPgnFiles.push(oneFile); processLocalPgnFiles(); }); }, function(e){ processLocalPgnFiles(); });
            }
         } else { localPgnFilesError(false); }
      }
   }

   function processLocalPgnFiles() {
      if (backgroundPage && (pgnLocalfilesindex !== null)) {
         if (++localPgnFilesCount === backgroundPage.localPgnFiles[pgnLocalfilesindex].length) {
            if (localPgnFiles && localPgnFiles.length > 0) { readLocalPgnFiles(localPgnFiles); }
            else { localPgnFilesError(localPgnFilesCount > 1); }
         }
      }
   }

   function localPgnFilesError(multierror) {
      useNewPgnText(alertPgnHeader);
      myAlert("error: failed reading input " + (multierror ? "files" : "file"), true);
   }

</script>

</body>

</html>
