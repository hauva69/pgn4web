<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2010 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<!-- 

HTML, CSS and Javascript code optimized for use as extension 
of Google Chrome v6 or later. Don't use with any other browser.

-->

<head>

<title>chess games viewer</title>

<link href="chess-games-viewer.css" type="text/css" rel="stylesheet" />

<!-- not needed within a google chrome extension
<link rel="shortcut icon" href="pawn.ico" />
-->

<script src="pgn4web.js" type="text/javascript"></script>

</head>

<body>

<!-- paste your PGN below and make sure you dont specify an external source with SetPgnUrl() -->
<form style="display: none;"><textarea style="display: none;" id="pgnText">

</textarea></form>
<!-- paste your PGN above and make sure you dont specify an external source with SetPgnUrl() -->

<script type="text/javascript">

   if ((chrome) && (chrome.extension) && (chrome.extension.getBackgroundPage)) {
      var backgroundPage = chrome.extension.getBackgroundPage();
   }

   thisRegExp = /(&|\?)(help|h)([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      alert("pgn4web collection.html parameters" + "\n" +
            " - pgnBackground=index" + "\n" +
            " - pgnData=URL.pgn" + "\n" +
            " - search=search expression" + "\n" +
            " - refreshMinutes=live broadcast delay (default 0 = live broadcast disabled)" + "\n" +
            " - refreshDemo= if set true sets live demo mode (default false)" + "\n" +
            " - help");
   }

   function setPgnTextIndexFromTabId(tab) {
      if ((backgroundPage.pgnTextIndexFromTabId[tab.id] !== null) && (backgroundPage.pgnTextIndexFromTabId[tab.id] !== undefined) && (backgroundPage.pgnTextIndexFromTabId[tab.id] !== pgnBackground)) {
         backgroundPage.removePgnTextOnRemoved(tab.id);
      }
      backgroundPage.pgnTextIndexFromTabId[tab.id] = pgnBackground;
      theObject = document.getElementById("pgnText");
      if ((theObject) && (theObject.value) && (theObject.value != backgroundPage.pgnText[pgnBackground]))
      { backgroundPage.pgnText[pgnBackground] = theObject.value; }
   }

   pgnBackground = null;
   thisRegExp = /(&|\?)(pgnBackground|pb)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      if ((pgnBackground = unescape(window.location.search.match(thisRegExp)[3])) !== ""); {
         theObject = document.getElementById("pgnText");
         theBackgroundPgnText = backgroundPage.pgnText[pgnBackground];
         if ((theObject) && (theBackgroundPgnText) && (theBackgroundPgnText !== undefined)) 
         { theObject.value = theBackgroundPgnText; }
         chrome.tabs.getCurrent(setPgnTextIndexFromTabId);
      }
   } 

   pgnData = "";
   thisRegExp = /(&|\?)(pgnData|pd)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      pgnData = unescape(window.location.search.match(thisRegExp)[3]);
   } 
   if (pgnData) {
      SetPgnUrl(pgnData); // if set, this has precedence over the inline PGN in the HTML file
   }

   SetImagePath("alpha/36"); // use "" path if images are in the same folder as this javascript file
   SetImageType("png");
   SetHighlightOption(true); // true or false
   SetGameSelectorOptions(null, true, 12, 12, 2, 15, 15, 3, 10); // (head, num, chEvent, chSite, chRound, chWhite, chBlack, chResult, chDate);   
   SetCommentsIntoMoveText(true);
   SetCommentsOnSeparateLines(false);
   SetAutoplayDelay(2000); // milliseconds
   SetAutostartAutoplay(false);
   SetAutoplayNextGame(false); // if set, move to the next game at the end of the current game during autoplay
   SetInitialHalfmove(0, true); // halfmove number to be shown at load, 0 for start position, -1 for random halfmove
   SetShortcutKeysEnabled(true);

   thisRegExp = /(&|\?)(search|s)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      SetInitialGame(unescape(window.location.search.match(thisRegExp)[3]));
   } else {
      SetInitialGame(1); // number of game to be shown at load, from 1 (default); values (keep the quotes) of "first", "last", "random" are accepted; other string values assumed as PGN search string
   }

   alertFlag = demoFlag = false;
   thisRegExp = /(&|\?)(refreshDemo|rd)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      refreshDemo = unescape(window.location.search.match(thisRegExp)[3]);
      if ((refreshDemo == "true") || (refreshDemo == "t")) { alertFlag = demoFlag = true; }
   }

   thisRegExp = /(&|\?)(refreshMinutes|rm)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      refreshMinutes = unescape(window.location.search.match(thisRegExp)[3]);
      SetInitialHalfmove("end", true); // halfmove number to be shown at load, 0 for start position, -1 for random halfmove
      SetLiveBroadcast(refreshMinutes, alertFlag, demoFlag); // set live broadcast; parameters are delay (refresh delay in minutes, 0 means no broadcast, default 0) alertFlag (if true, displays debug error messages, default false) demoFlag (if true starts broadcast demo mode, default false)
   }

   function fixHeaderTagClass(elementId) {
      theObject = document.getElementById(elementId);
      if (theObject) { theObject.className = (theObject.innerHTML === "") ? "innerHeaderItemNoMargin" : "innerHeaderItem"; }
   }

   function customPgnHeaderTagWithClass(tag, elementId) {
      customPgnHeaderTag(tag, elementId);
      fixHeaderTagClass(elementId);
   }

   function customFunctionOnMove() {
     if (CurrentPly == StartPly) {
       if (theObject = document.getElementById('GameLastMove')) {
         theObject.innerHTML = ((CurrentPly%2) ? "black" : "white") + " to move";
       }
     }
   }

   function customFunctionOnPgnGameLoad() {
      fixHeaderTagClass('GameDate');
      fixHeaderTagClass('GameSite');
      fixHeaderTagClass('GameEvent');
      customPgnHeaderTagWithClass('Section', 'GameSection');
      customPgnHeaderTagWithClass('Stage', 'GameStage');
      fixHeaderTagClass('GameRound');
      if (theObject = document.getElementById("GameRound")) {
         if (theObject.innerHTML) {
            theObject.innerHTML = "round " + theObject.innerHTML;
         }
      }
      customPgnHeaderTagWithClass('Board', 'GameBoardNum');
      if (theObject = document.getElementById("GameBoardNum")) {
         if (theObject.innerHTML) {
            theObject.innerHTML = "board " + theObject.innerHTML;
         }
      }
      fixHeaderTagClass('GameWhite');
      fixHeaderTagClass('GameBlack');
      customPgnHeaderTagWithClass('WhiteTitle', 'GameWhiteTitle');
      customPgnHeaderTagWithClass('BlackTitle', 'GameBlackTitle');
      customPgnHeaderTagWithClass('WhiteElo', 'GameWhiteElo');
      customPgnHeaderTagWithClass('BlackElo', 'GameBlackElo');
      customPgnHeaderTagWithClass('ECO', 'GameECO');
      customPgnHeaderTagWithClass('Opening', 'GameOpening');
      customPgnHeaderTagWithClass('Variation', 'GameVariation');
      customPgnHeaderTagWithClass('SubVariation', 'GameSubVariation');
      fixHeaderTagClass('GameResult');
      customPgnHeaderTagWithClass('Termination', 'GameTermination');
//      if (PlyNumber > 0) { customPgnHeaderTag('Result', 'ResultAtGametextEnd'); }
//      else { if (theObject = document.getElementById('ResultAtGametextEnd')) { theObject.innerHTML = ""; } }
      var lastDisplayStyle = "none";
      for(ii=StartPly; ii<StartPly+PlyNumber; ii++) {
        if (MoveComments[ii]) {
          lastDisplayStyle = "block";
          break;
        }
      }
      if (theObject = document.getElementById('lastMoveAndComment')) {
        theObject.style.display = lastDisplayStyle;
      }
   }

   function customFunctionOnPgnTextLoad() {
      if (LiveBroadcastStatusString) {
         document.title = LiveBroadcastStatusString.replace(" &nbsp;", ",");
      } else {
         if ((numberOfGames == 1) && (PlyNumber == 0) && (StartPly == 0) && (gameWhite[0] == "") && (gameBlack[0] == "") && (gameResult[0] == "")) {
            document.title = "PGN data error";
         } else {
            document.title = numberOfGames + " game" + (numberOfGames == 1 ? "" : "s");
         }
      }
   }

</script>

<div id="GameSelector"></div>
<div id="GameSearch"></div>

<a name="board"></a>

<div class="columnsContainer">

<div class="boardColumn">
<center>
<div id="GameBoard"></div>
<div id="GameButtons"></div>
</center>
</div>

<div class="headerColumn">
<div class="headerItem"><span class="innerHeaderItem" title="date" id="GameDate"></span><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" title="site" id="GameSite"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" title="event" id="GameEvent"></span><span class="innerHeaderItem" title="section" id="GameSection"></span><span class="innerHeaderItem" title="stage" id="GameStage"></span><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" title="round" id="GameRound"></span><span class="innerHeaderItem" title="board" id="GameBoardNum"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" title="eco" id="GameECO"></span><span class="innerHeaderItem" title="opening" id="GameOpening"></span><span class="innerHeaderItem" title="variation" id="GameVariation"></span><span class="innerHeaderItem" title="subvariation" id="GameSubVariation"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" title="white clock" id="GameWhiteClock"></span><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="#" class="innerHeaderItem" title="white player" id="GameWhite"></a></b><span class="innerHeaderItem" title="white title" id="GameWhiteTitle"></span><span class="innerHeaderItem" title="white elo" id="GameWhiteElo"></span><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="#board" class="innerHeaderItem" title="black player" id="GameBlack"></a></b><span class="innerHeaderItem" title="black title" id="GameBlackTitle"></span><span class="innerHeaderItem" title="black elo" id="GameBlackElo"></span><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" title="black clock" id="GameBlackClock"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="#bottom" class="innerHeaderItem" title="result" id="GameResult"></a></b><span class="innerHeaderItem" title="termination" id="GameTermination"></span><b>&nbsp;</b></div>
<div class="headerItem"><b>&nbsp;</b></div>
</div>

</div>

<div class="lastMoveAndComment" id="lastMoveAndComment"><a href="javascript:MoveToPrevComment();" class="lastMove" title="last move" id="GameLastMove"></a><a href="javascript:MoveToNextComment();" class="lastComment" title="current position comment" id="GameLastComment"></a></div>

<div class="moveText"><span id="GameText"></span> <span class="move" id="ResultAtGametextEnd"></span></div>

<div class="notes">
<div title="live broadcast status" style="float: left; text-align: left; margin-right: 20px; margin-bottom: 5px;" id="GameLiveStatus"></div>
<div><script type="text/javascript">
  if (pgnData) { document.write("<a title='chess games source URL' class='notesLink' href=" + pgnData + ">" + pgnData + "</a>"); }
  if (pgnBackground) { document.write("<span class='notesLink'>chess games from PGN text input</span>"); }
</script></div>
</div>

<a name="bottom"></a>

</body>

</html>
