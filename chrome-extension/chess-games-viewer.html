<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2011 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<!-- 

HTML, CSS and Javascript code optimized for use as extension 
of Google Chrome v6 or later. Don't use with any other browser.

-->

<head>

<title>chess games viewer</title>

<link href="chess-games-viewer.css" type="text/css" rel="stylesheet" />

<!-- not needed within a google chrome extension
<link rel="shortcut icon" href="pawn.ico" />
-->

<script src="pgn4web.js" type="text/javascript"></script>

</head>

<body onresize="fixCommentScrollbar();">

<!-- paste your PGN below and make sure you dont specify an external source with SetPgnUrl() -->
<form style="display: none;"><textarea style="display: none;" id="pgnText">

</textarea></form>
<!-- paste your PGN above and make sure you dont specify an external source with SetPgnUrl() -->

<script type="text/javascript">

   if ((chrome) && (chrome.extension) && (chrome.extension.getBackgroundPage)) {
      var backgroundPage = chrome.extension.getBackgroundPage();
   }

   thisRegExp = /(&|\?)(help|h)([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      alert("pgn4web collection.html parameters" + "\n" +
            " - pgnBackground=index" + "\n" +
            " - pgnData=URL.pgn" + "\n" +
            " - search=search expression" + "\n" +
            " - refreshMinutes=live broadcast delay (default 0 = live broadcast disabled)" + "\n" +
            " - refreshDemo= if set true sets live demo mode (default false)" + "\n" +
            " - help");
   }

   function setPgnTextIndexFromTabId(tab) {
      if ((backgroundPage.pgnTextIndexFromTabId[tab.id] !== null) && (backgroundPage.pgnTextIndexFromTabId[tab.id] !== undefined) && (backgroundPage.pgnTextIndexFromTabId[tab.id] !== pgnBackground)) {
         backgroundPage.removePgnTextOnRemoved(tab.id);
      }
      backgroundPage.pgnTextIndexFromTabId[tab.id] = pgnBackground;
      theObject = document.getElementById("pgnText");
      if ((theObject) && (theObject.value) && (theObject.value != backgroundPage.pgnText[pgnBackground]))
      { backgroundPage.pgnText[pgnBackground] = theObject.value; }
   }

   pgnBackground = null;
   thisRegExp = /(&|\?)(pgnBackground|pb)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      if ((pgnBackground = unescape(window.location.search.match(thisRegExp)[3])) !== "") {
         theObject = document.getElementById("pgnText");
         theBackgroundPgnText = backgroundPage.pgnText[pgnBackground];
         if ((theObject) && (theBackgroundPgnText) && (theBackgroundPgnText !== undefined)) 
         { theObject.value = theBackgroundPgnText; }
         chrome.tabs.getCurrent(setPgnTextIndexFromTabId);
      }
   } 

   pgnData = "";
   thisRegExp = /(&|\?)(pgnData|pd)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      pgnData = unescape(window.location.search.match(thisRegExp)[3]);
   } 
   if (pgnData) {
      SetPgnUrl(pgnData); // if set, this has precedence over the inline PGN in the HTML file
   }

   SetImagePath("alpha/36"); // use "" path if images are in the same folder as this javascript file
   SetImageType("png");
   SetHighlightOption(true); // true or false
   SetGameSelectorOptions(null, true, 12, 12, 2, 15, 15, 3, 10); // (head, num, chEvent, chSite, chRound, chWhite, chBlack, chResult, chDate);   
   SetCommentsIntoMoveText(true);
   SetCommentsOnSeparateLines(false);
   SetAutostartAutoplay(false);
   SetAutoplayNextGame(false); // if set, move to the next game at the end of the current game during autoplay
   SetShortcutKeysEnabled(true);

   thisRegExp = /(&|\?)(search|s)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      SetInitialGame(unescape(window.location.search.match(thisRegExp)[3]));
   } else {
      SetInitialGame(1); // number of game to be shown at load, from 1 (default); values (keep the quotes) of "first", "last", "random" are accepted; other string values assumed as PGN search string
   }

   alertFlag = demoFlag = false;
   thisRegExp = /(&|\?)(refreshDemo|rd)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      refreshDemo = unescape(window.location.search.match(thisRegExp)[3]);
      if ((refreshDemo == "true") || (refreshDemo == "t")) { alertFlag = demoFlag = true; }
   }

   stepFlag = true;
   thisRegExp = /(&|\?)(refreshMinutes|rm)=([^&]*)(&|$)/i;
   if (window.location.search.match(thisRegExp) !== null) {
      refreshMinutes = unescape(window.location.search.match(thisRegExp)[3]);
      SetLiveBroadcast(refreshMinutes, alertFlag, demoFlag, stepFlag); // set live broadcast; parameters are delay (refresh delay in minutes, 0 means no broadcast, default 0) alertFlag (if true, displays debug error messages, default false) demoFlag (if true starts broadcast demo mode, default false) stepFlag (if true, autoplays updates in steps, default false)
      SetAutoplayDelay(1000); // milliseconds
      SetInitialHalfmove("end", true); // halfmove number to be shown at load, 0 for start position, -1 for random halfmove
   } else {
      SetAutoplayDelay(2000); // milliseconds
      SetInitialHalfmove(0, true); // halfmove number to be shown at load, 0 for start position, -1 for random halfmove
   }

   function fixHeaderTag(elementId) {
      var headerId = ["GameEvent", "GameSite", "GameDate", "GameRound", "GameWhite", "GameBlack", "GameResult", "GameSection", "GameStage", "GameBoardNum", "Timecontrol", "GameWhiteTitle", "GameBlackTitle", "GameWhiteElo", "GameBlackElo", "GameECO", "GameOpening", "GameVariation", "GameSubVariation", "GameTermination", "GameWhiteClock", "GameBlackClock", "GameTimeControl"];
      var headerLabel = ["event", "site", "date", "round", "white player", "black player", "result", "section", "stage", "board", "time control", "white title", "black title", "white elo", "black elo", "eco", "opening", "variation", "subvariation", "termination", "white clock", "black clock", "time control"];
      theObject = document.getElementById(elementId);
      if (theObject) { 
        theObject.className = (theObject.innerHTML === "") ? "innerHeaderItemNoMargin" : "innerHeaderItem"; 
        theObject.title = (headerId.indexOf(elementId) < 0 ? elementId : headerLabel[headerId.indexOf(elementId)] ) + ": " + theObject.innerHTML;
      }
   }

   function customPgnHeaderTagWithFix(tag, elementId) {
      customPgnHeaderTag(tag, elementId);
      fixHeaderTag(elementId);
   }

   function fixCommentScrollbar() {
      if (theObject = document.getElementById('lastMoveAndComment')) {
         theObject.style.paddingRight = "1em";
         if (theObject.offsetWidth == theObject.clientWidth) { theObject.style.paddingRight = '0'; }
      }
   }

   function customFunctionOnMove() {
      wObject = document.getElementById('GameWhiteClock');
      bObject = document.getElementById('GameBlackClock');
      if (wObject && bObject) {
         if ((!wObject.innerHTML.match(/\S/)) && (bObject.innerHTML.match(/\S/))) { wObject.innerHTML = '-'; }
         if ((!bObject.innerHTML.match(/\S/)) && (wObject.innerHTML.match(/\S/))) { bObject.innerHTML = '-'; }
      }
      fixHeaderTag('GameWhiteClock');
      fixHeaderTag('GameBlackClock');
      if (theObject = document.getElementById('GameLastMove')) {
         if (CurrentPly == StartPly) {
            theObject.innerHTML = ((CurrentPly%2) ? "black" : "white") + " to move";
         }
      }
      fixCommentScrollbar();
   }

   function customFunctionOnPgnGameLoad() {
      fixHeaderTag('GameDate');
      fixHeaderTag('GameSite');
      fixHeaderTag('GameEvent');
      customPgnHeaderTagWithFix('Section', 'GameSection');
      customPgnHeaderTagWithFix('Stage', 'GameStage');
      fixHeaderTag('GameRound');
      if (theObject = document.getElementById("GameRound")) {
         if (theObject.innerHTML) {
            theObject.innerHTML = "round " + theObject.innerHTML;
         }
      }
      customPgnHeaderTagWithFix('Board', 'GameBoardNum');
      if (theObject = document.getElementById("GameBoardNum")) {
         if (theObject.innerHTML) {
            theObject.innerHTML = "board " + theObject.innerHTML;
         }
      }
      customPgnHeaderTagWithFix('TimeControl', 'GameTimeControl');
      fixHeaderTag('GameWhite');
      fixHeaderTag('GameBlack');
      customPgnHeaderTagWithFix('WhiteTitle', 'GameWhiteTitle');
      customPgnHeaderTagWithFix('BlackTitle', 'GameBlackTitle');
      customPgnHeaderTagWithFix('WhiteElo', 'GameWhiteElo');
      customPgnHeaderTagWithFix('BlackElo', 'GameBlackElo');
      customPgnHeaderTagWithFix('ECO', 'GameECO');
      customPgnHeaderTagWithFix('Opening', 'GameOpening');
      customPgnHeaderTagWithFix('Variation', 'GameVariation');
      customPgnHeaderTagWithFix('SubVariation', 'GameSubVariation');
      fixHeaderTag('GameResult');
      customPgnHeaderTagWithFix('Termination', 'GameTermination');
      // if (PlyNumber > 0) { customPgnHeaderTag('Result', 'ResultAtGametextEnd'); }
      // else { if (theObject = document.getElementById('ResultAtGametextEnd')) { theObject.innerHTML = ""; } }
      var lastDisplayStyle = "none";
      for(ii=StartPly; ii<=StartPly+PlyNumber; ii++) {
        if (strippedMoveComment(ii)) {
          lastDisplayStyle = "block";
          break;
        }
      }
      if (theObject = document.getElementById('lastMoveAndComment')) {
        theObject.style.display = lastDisplayStyle;
      }
   }

   function customFunctionOnPgnTextLoad() {
      if (LiveBroadcastStatusString) {
         document.title = LiveBroadcastStatusString.replace(" &nbsp;", ",");
      } else {
         if ((numberOfGames == 1) && (PlyNumber === 0) && (StartPly === 0) && (!gameWhite[0]) && (!gameBlack[0]) && (!gameResult[0])) {
            document.title = "PGN data error";
         } else {
            document.title = numberOfGames + " game" + (numberOfGames == 1 ? "" : "s");
         }
      }
   }

   function customShortcutKey_Shift_1() {
      if (gameWhite[currentGame]) {
         window.open("http://ratings.fide.com/seek.phtml?idcode=&name=" + gameWhite[currentGame] + "&offset=0");
      }
   }

   function customShortcutKey_Shift_2() {
      if (gameBlack[currentGame]) {
         window.open("http://ratings.fide.com/seek.phtml?idcode=&name=" + gameBlack[currentGame] + "&offset=0");
      }
   }

</script>

<div id="GameSelector"></div>
<div id="GameSearch"></div>

<a name="board"></a>

<div class="columnsContainer">

<div class="boardColumn">
<center>
<div id="GameBoard"></div>
<div id="GameButtons"></div>
</center>
</div>

<div class="headerColumn">
<div class="headerItem"><span class="innerHeaderItem" id="GameDate"></span><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameSite"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameEvent"></span><span class="innerHeaderItem" id="GameSection"></span><span class="innerHeaderItem" id="GameStage"></span><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameRound"></span><span class="innerHeaderItem" id="GameBoardNum"></span><span class="innerHeaderItem" id="GameTimeControl"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameECO"></span><span class="innerHeaderItem" id="GameOpening"></span><span class="innerHeaderItem" id="GameVariation"></span><span class="innerHeaderItem" id="GameSubVariation"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameWhiteClock"></span><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="#" class="innerHeaderItem" id="GameWhite"></a></b><span class="innerHeaderItem" id="GameWhiteTitle"></span><span class="innerHeaderItem" id="GameWhiteElo"></span><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="#board" class="innerHeaderItem" id="GameBlack"></a></b><span class="innerHeaderItem" id="GameBlackTitle"></span><span class="innerHeaderItem" id="GameBlackElo"></span><b>&nbsp;</b></div>
<div class="headerItem"><span class="innerHeaderItem" id="GameBlackClock"></span><b>&nbsp;</b></div>
<div class="headerItem headerSpacer"><b>&nbsp;</b></div>
<div class="headerItem"><b><a href="#bottom" class="innerHeaderItem" id="GameResult"></a></b><span class="innerHeaderItem" id="GameTermination"></span><b>&nbsp;</b></div>
</div>

</div>

<div class="lastMoveAndComment" id="lastMoveAndComment"><a href="javascript:MoveToPrevComment();" class="lastMove" title="last move" id="GameLastMove"></a><a href="javascript:MoveToNextComment();" class="lastComment" title="current position comment" id="GameLastComment"></a></div>

<div class="moveText"><span id="GameText"></span> <span class="move" id="ResultAtGametextEnd"></span></div>

<div class="notes">
<div title="live broadcast status" style="float: left; text-align: left; margin-right: 20px; margin-bottom: 5px;" id="GameLiveStatus"></div>
<div><script type="text/javascript">
  if (pgnData) { document.write("<a title='chess games source URL' class='notesLink' href=" + pgnData + ">" + pgnData + "</a>"); }
  if (pgnBackground) { document.write("<span class='notesLink'>chess games from PGN text input</span>"); }
</script></div>
</div>

<a name="bottom"></a>

</body>

</html>
