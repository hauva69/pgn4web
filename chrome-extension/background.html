<!DOCTYPE html>
<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2011 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<!-- 

HTML, CSS and Javascript code optimized for use as extension 
of Google Chrome. Don't use with any other browser.

-->

<head>

<meta charset="utf-8">

<script type="text/javascript">

var pgnHeaderRegExpGlobal = /((\[\s*(\w+)\s*"([^"]*)"\s*\]\s*)+)/g;

function validatePgnUrl(pgnUrl) {
  return (pgnUrl.match(/^(http|https):\/\/[^?#]+\.(pgn|zip)($|\?.*$|#.*$)/i) !== null);
}

// keep this aligned with the one in pgn4web.js
function fixCommonPgnMistakes(text) {
  text = text.replace(/[\u00A0\u180E\u2000-\u200A\u202F\u205F\u3000]/g," "); // some "space" to plain space
  text = text.replace(/\u00BD/g,"1/2"); // "half fraction" to "1/2"
  text = text.replace(/[\u2010-\u2015]/g,"-"); // "hyphens" to "-"
  text = text.replace(/\u2024/g,"."); // "one dot leader" to "."
  text = text.replace(/[\u2025-\u2026]/g,"..."); // "two dot leader" and "ellipsis" to "..."
  text = text.replace(/\\"/g,"'"); // fix parsing headers like: [Opening "King\"s Indian Attack"]
  return text;
}

function validatePgnText(pgnText) {
  testPgnText = pgnText;
  testPgnText = testPgnText.replace(/%[^\n]*(\n|$)/g, ""); // remove comments
  testPgnText = testPgnText.replace(/{[^}]*}/g, ""); // remove comments
  testPgnText = testPgnText.replace(pgnHeaderRegExpGlobal, ""); // remove headers
  return (testPgnText.match(/[^\s0-9.a-hx:KQRBNO#+=!?$()*\/\n\r\-]+/) === null);
}

function openRemoteUrl(remoteUrl, live, all) {
  if (!remoteUrl) { return; }
  if (all) {
    liveParam = live ? "&refreshMinutes=1" : "";
    url = "live-mosaic-viewer.html?pgnData=" + escape(remoteUrl) + liveParam + "&hp=t";
  } else {
    liveParam = live ? "&refreshMinutes=1.0" + Math.floor(Math.random()*10) : "";
    url = "chess-games-viewer.html?pgnData=" + escape(remoteUrl) + liveParam;
  }
  chrome.tabs.create({url: url});
}

// until chromium bug 84024 is resolved, context menus might appear for links that
// do not validate as PGN links, such as http://host/file.html?pgnData=games.pgn
// see http://code.google.com/p/chromium/issues/detail?id=84024
 
function pgnLinkOnClick(info, tab, live, all) {
  var remoteUrl = info.linkUrl;
  if (!remoteUrl) { return; }
  if (!validatePgnUrl(remoteUrl)) { 
    alert("Because of a limitation of the Google Chrome extensions URL pattern matching capabilities, the clicked link displays the link context menu of the chess games viewer even if the link's URL does not match the usual pattern of PGN chess games URLs; hence the link will not be opened automatically in the chess games viewer; to open the link, copy the link's URL and manually enter the URL using the page context menu.");
    return; 
  }
  openRemoteUrl(remoteUrl, live, all);
}

function pgnPageOnClick(info, tab, live, all) {
  var remoteUrl = prompt("Enter PGN chess games URL for viewing" + (all ? " on multiple boards" : " on a single board") + (live ? " with live refresh" : "") + ((info.selectionText && (!validatePgnUrl(info.selectionText))) ? "; the supplied URL does not match the usual PGN URL pattern:" : ":"), info.selectionText ? info.selectionText : "");
  if (!remoteUrl) { return; }

  openRemoteUrl(remoteUrl, live, all);
}

function pgnviewLinkOnClick(info, tab) {
  pgnLinkOnClick(info, tab, false);
}

function pgnliveLinkOnClick(info, tab) {
  pgnLinkOnClick(info, tab, true, false);
}

function pgnliveallLinkOnClick(info, tab) {
  pgnLinkOnClick(info, tab, true, true);
}

function pgnviewPageOnClick(info, tab) {
  pgnPageOnClick(info, tab, false);
}

function pgnlivePageOnClick(info, tab) {
  pgnPageOnClick(info, tab, true, false);
}

function pgnliveallPageOnClick(info, tab) {
  pgnPageOnClick(info, tab, true, true);
}

function openlocalpgnOnClick(info, tab) {
  chrome.tabs.create({url: "chess-games-viewer.html"});
}

var pgnText = new Array();
var pgnTextIndexFromTabId = new Array();
pgnTextIndex = 0;
function pgntextOnClick(info, tab) {
  var needsValidation;
  if (info.selectionText) {
    needsValidation = true;
    pgnText[pgnTextIndex] = info.selectionText;
  } else {
    needsValidation = false;
    pgnText[pgnTextIndex] = prompt("Enter PGN chess games TEXT for viewing on a single board; pasting multi-line PGN data in the textbox is allowed:");
    if (!pgnText[pgnTextIndex]) {
      delete pgnText[pgnTextIndex];
      return;
    }
  }
  if (pgnText[pgnTextIndex].match(/^\s*[1-8KQRBNP]{1,8}(\/[1-8KQRBNP]{1,8}){7}[\s0-9A-HKQW-]*$/i)) {
     pgnText[pgnTextIndex] = '[FEN "' + pgnText[pgnTextIndex] + '"]';
  }
  pgnText[pgnTextIndex] = pgnText[pgnTextIndex].replace(pgnHeaderRegExpGlobal, "\n$1\n"); // add newline after header section
  pgnText[pgnTextIndex] = fixCommonPgnMistakes(pgnText[pgnTextIndex]);

  if (needsValidation && (!validatePgnText(pgnText[pgnTextIndex]))) {
    delete pgnText[pgnTextIndex];
    alert("The supplied text does not match the usual PGN text pattern. Copy the text and use the chess games viewer page menu to manually enter the amended PGN text.");
    return; 
  }

  url = "chess-games-viewer.html?pgnBackground=" + pgnTextIndex++;
  chrome.tabs.create({url: url});
}

function removePgnTextOnRemoved(tabId) {
  if ((pgnTextIndexFromTabId[tabId] !== null) && (pgnTextIndexFromTabId[tabId] !== undefined)) {
    var thisPgnTextIndex = pgnTextIndexFromTabId[tabId];
    delete pgnTextIndexFromTabId[tabId];
    if (pgnTextIndexFromTabId.indexOf(thisPgnTextIndex) == -1) {
      delete pgnText[thisPgnTextIndex];
    }
  }
}

chrome.tabs.onRemoved.addListener(removePgnTextOnRemoved);

function aboutChessGamesViewer(info, tab) {
  chrome.tabs.create({url: "about.html"});
}

// "page" and "selection" context menu to open PGN text 

chrome.contextMenus.create({"title": "Enter PGN chess games TEXT for viewing on a single board", "contexts": ["page"], "onclick": pgntextOnClick});

chrome.contextMenus.create({"title": "View selected TEXT as PGN chess games on a single board", "contexts": ["selection"], "onclick": pgntextOnClick});

chrome.contextMenus.create({"type": "separator", "contexts": ["page", "selection"]});

// "page" and "selection" context menu to enter PGN chess games URL for opening

chrome.contextMenus.create({"title": "Enter PGN chess games URL for viewing on a single board", "contexts": ["page", "selection"], "onclick": pgnviewPageOnClick});

chrome.contextMenus.create({"title": "Enter PGN chess games URL for viewing on a single board with live refresh", "contexts": ["page", "selection"], "onclick": pgnlivePageOnClick});

chrome.contextMenus.create({"title": "Enter PGN chess games URL for viewing on multiple boards with live refresh", "contexts": ["page", "selection"], "onclick": pgnliveallPageOnClick});

chrome.contextMenus.create({"type": "separator", "contexts": ["page", "selection"]});

// "link" context menu to open remote PGN chess games URLs

// which URL patters should be considered as PGN chess games

pgnUrlPatterns = ["*://*/*.pgn", "*://*/*.PGN", "*://*/*.Pgn", "*://*/*.pgn?*", "*://*/*.PGN?*", "*://*/*.Pgn?*"];
zipUrlPatterns = ["*://*/*.zip", "*://*/*.ZIP", "*://*/*.Zip", "*://*/*.zip?*", "*://*/*.ZIP?*", "*://*/*.Zip?*"];
pgnZipUrlPatterns = pgnUrlPatterns.concat(zipUrlPatterns);

// until chromium bug 63965 is resolved the context menu will not appear for
// links shown as images like this <a href=game.pgn><img src=image.jpeg/></a>
// see http://code.google.com/p/chromium/issues/detail?id=63965

chrome.contextMenus.create({"title": "View chess games link on a single board", "contexts": ["link"], targetUrlPatterns: pgnUrlPatterns, "onclick": pgnviewLinkOnClick});

chrome.contextMenus.create({"title": "View chess games link on a single board with live refresh", "contexts": ["link"], targetUrlPatterns: pgnUrlPatterns, "onclick": pgnliveLinkOnClick});

chrome.contextMenus.create({"title": "View chess games link on multiple boards with live refresh", "contexts": ["link"], targetUrlPatterns: pgnUrlPatterns, "onclick": pgnliveallLinkOnClick});

chrome.contextMenus.create({"title": "Inspect ZIP archive link for PGN chess games", "contexts": ["link"],  targetUrlPatterns: zipUrlPatterns, "onclick": pgnviewLinkOnClick});

chrome.contextMenus.create({"type": "separator", "contexts": ["link"], targetUrlPatterns: pgnZipUrlPatterns});

// "page" context menu to open local PGN files

chrome.contextMenus.create({"title": "Open local PGN chess games FILES for viewing on a single board", "contexts": ["page"], "onclick": openlocalpgnOnClick});

chrome.contextMenus.create({"type": "separator", "contexts": ["page"]});

// "link", "page" and "selection" about menus

// ideally, only this entry should be required
//
// chrome.contextMenus.create({"title": "About the chess games viewer extension", "contexts": ["link", "page", "selection"], targetUrlPatterns: pgnZipUrlPatterns, "onclick": aboutChessGamesViewer});
//
// however, until chromium bug 63545 is resolved, two entries are required
// and adding the about menu to the "selection" context would result in
// duplicated items when a selected link is right-clicked
// see http://code.google.com/p/chromium/issues/detail?id=63545
//
chrome.contextMenus.create({"title": "About the chess games viewer extension", "contexts": ["link"], targetUrlPatterns: pgnZipUrlPatterns, "onclick": aboutChessGamesViewer});
//
chrome.contextMenus.create({"title": "About the chess games viewer extension", "contexts": ["page"], "onclick": aboutChessGamesViewer});
//

// end of context menus entries

var pgnHrefLinks = new Array();
var pgnWebRequests = new Array();
var processedUrls = new Array();

function mergePgnLinksAndShowIcon(tabId) {
  if (! pgnHrefLinks[tabId]) { return; }
  if (! pgnWebRequests[tabId]) { return; }
  pgnHrefLinks[tabId] = pgnHrefLinks[tabId].sort();
  for (r in pgnWebRequests[tabId]) {
    for (l in pgnHrefLinks[tabId]) {
      if (pgnHrefLinks[tabId][l].match(pgnWebRequests[tabId][r].replace(/(\?|#).*$/, ""))) {
        delete pgnWebRequests[tabId][r];
        break;
      }
    }
  }
  pgnWebRequests[tabId] = pgnWebRequests[tabId].filter(function(element, index, array) { return ((element !== null) && (element !== undefined)); }).sort();
  pgnLinksTitle = (pgnHrefLinks[tabId].length + pgnWebRequests[tabId].length) + " chess games " + ((pgnHrefLinks[tabId].length + pgnWebRequests[tabId].length) == 1 ? "link" : "links") + " on this page";
  chrome.pageAction.setTitle({tabId:tabId, title:pgnLinksTitle});
  chrome.pageAction.show(tabId);
}

function pgnHrefLinksRequest(request, sender, sendResponse) {
  if (pgnHrefLinks[sender.tab.id]) {
    for(l in request.pgnHrefLinks) {
      if (pgnHrefLinks[sender.tab.id].indexOf(request.pgnHrefLinks[l]) == -1) {
        pgnHrefLinks[sender.tab.id].push(request.pgnHrefLinks[l]);
      }
    }
  } else {
    pgnHrefLinks[sender.tab.id] = request.pgnHrefLinks;
    pgnWebRequests[sender.tab.id] = new Array();
  }
  mergePgnLinksAndShowIcon(sender.tab.id);
  sendResponse({});
}

chrome.extension.onRequest.addListener(pgnHrefLinksRequest);

function removePgnLinksOnRemoved(tabId) {
  if (pgnHrefLinks[tabId]) { delete pgnHrefLinks[tabId]; }
  if (pgnWebRequests[tabId]) { delete pgnWebRequests[tabId]; }
  if (processedUrls[tabId]) { delete processedUrls[tabId]; }
}

chrome.tabs.onRemoved.addListener(removePgnLinksOnRemoved);

function removePgnLinksOnUpdated(tabId, changeInfo, tab) {
  if (changeInfo.status == "loading") {
    if (changeInfo.url) {
      changeInfoUrlWithoutHash = changeInfo.url.replace(/#.*$/, "");
      if ((processedUrls[tabId]) && (processedUrls[tabId] !== changeInfoUrlWithoutHash)) {
        if (pgnHrefLinks[tabId]) { delete pgnHrefLinks[tabId]; }
        if (pgnWebRequests[tabId]) { delete pgnWebRequests[tabId]; }
      }
      processedUrls[tabId] = changeInfoUrlWithoutHash;
    } else {
      mergePgnLinksAndShowIcon(tabId); // this seems to fix an obscure issue with clicking twice on a hash link
    }
  }
}

chrome.tabs.onUpdated.addListener(removePgnLinksOnUpdated);

function checkWebRequestForPgnFiles(requestDetails) {
  if (requestDetails.tabId === null) { return; }
  if (!validatePgnUrl(requestDetails.url)) { return; }
  
  if (pgnWebRequests[requestDetails.tabId]) { 
    for (r in pgnWebRequests[requestDetails.tabId]) {
      if (pgnWebRequests[requestDetails.tabId][r].match(requestDetails.url.replace(/(\?|#).*$/, ""))) {
        return;
      }
    }
  } else {
    pgnHrefLinks[requestDetails.tabId] = new Array();
    pgnWebRequests[requestDetails.tabId] = new Array();
  }
  pgnWebRequests[requestDetails.tabId].push(requestDetails.url);
  mergePgnLinksAndShowIcon(requestDetails.tabId);
}

// enables using the webRequest API, currently disable because experimental
//
// chrome.experimental.webRequest.onBeforeRequest.addListener(checkWebRequestForPgnFiles, {"urls": pgnUrlPatterns});
//

</script>

</head>

</html>
