<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2010 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<head>

<script type="text/javascript">

var debugInfo = "the top left chessboard square will flash in case of PGN data errors, click that square for further details";

function validatePgnUrl(pgnUrl) {
  return pgnUrl.match(/^[^?#]+\.pgn($|\?.*$|#.*$)/i);
}

function validatePgnText(pgnText) {
  // to be completed
  return true;
}

function openRemoteUrl(remoteUrl, live) {
  if (!remoteUrl) { return; }
  var liveParam = live ? '&refreshMinutes=1.0' + Math.floor(Math.random()*10) + '&search=\\[\\s*Result\\s*"\\*"\\s*\\]' : "";
  url = "chess-games-viewer.html?pgnData=" + escape(remoteUrl) + liveParam;
  chrome.tabs.create({url: url});
}

function pgnLinkOnClick(info, tab, live) {
  var remoteUrl = info.linkUrl;
  if (!remoteUrl) { return; }
  if (!validatePgnUrl(remoteUrl)) { return; }
  openRemoteUrl(remoteUrl, live);
}

function pgnPageOnClick(info, tab, live) {
  var promptLabel = "Enter PGN chess games URL for viewing" + (live ? " with live refresh" : "") + " (" + debugInfo + "):";
  var defaultRemoteUrl = info.selectionText ? info.selectionText.replace(/[\n\r]+/g," ") : "";
  var remoteUrl = prompt(promptLabel, defaultRemoteUrl);
  if (!remoteUrl) { return; }
  // if (!validatePgnUrl(remoteUrl)) { return; }
  openRemoteUrl(remoteUrl, live);
}

function pgnviewLinkOnClick(info, tab) {
  pgnLinkOnClick(info, tab, false);
}

function pgnliveLinkOnClick(info, tab) {
  pgnLinkOnClick(info, tab, true);
}

function pgnviewPageOnClick(info, tab) {
  pgnPageOnClick(info, tab, false);
}

function pgnlivePageOnClick(info, tab) {
  pgnPageOnClick(info, tab, true);
}

var pgnText = new Array();
var pgnTextIndexFromTabId = new Array();
pgnTextIndex = 0;
function pgntextOnClick(info, tab) {
  pgnText[pgnTextIndex] = info.selectionText;
  if (!pgnText[pgnTextIndex]) { 
    pgnText[pgnTextIndex] = prompt("Enter PGN chess games TEXT for viewing (pasting multi-line PGN data in the textbox is ok; " + debugInfo + "):");
    var pgnHeaderRegExpGlobal = /((\[\s*(\w+)\s*"([^"]*)"\s*\]\s*)+)/g;
    pgnText[pgnTextIndex] = pgnText[pgnTextIndex].replace(pgnHeaderRegExpGlobal, "\n$1\n");
  }
  if (!pgnText[pgnTextIndex]) { return; }
  // if (!validatePgnText(pgnText[pgnTextIndex])) { 
  //   delete pgnText[pgnTextIndex]);
  //   return; 
  // }
  url = "chess-games-viewer.html?pgnBackground=" + pgnTextIndex++;
  chrome.tabs.create({url: url});
}

function removePgnTextOnRemoved(tabId) {
  if ((pgnTextIndexFromTabId[tabId] !== null) && (pgnTextIndexFromTabId[tabId] !== undefined)) {
    var thisPgnTextIndex = pgnTextIndexFromTabId[tabId];
    delete pgnTextIndexFromTabId[tabId];
    if (pgnTextIndexFromTabId.indexOf(thisPgnTextIndex) == -1) {
      delete pgnText[thisPgnTextIndex];
    }
  }
}

chrome.tabs.onRemoved.addListener(removePgnTextOnRemoved);

function aboutChessGamesViewer(info, tab) {
  var aboutText = "Chess games viewer extension for Google Chrome: interactive chessboard showing chess games from links to *.PGN URLs and from PGN text, using context menus and page actions.";
  aboutText += "\n\nA context menu shows chess games from links to *.PGN chess games URLs; PGN (Portable Games Notation) files are commonly used to store and share chess games information. The live refresh option reloads the games periodically until all games are ended; use for links to chess games live broadcasts. The mouse cursor icon highlights links to *.PGN chess games URLs when hovering on them.";
  aboutText += "\n\nA context menu shows chess games from PGN chess games text selecetd in the web page.";
  aboutText += "\n\nA page action looks for links to *.PGN chess games URLs in the current page; if found, a page action icon in the address bar allows for opening the links in the chess games viewer.";
  aboutText += "\n\nClick on the viewer's chessboard top right square for user interface help, credits and license; " + debugInfo + ".";
  aboutText += "\n\n\nClick OK to visit the pgn4web homepage and wiki for more info.";
  if (confirm(aboutText)) { chrome.tabs.create({url: "http://pgn4web.casaschi.net"}); }
}

// which URL patters should be considered as PGN chess games

pgnUrlPatterns = ["*://*/*.pgn", "*://*/*.PGN", "*://*/*.Pgn", "*://*/*.pgn?*", "*://*/*.PGN?*", "*://*/*.Pgn?*", "*://*/*.pgn#*", "*://*/*.PGN#*", "*://*/*.Pgn#*"];

// "link" context item to open remote PGN chess games URLs

// until chromium bug 63965 is resolved the context menu will not appear for
// links shown as images like this <a href=game.pgn><img src=image.jpeg/></a>
// see http://code.google.com/p/chromium/issues/detail?id=63965

chrome.contextMenus.create({"title": "View chess games link", "contexts": ["link"], targetUrlPatterns: pgnUrlPatterns, "onclick": pgnviewLinkOnClick});

chrome.contextMenus.create({"title": "View chess games link with live refresh", "contexts": ["link"], targetUrlPatterns: pgnUrlPatterns, "onclick": pgnliveLinkOnClick});

// "page" and "selection" context menu to open PGN text 

chrome.contextMenus.create({"title": "Enter PGN chess games TEXT for viewing", "contexts": ["page"], "onclick": pgntextOnClick});

chrome.contextMenus.create({"title": "View selected TEXT as PGN chess games", "contexts": ["selection"], "onclick": pgntextOnClick});

chrome.contextMenus.create({"type": "separator", "contexts": ["page", "selection"]});

// "page" and "selection" context menu to enter PGN chess games URL for opening

chrome.contextMenus.create({"title": "Enter PGN chess games URL for viewing", "contexts": ["page", "selection"], "onclick": pgnviewPageOnClick});

chrome.contextMenus.create({"title": "Enter PGN chess games URL for viewing with live refresh", "contexts": ["page", "selection"], "onclick": pgnlivePageOnClick});

// "link", "page" and "selection" about menus

// ideally, only those two entries should be required
//
// chrome.contextMenus.create({"type": "separator", "contexts": ["link", "page", "selection"], targetUrlPatterns: pgnUrlPatterns});
//
// chrome.contextMenus.create({"title": "About the chess games viewer extension", "contexts": ["link", "page", "selection"], targetUrlPatterns: pgnUrlPatterns, "onclick": aboutChessGamesViewer});
//
// however, until chromium bug 63545 is resolved, four entries are required
// and adding the about menu to the "selection" context would result in
// duplicated items when a selected link is right-clicked
// see http://code.google.com/p/chromium/issues/detail?id=63545

chrome.contextMenus.create({"type": "separator", "contexts": ["link"], targetUrlPatterns: pgnUrlPatterns});

chrome.contextMenus.create({"title": "About the chess games viewer extension", "contexts": ["link"], targetUrlPatterns: pgnUrlPatterns, "onclick": aboutChessGamesViewer});

chrome.contextMenus.create({"type": "separator", "contexts": ["page"]});

chrome.contextMenus.create({"title": "About the chess games viewer extension", "contexts": ["page"], "onclick": aboutChessGamesViewer});

// end of about menus entries

var pgnLinks = new Array();
function pgnLinksPopupRequest(request, sender, sendResponse) {
  if ((pgnLinks[sender.tab.id]) && (pgnLinks[sender.tab.id] !== undefined)) {
    pgnLinks[sender.tab.id] = pgnLinks[sender.tab.id].concat(request.pgnLinks);
  } else {
    pgnLinks[sender.tab.id] = request.pgnLinks;
  }
  pgnLinksTitle = pgnLinks[sender.tab.id].length + " chess games PGN link" + (pgnLinks[sender.tab.id].length == 1 ? "" : "s") + " on this page";
  chrome.pageAction.setTitle({tabId:sender.tab.id, title:pgnLinksTitle});
  chrome.pageAction.show(sender.tab.id);
  sendResponse({});
}

chrome.extension.onRequest.addListener(pgnLinksPopupRequest);

function removePgnLinksOnRemoved(tabId) {
  if (pgnLinks[tabId]) { delete pgnLinks[tabId]; }
}

chrome.tabs.onRemoved.addListener(removePgnLinksOnRemoved);

function removePgnLinksOnUpdated(tabId, changeInfo, tab) {
  if ((changeInfo.status == "loading") && (pgnLinks[tabId])) { delete pgnLinks[tabId]; }
}

chrome.tabs.onUpdated.addListener(removePgnLinksOnUpdated);

</script>

</head>

</html>
