<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009-2012 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<head>

<title>engine analysis</title>

<link rel="shortcut icon" href="pawn.ico" />

<style type="text/css">

body {
  margin: 0;
  padding: 28px;
  padding-bottom: 20px;
  color: black;
  background: #F4F4F4;
  font-family: sans-serif;
  font-size: 19px;
  font-weight: bold;
  overflow: hidden;
}

a {
  color: black;
  text-decoration: none;
}

.boardTable {
  border-style: solid;
  border-color: #DDDDDD;
  border-width: 3px;
  background: #F4F4F4;
  width: 230px;
  height: 230px;
}

.pieceImage {
  width: 24px;
  height: 24px;
}

.whiteSquare,
.blackSquare,
.highlightWhiteSquare,
.highlightBlackSquare {
  width: 26px;
  height: 26px;
  border-style: solid;
  border-width: 1px;
}

.whiteSquare,
.highlightWhiteSquare {
  border-color: #F4F4F4;
  background: #F4F4F4;
}

.blackSquare,
.highlightBlackSquare {
  border-color: #DDDDDD;
  background: #DDDDDD;
}

.highlightWhiteSquare,
.highlightBlackSquare {
  border-style: inset;
  border-color: #DDDDDD;
}

.move,
.variation,
.comment {
}

.moveOn,
.variationOn {
  background: #DDDDDD;
}

.container {
  width: 230px;
  overflow: hidden;
  position: relative;
}

.gameCustomButtons {
  margin-top: 8px;
  height: 16px;
  width: 100%;
  color: #BBBBBB;
  font-size: 12px;
  font-weight: bold;
}

.gameEval {
  padding-left: 18px;
  padding-bottom: 6px;
  background: #F4F4F4;
  position: absolute;
  right: 0;
}

.gameAnalysis {
  height: 22px;
  padding-top: 6px;
  padding-bottom: 6px;
  white-space: nowrap;
  text-align: left;
}

.gameAnalysisHidden {
  visibility: hidden;
}

.gameFlagAndMoves {
}

.gameFlagToMove {
  margin-right: 18px;
  margin-bottom: 1px;
  height: 5px;
  width: 5px;
  border-color: black;
}

.gameMoves {
  white-space: nowrap;
  font-size: 12px;
}

</style>

<script src="pgn4web.js" type="text/javascript"></script>
<script src="chess-informant-NAG-symbols.js" type="text/javascript"></script>
<script type="text/javascript">
   SetImagePath ("alpha/24");
   SetImageType("png");
   SetHighlightOption(false);
   SetShortcutKeysEnabled(false);
</script>

</head>

<body>


<!-- paste your PGN below and make sure you dont specify an external source with SetPgnUrl() -->
<form style="display: none;"><textarea style="display: none;" id="pgnText">

</textarea></form>
<!-- paste your PGN above and make sure you dont specify an external source with SetPgnUrl() -->

<center>
<div class="container">
<div id="GameBoard"></div>
<table id="GameCustomButtons" class="gameCustomButtons" cellspacing="0" cellpadding="0" border="0"><tr valign="middle">
<td id="btnStart" width="25%" align="center" onclick="GoToMove(StartPlyVar[0], 0);" onmouseover="if (CurrentPly > StartPly) { this.style.color = 'black'; }" onmouseout="this.style.color = '';" title="go to start">&lt;&lt;</td>
<td id="btnBack" width="20%" align="center" onclick="GoToMove(CurrentPly - 1);" onmouseover="if (CurrentPly > StartPly) { this.style.color = 'black'; }" onmouseout="this.style.color = '';" title="move backward">&lt;</td>
<td width="10%" align="center" id="GameAnalysisFlag"></td>
<td id="btnForw" width="20%" align="center" onclick="GoToMove(CurrentPly + 1);" onmouseover="if (CurrentPly < StartPly + PlyNumber) { this.style.color = 'black'; }" onmouseout="this.style.color = '';" title="move forward">&gt;</td>
<td id="btnEnd" width="25%" align="center" onclick="GoToMove(StartPlyVar[0] + PlyNumberVar[0], 0);" onmouseover="if (CurrentPly < StartPly + PlyNumber) { this.style.color = 'black'; }" onmouseout="this.style.color = '';" title="go to end">&gt;&gt;</td>
</tr></table>
<div class="gameAnalysis gameAnalysisHidden" id="GameAnalysis">
<div class="gameEval" id="GameEval">&middot;</div>
<div class="gameFlagAndMoves">
<img class="gameFlagToMove" id="GameFlagToMove" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoEAYAAADcbmQuAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAAZiS0dEAMAAwADAGp0HVAAAAAlwSFlzAAAASAAAAEgARslrPgAAAAl2cEFnAAAAKAAAACgAo3CU+AAAACNJREFUaN7twQENAAAAwqD3T20PBxQAAAAAAAAAAAAAAAAPBjIoAAFxtd2pAAAAAElFTkSuQmCC" border="1" /><span class="gameMoves" id="GameMoves"></span>&nbsp;
</div>
</div>
</center>

<script type="text/javascript">

var pgnFile = FenStringStart;
thisRegExp = /(&|\?)(fenString|fs)=([^&]*)(&|$)/i;
if (window.location.search.match(thisRegExp) !== null) {
   fenString = unescape(window.location.search.match(thisRegExp)[3]);
}
document.getElementById("pgnText").innerHTML = '[Setup "1"]\n[FEN "' + fenString + '"]\n';

var minAnalysisSeconds = 3;
var maxAnalysisSeconds = 313;
var analysisSeconds = 13;
thisRegExp = /(&|\?)(analysisSeconds|as)=([1-9][0-9]*)(&|$)/i;
if (window.location.search.match(thisRegExp) !== null) {
   analysisSeconds = parseInt(unescape(window.location.search.match(thisRegExp)[3]), 10);
   if (analysisSeconds < minAnalysisSeconds) { analysisSeconds = minAnalysisSeconds; }
   if (analysisSeconds > maxAnalysisSeconds) { analysisSeconds = maxAnalysisSeconds; }
}


var engineWorker = "garbochess/garbochess.js";

var g_backgroundEngineValid = true;
var g_backgroundEngine;
var g_nodesPerSecond = 0;

function InitializeBackgroundEngine() {
   if (!g_backgroundEngineValid) { return false; }

   if (!g_backgroundEngine) {
      g_backgroundEngineValid = true;
      try {
          g_backgroundEngine = new Worker(engineWorker);
          g_backgroundEngine.onmessage = function (e) {
             if ((e.data.match("^pv") == "pv") && (fenString == CurrentFEN())) {
                if (matches = e.data.substr(3, e.data.length - 3).match(/Ply:(\d+) Score:(-*\d+) Nodes:(\d+) NPS:(\d+) (.*)/)) {
                   ply = parseInt(matches[1], 10);
                   if (isNaN(ev = parseInt(matches[2], 10))) {
                      ev = "";
                   } else {
                      maxEv = 99.9;
                      ev = Math.round(ev / 100) / 10;
                      if (ev < -maxEv) { ev = -maxEv; } else if (ev > maxEv) { ev = maxEv; }
                      if (fenString.indexOf(" b ") !== -1) { ev = -ev; }
                   }
                   document.getElementById("GameEval").innerHTML = ev2NAG(ev);
                   document.getElementById("GameEval").title = "position evaluation: " + (ev > 0 ? "+" : "") + ev + (ev == Math.floor(ev) ? ".0" : "");
                   nodes = parseInt(matches[3], 10);
                   g_nodesPerSecond = parseInt(matches[4], 10);
                   pv = matches[5].replace(/\s*(\+|stalemate)/g, "").replace(/\s*checkmate/, "#");
                   document.getElementById("GameMoves").innerHTML = pv;
                   document.getElementById("GameMoves").title = "principal variation:" + pv + "; click to follow";
                   document.getElementById("GameMoves").setAttribute("onClick", "addPly(this.innerHTML.replace(/^\\s*(\\S+).*$/, '$1'));");
                   document.getElementById("GameAnalysisFlag").innerHTML = "&middot;";
                }
             }
          };
      } catch (e) {
        g_backgroundEngineValid = false;
        document.getElementById("GameMoves").innerHTML = "analysis engine unavailable";
        document.getElementById("GameMoves").title = "analysis engine not supported by this web browser";
      }
   }
   return g_backgroundEngineValid;
}

function ev2NAG(ev) {
   if ((ev === null) || (ev === "") || (isNaN(ev = parseFloat(ev)))) { return ""; }
   if (ev < -3.95) { return NAG[19]; } // -+
   if (ev >  3.95) { return NAG[18]; } // +-
   if (ev < -1.35) { return NAG[17]; } // -/+
   if (ev >  1.35) { return NAG[16]; } // +/-
   if (ev < -0.35) { return NAG[15]; } // =/+
   if (ev >  0.35) { return NAG[14]; } // +/=
   return NAG[11];                     // =
}

function StopBackgroundEngine() {
   if (g_backgroundEngine) {
     g_backgroundEngine.terminate();
     g_backgroundEngine = null;
     document.getElementById("GameAnalysisFlag").innerHTML = "";
   }
}

var analysisTimeout;
function setAnalysisTimeout(seconds) {
   if (analysisTimeout) { clearTimeout(analysisTimeout); }
   analysisTimeout = setTimeout("analysisTimeout = null; StopBackgroundEngine();", seconds * 1000);
}

function StartEngineAnalysis() {
   StopBackgroundEngine();
   if (InitializeBackgroundEngine()) {
      fenString = CurrentFEN();
      g_backgroundEngine.postMessage("position " + fenString);
      g_backgroundEngine.postMessage("analyze");
      setAnalysisTimeout(analysisSeconds);
   }
}


function customFunctionOnPgnTextLoad() {
   if (theObject = document.getElementById("GameAnalysis")) {
      theObject.className = "gameAnalysis";
   }
}

function customFunctionOnMove() {
   if (theObject = document.getElementById("GameFlagToMove")) {
      theObject.style.backgroundColor = CurrentPly % 2 ? "black" : "white";
      theObject.title = (CurrentPly % 2 ? "black" : "white") + " to move";
   }

   StartEngineAnalysis();

   if (clickFromCol !== "") {
      highlightSquare("abcdefgh".indexOf(clickFromCol), "12345678".indexOf(clickFromRow), false);
   }
   clickFromCol = "";
   clickFromRow = "";
   clickFromPiece = "";
   lastPromotionMove = lastPromotionPlaceholder;
   lastPromotionPlaceholder = "";

   if (CurrentPly <= StartPly) {
      document.getElementById("btnStart").style.color = "";
      document.getElementById("btnBack").style.color = "";
   }
   if (CurrentPly >= StartPly + PlyNumber) {
      document.getElementById("btnForw").style.color = "";
      document.getElementById("btnEnd").style.color = "";
   }
}

function customDebugInfo() {
   return "engine=" + engineWorker + " analysisSeconds=" + analysisSeconds + " nodesPerSecond=" + num2string(g_nodesPerSecond);
}

function num2string(num) {
   if (num >= Math.pow(10, 9)) { num = Math.floor(num / Math.pow(10, 9)) + "G"; }
   else if (num >= Math.pow(10, 6)) { num = Math.floor(num / Math.pow(10, 6)) + "M"; }
   else if (num >= Math.pow(10, 3)) { num = Math.floor(num / Math.pow(10, 3)) + "K"; }
   else { num = num + ""; }
   return num;
}


var overwrittenPly;
var overwrittenPlyNumber;
function addPly(thisPly) {
   if (!thisPly) { return; }
   if (thisPly !== Moves[CurrentPly]) {
      overwrittenPly = Moves[CurrentPly];
      Moves[CurrentPly] = MovesVar[0][CurrentPly] = thisPly;
      overwrittenPlyNumber = PlyNumber;
      PlyNumber = PlyNumberVar[0] = CurrentPly + 1 - StartPly;
   }
   MoveForward(1);
}

function customFunctionOnAlert(msg) {
   if (msg.indexOf("error: invalid ply") !== 0) { return; }
   stopAlertPrompt();
   if (!overwrittenPly) { return; }
   Moves[CurrentPly] = MovesVar[0][CurrentPly] = overwrittenPly;
   PlyNumber = PlyNumberVar[0] = overwrittenPlyNumber;
   overwrittenPly = "";
}

for (cc=0; cc<8; cc++) { for (rr=0; rr<8; rr++) {
   boardShortcut("ABCDEFGH".charAt(cc) + "12345678".charAt(rr), "", detectClick, false);
} }

var clickFromCol = "";
var clickFromRow = "";
var clickFromPiece = "";
var lastPromotionMove = "";
var lastPromotionPlaceholder = "";
function detectClick(t,e) {
   if (! (matches = t.id.match(/img_tcol([0-7])trow([0-7])/))) { return; }
   thisCol = IsRotated ? 7 - matches[1] : matches[1];
   thisColChar = "abcdefgh".charAt(thisCol);
   thisRow = IsRotated ? matches[2] : 7 - matches[2];
   thisRowChar = "12345678".charAt(thisRow);
   if ((lastPromotionMove !== "") && (lastPromotionMove.charAt(2) == thisColChar) && (lastPromotionMove.charAt(3) == thisRowChar)) {
      thisMove = lastPromotionMove.substr(0,4) + "RBNQ".charAt("QRBN".indexOf(lastPromotionMove.charAt(4)));
      Moves[CurrentPly - 1] = MovesVar[0][CurrentPly - 1] = thisMove;
      MoveBackward(1);
      MoveForward(1);
      lastPromotionMove = thisMove;
   } else if (clickFromCol !== "") {
      setTimeout('highlightSquare("abcdefgh".indexOf("' + clickFromCol + '"), "12345678".indexOf("' + clickFromRow + '"), false);', 77);
      clickToCol = thisColChar;
      clickToRow = thisRowChar;
      if ((clickFromCol !== clickToCol) || (clickFromRow !== clickToRow)) {
         var thisMove = clickFromPiece + clickFromCol + clickFromRow + clickToCol + clickToRow;
         if (thisMove == "Ke1g1") { thisMove = "O-O"; }
         if (thisMove == "Ke1c1") { thisMove = "O-O-O"; }
         if (thisMove == "Ke8g8") { thisMove = "O-O"; }
         if (thisMove == "Ke8c8") { thisMove = "O-O-O"; }
         if (("KQRBN".indexOf(thisMove.charAt(0)) == -1) && (thisMove.charAt(3) == (CurrentPly % 2 ? "1" : "8"))) {
            thisMove += "Q";
            lastPromotionPlaceholder = thisMove;
         }
         addPly(thisMove);
      }
      clickFromCol = clickFromRow = clickFromPiece = "";
   } else {
      cc = CurrentPly % 2;
      for (ii=0; ii<16; ii++) {
         if ((PieceCol[cc][ii] == thisCol) && (PieceRow[cc][ii] == thisRow)) {
            if (PieceType[cc][ii] != -1) {
               clickFromPiece = " KQRBNP".charAt(PieceType[cc][ii]);
               if (clickFromPiece == "P") { clickFromPiece = ""; }
               clickFromCol = thisColChar;
               clickFromRow = thisRowChar;
               setTimeout('highlightSquare(' + thisCol + ', ' + thisRow + ', true);', 77);
            }
         }
      }
   }
}

</script>

</body>

</html>
