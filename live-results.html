<!DOCTYPE>
<html>

<!--
  pgn4web javascript chessboard
  copyright (C) 2009, 2012 Paolo Casaschi
  see README file and http://pgn4web.casaschi.net
  for credits, license and more details
-->

<head>

<title>pgn4web live results</title>

<link rel="shortcut icon" href="pawn.ico" />

<style type="text/css">

body {
  padding: 40px;
  margin: 0;
  font-family: sans-serif;
  font-size: 16px;
}

.event, .round, .match, .team, .firstTeam, .secondTeam, .score, .firstTeamScore, .secondTeamScore, .player, .firstPlayer, .secondPlayer, .firstTeamPlayer, .secondTeamPlayer, .result, .newMoves, .noNewMoves {
  display: inline-block;
  white-space: nowrap;
  overflow-x: hidden;
}

.eventRound, .event, .match, .firstTeam, .secondTeam, .game, .firstPlayer, .secondPlayer, .firstTeamPlayer, .secondTeamPlayer {
  margin-left: 0;
}

.round, .team, .score, .player, .result, .newMoves, .noNewMoves {
  margin-left: 20px;
}

.event {
  width: 430px;
}

.round {
  width: 100px;
}

.match {
  width: 440px;
}

.score {
  width: 100px;
}

.player {
  width: 200px;
}

.result {
  width: 75px;
}

.event, .firstTeam, .secondTeam, .firstPlayer, .secondPlayer {
  padding-left: 5px;
  padding-right: 5px;
}

.eventRound {
  font-size: 24px;
  font-weight: normal;
  padding-top: 25px;
  padding-bottom: 10px;
}

.matchScore {
  font-size: 18px;
  font-weight: bold;
  padding-top: 30px;
  padding-bottom: 10px;
}

.game {
  font-size: 16px;
  font-weight: normal;
  padding-top: 0;
  padding-bottom: 0;
}

.secondTeam, .secondTeamPlayer {
  background-color: #F0F0F0;
}

.newMoves, .noNewMoves {
  color: gray;
  font-weight: bold;
}

.resultNoNewMoves {
  visibility: hidden;
}

.gameLiveStatusTicker {
  font-size: 16px;
  position: fixed;
  top: 0;
  right: 0;
  text-align: center;
  width: 1em;
  color: gray;
  text-decoration: none;
}

.gameBoardContainer {
  position: fixed;
  top: 40px;
  right: 40px;
  width: 326px;
  background: white;
}

.boardTable {
  border-style: double;
  border-color: black;
  border-width: 3px;
  box-shadow: 0px 0px 15px #AAAAAA;
  width: 326px;
  height: 326px;
}

.pieceImage {
  width: 32px;
  height: 32px;
}

.whiteSquare,
.blackSquare,
.highlightWhiteSquare,
.highlightBlackSquare {
  width: 40px;
  height: 40px;
}

.whiteSquare {
  background: #EFF4EC;
}

.blackSquare {
  background: #C6CEC3;
}

.highlightWhiteSquare,
.highlightBlackSquare {
  background: #DAF4D7;
}

.selectControl {
/* a "width" attribute here must use the !important flag to override default settings */
  font-size: 16px;
}

.optionSelectControl {
}

.buttonControlPlay,
.buttonControlStop,
.buttonControl {
/* a "width" attribute here must use the !important flag to override default settings */
  font-size: 16px;
  border-style: none;
  background-color: transparent;
}

.buttonControlSpace {
/* a "width" attribute here must use the !important flag to override default settings */
  font-size: 16px;
}

.searchPgnButton {
/* a "width" attribute here must use the !important flag to override default settings */
  font-size: 16px;
}

.searchPgnExpression {
/* a "width" attribute here must use the !important flag to override default settings */
  font-size: 16px;
}

.move,
.moveOn {
  text-decoration: none;
  color: black;
}

.moveOn {
  background: #DAF4D7;
}

.comment {
  color: gray;
}

.variation {
  color: gray;
}

.gameText {
  font-size: 11px;
  text-align: justify;
  line-height: 1.4em;
}

.header {
  font-size: 11px;
  line-height: 1.4em;
  white-space: nowrap;
  margin-left: 3px;
  margin-right: 3px;
  width: 320px;
  overflow: hidden;
}

.gameWhite, .gameWhiteClock, .gameBlackClock, .gameBlack {
  display: inline-block;
  overflow: hidden;
}

.gameWhite, .gameBlack {
  width: 80px;
  text-decoration: none;
  color: black;
}

.gameWhiteClock, .gameBlackClock {
  width: 50px;
  margin-left: 15px;
  margin-right: 15px;
}

.gameWhite, .gameBlackClock {
  text-align: left;
}

.gameWhiteClock, .gameBlack {
  text-align: right;
}

.sideToMove {
  height: 4px;
  width: 4px;
  border-style: solid;
  border-color: black;
  border-width: 1px;
  margin-right: 10px;
  margin-bottom: 1px;
}

</style>

<script src="pgn4web.js" type="text/javascript"></script>
<script src="fide-lookup.js" type="text/javascript"></script>
<script src="crc32.js" type="text/javascript"></script>

<script type="text/javascript">

  pgnFile_default = detectBaseLocation() ?
    location.protocol + "//" + location.hostname + location.pathname.replace(/\/[^\/]*$/, "/live/live.pgn") :
    "live/live.pgn";
  // accepts pgnData as alias for pgnFile for consistency with board.html
  if ((pgnFile = gup("pgnData")) === "") {
    if ((pgnFile = gup("pgnFile")) === "") {
      pgnFile = pgnFile_default;
    }
  }

  if ((gup("demo") == "true") || (gup("demo") == "t") ||
      (gup("refreshDemo") == "true") || (gup("refreshDemo") == "t")) {
    demoFlag = true; alertFlag = true;
  } else { demoFlag = false; alertFlag = false; }

  if ((refreshMinutes = gup("refreshMinutes")) === "") {
    refreshMinutes = 1;
  } else {
    testMinutes = refreshMinutes + "";
    if ((testMinutes.match(/[^0-9\.]/)) || (refreshMinutes === 0)) {
      if (alertFlag) {
	      alert("ERROR: refreshMinutes parameter must be a positive number.\n" +
		    "Supplied " + testMinutes + "; defaulting to 1.");
      }
      refreshMinutes = 1;
    }
  }

  showBoard = false;
  if ((gup("showBoard") == "true") || (gup("showBoard") == "t")) { showBoard = true; }

  showEvent = true;
  if ((gup("showEvent") == "false") || (gup("showEvent") == "f")) { showEvent = false; }

  showTeams = true;
  if ((gup("showTeams") == "false") || (gup("showTeams") == "f")) { showTeams = false; }

  if ((gup("help") == "true") || (gup("help") == "t")) {
      document.write("<pre>" +
      "pgn4web live-results.html parameters" + "\n\n" +
      " - pgnData = " + pgnFile + "; PGN file to load (default " + pgnFile_default + ")" + "\n" +
      " - refreshMinutes = " + refreshMinutes + "; refresh interval in minutes, decimals allowed (default 1)" + "\n" +
      " - refreshDemo = " + demoFlag + "; sets live demo mode (default false)" + "\n" +
      " - showBoard = " + showBoard + "; shows the chessboard (default false)" + "\n" +
      " - showEvent = " + showEvent + "; shows event information (default true)" + "\n" +
      " - showTeams = " + showTeams + "; shows teams information (default true)" + "\n" +
      " - help = true; prints this help (default false)" + "\n\n" +
      "</pre>");
  }

  SetPgnUrl(pgnFile);
  SetImagePath ("alpha/32");
  SetImageType("png");
  SetHighlightOption(false);
  SetCommentsIntoMoveText(false);
  SetCommentsOnSeparateLines(false);
  SetAutoplayDelay(1000);
  SetAutostartAutoplay(false);
  SetAutoplayNextGame(false);
  SetInitialHalfmove("end", true);
  SetInitialGame("first");
  SetShortcutKeysEnabled(showBoard);
  SetLiveBroadcast(refreshMinutes, alertFlag, demoFlag, true);

  liveStatusTickerString = "o.oO";
  function customFunctionOnCheckLiveBroadcastStatus() {
    if (theObject = document.getElementById("GameLiveStatusTicker")) {
      theObject.innerHTML =  theObject.innerHTML = liveStatusTickerString.charAt(LiveBroadcastTicker % liveStatusTickerString.length);
      theObject.title = LiveBroadcastStatusString.replace("&nbsp;", " ");
    }
  }

  function customFunctionOnPgnGameLoad() {
    highlightGame(currentGame);
  }

  function customShortcutKey_Shift_1() {
    refreshPgnSource();
  }

  function replayPreviousMoves(numPlies) {
    targetPly = numPlies ? CurrentPly - numPlies : StartPly;
    if (targetPly < StartPly) { targetPly = StartPly; }
    if (targetPly !== CurrentPly) { GoToMove(targetPly); }
    SetAutoPlay(true);
  }

  if (LiveBroadcastDelay) {
    boardShortcut("E2", "replay 10 previous half-moves", function() { replayPreviousMoves(10); });
    boardShortcut("F2", "replay 6 previous half-moves", function() { replayPreviousMoves(6); });
    boardShortcut("G2", "replay 3 previous half-moves", function() { replayPreviousMoves(3); });
    boardShortcut("H2", "replay the previous half-move", function() { replayPreviousMoves(1); });

    boardShortcut("B1", "move 10 half-moves backward", function() { MoveBackward(10); });
    boardShortcut("G1", "move 10 half-moves forward", function() { MoveForward(10); });
  }

  var gameId;
  var gameWhiteTeam;
  var gameBlackTeam;
  var gameMatch;
  var gameBoard;
  var gameLength;
  var oldGameLength = new Array();
  var gameNewMoves;
  function customFunctionOnPgnTextLoad() {
    gameId = new Array();

    gameWhiteTeam = new Array();
    gameBlackTeam = new Array();
    gameMatch = new Array();
    gameBoard = new Array();
    gameLength = new Array();
    gameNewMoves = new Array();
    for (gg = 0; gg < numberOfGames; gg++) {
      gameId[gg] = gg;
      gameWhiteTeam[gg] = customPgnHeaderTag("WhiteTeam", null, gg);
      gameBlackTeam[gg] = customPgnHeaderTag("BlackTeam", null, gg);
      gameMatch[gg] = crc32(gameWhiteTeam[gg]) + crc32(gameBlackTeam[gg]);
      gameBoard[gg] = customPgnHeaderTag("Board", null, gg);
      gameLength[gg] = LiveBroadcastDemo ? gameDemoMaxPly[gg] : pgnGame[gg].length;
      gameNewMoves[gg] = ((!oldGameLength[gg]) || (gameLength[gg] !== oldGameLength[gg])) && (!LiveBroadcastEnded);
      oldGameLength[gg] = gameLength[gg];
    }

    gameId.sort(sortGameId);

    printGames();
  }

  function myCompare(AA, ZZ) {
    if (!AA && !ZZ) { return 0; }
    if (AA && !ZZ) { return -1; }
    if (!AA && ZZ) { return 1; }
    if (AA > ZZ) { return 1; }
    if (AA < ZZ) { return -1; }
    return 0;
  }

  function myCompareRound(AA, ZZ) {
    try {
      if (!AA && !ZZ) { return 0; }
      if (AA && !ZZ) { return -1; }
      if (!AA && ZZ) { return 1; }
      AA_A = AA.split ? AA.split(".") : [AA];
      ZZ_Z = ZZ.split ? ZZ.split(".") : [ZZ];
      jm = Math.max(AA_A.length, ZZ_Z.length);
      for (jj = 0; jj < jm; jj++) {
        if (AA_A[jj] && !ZZ_Z[jj]) { return -1; }
        if (!AA_A[jj] && ZZ_Z[jj]) { return 1; }
        if (!isNaN(AA_A[jj])) { AA_A[jj] = parseInt(AA_A[jj], 10); }
        if (!isNaN(ZZ_Z[jj])) { ZZ_Z[jj] = parseInt(ZZ_Z[jj], 10); }
        if (AA_A[jj] > ZZ_Z[jj]) { return 1; }
       if (AA_A[jj] < ZZ_Z[jj]) { return -1; }
      }
      return 0;
    } catch(e) {
      myAlert("warming: myCompareRound failed with AA=" + AA + "; ZZ=" + ZZ + ";", false);
      return myCompare(AA, ZZ);
    }
  }

  function sortGameId(aa, zz) {

    res = myCompare(gameEvent[aa], gameEvent[zz]);
    if (res !== 0) { return res; }

    res = myCompareRound(gameRound[aa], gameRound[zz]);
    if (res !== 0) { return res; }

    res = myCompare(gameMatch[aa], gameMatch[zz]);
    if (res !== 0) { return res; }

    res = myCompare(gameBoard[aa], gameBoard[zz]);
    if (res !== 0) { return res; }

    return 0;

  }

  function printGames() {
    firstRow = true;
    lastEventRound = "";
    lastMatch = 0;
    if (theObject = document.getElementById("results")) {
      resultTable = "";
      for (gg in gameId) {
        fixedRound = gameRound[gameId[gg]].replace(/\..*$/, ""); // only use the first number of rounds like 1.2.3
        currentEventRound = gameEvent[gameId[gg]] + " - " + fixedRound;
        if (showEvent && (currentEventRound !== lastEventRound)) {
          resultTable += "<div class='eventRound'" + (firstRow ? " style='padding-top:0;'" : "") + "><span class='event' title='" + gameEvent[gameId[gg]] + "'>" + gameEvent[gameId[gg]] + "</span><span class='round' title='" + "round " + fixedRound + "'>" + (fixedRound !== "" ? "round " + fixedRound : "") + "</span></div>";
          if (firstRow) { firstRow = false; }
          lastEventRound = currentEventRound;
          lastMatch = 0;
        }
        if (showTeams && (gameMatch[gg] !== lastMatch)) {
          resultTable += matchRow(gameMatch[gg], firstRow);
          if (firstRow) { firstRow = false; }
          lastMatch = gameMatch[gg];
        }
        resultTable += "<div class='game'"+ (firstRow ? " style='padding-top:0;'" : "") + " id='gameRow_" + gameId[gg] + "' onclick='selectGame(" + gameId[gg] + ");' style='font-weight: " + (showBoard && (gameId[gg] === oldSelectedGame) ? "bold" : "") + "'><span class='player'><span class='firstPlayer" + (firstTeam && gameWhiteTeam[gameId[gg]] === firstTeam ? " firstTeamPlayer" : "") + (secondTeam && gameWhiteTeam[gameId[gg]] === secondTeam ? " secondTeamPlayer" : "") + "' title='" + gameWhite[gameId[gg]] + "'>" + gameWhite[gameId[gg]] + "</span></span><span class='player'><span class='secondPlayer" + (firstTeam && gameWhiteTeam[gameId[gg]] === firstTeam ? " firstTeamPlayer" : "") + (secondTeam && gameBlackTeam[gameId[gg]] === secondTeam ? " secondTeamPlayer" : "") + "' title='" + gameBlack[gameId[gg]] + "'>" + gameBlack[gameId[gg]] + "</span></span><span class='result' title='" + gameResult[gameId[gg]] + "'>" + gameResult[gameId[gg]] + "</span><span class='" + (gameNewMoves[gg] ? "newMoves" : "noNewMoves") + "' title='new moves received'>*</span></div>";
        if (firstRow) { firstRow = false; }
      }
      theObject.innerHTML = resultTable;
    }
  }

  var firstTeam = "";
  var secondTeam = "";
  function matchRow(id, firstRow) {
    firstTeam = "";
    secondTeam = "";
    if (id === 0) { return ""; }
    firstTeamScore = 0;
    secondTeamScore = 0;
    for (ii in gameId) {
      if (gameMatch[ii] == id) {
        if (!firstTeam || !secondTeam) {
          firstTeam = gameWhiteTeam[gameId[ii]];
          secondTeam = gameBlackTeam[gameId[ii]];
        }
        switch (gameResult[gameId[ii]]) {
          case "1-0":
            if (firstTeam == gameWhiteTeam[gameId[ii]]) { firstTeamScore += 1; }
            else if (secondTeam == gameWhiteTeam[gameId[ii]]) { secondTeamScore += 1; }
            break;
          case "0-1":
            if (firstTeam == gameBlackTeam[gameId[ii]]) { firstTeamScore += 1; }
            else if (secondTeam == gameBlackTeam[gameId[ii]]) { secondTeamScore += 1; }
            break;
          case "1/2-1/2":
            firstTeamScore += 0.5;
            secondTeamScore += 0.5;
            break;
          default:
            break;
        }
      }
    }
    return "<div class='matchScore'" + (firstRow? " style='padding-top:0;'" : "") + "><span class='match' title='" + firstTeam + " - " + secondTeam + "'><span class='team'><span class='firstTeam'>" + firstTeam + "</span></span><span class='team'><span class='secondTeam'>" + secondTeam + "</span></span></span><span class='score' title='" + firstTeamScore + " - " + secondTeamScore + "'>" + firstTeamScore + " - " + secondTeamScore + "</span></div>";
  }

  oldSelectedGame = -1;
  function selectGame(gameNum) {
    if (!showBoard) { return; }
    Init(gameNum);
    highlightGame(gameNum);
  }

  function highlightGame(gameNum) {
    if (!showBoard) { return; }
    if (theObject = document.getElementById("gameRow_" + oldSelectedGame)) {
      if (oldSelectedGame !== gameNum) {
        theObject.style.fontWeight = "";
      }
    }
    if (theObject = document.getElementById("gameRow_" + gameNum)) {
       theObject.style.fontWeight = "bold";
    }
    oldSelectedGame = gameNum;
  }

  function customFunctionOnMove() {
    if (theObject = document.getElementById("SideToMove")) {
      theObject.style.backgroundColor = CurrentPly % 2 ? "black" : "white";
    }
  }

function gup( name ){

  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  // commented below to match first occurrence (to avoid users overruling setting)
  // regexS = regexS+"(?!.*"+regexS+")"; // matches the LAST occurrence
  var regex = new RegExp( regexS, "i" );
  var results = regex.exec( window.location.href );
  if( results !== null ) { return decodeURIComponent(results[1]); }

  // allows for short version of the URL parameters, for instance sC matches squareColor
  compact_name = name.charAt(0);
    for(i=1; i<name.length; i++){
      if (name.charAt(i).match(/[A-Z]/)) { compact_name = compact_name + name.charAt(i).toLowerCase(); }
    }
  name = compact_name;

  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  regexS = "[\\?&]"+name+"=([^&#]*)";
  // commented below to match first occurrence (to avoid users overruling setting)
  // regexS = regexS+"(?!.*"+regexS+")"; // matches the LAST occurrence
  regex = new RegExp( regexS, "i" );

  results = regex.exec( window.location.href );
  if( results !== null ) { return decodeURIComponent(results[1]); }

  return "";
}

</script>

</head>

<body>

<a class="gameLiveStatusTicker" id="GameLiveStatusTicker" href="javascript:void(0);" onclick="refreshPgnSource(); this.blur();">&nbsp;</a>

<div class="gameBoardContainer" id="GameBoardContainer">
<div class="header"><a class="gameWhite" id="GameWhite" title="white player" href="javascript:void(0);" onclick="openFidePlayerUrl(this.innerHTML, customPgnHeaderTag('WhiteFideId')); this.blur();"></a><span class="gameWhiteClock" id="GameWhiteClock" title="white clock"></span><span class="gameBlackClock" id="GameBlackClock" title="black clock"></span><a class="gameBlack" id="GameBlack" title="black player" href="javascript:void(0);" onclick="openFidePlayerUrl(this.innerHTML, customPgnHeaderTag('WhiteFideId')); this.blur();"></a></div>
<div>&nbsp;</div>
<div id="GameBoard"></div>
<div>&nbsp;</div>
<div id="GameButtons"></div>
<div>&nbsp;</div>
<div class="gameText"><img class="sideToMove" id="SideToMove" src="clear.png" title="side to move"><span id="GameText"></span><span id="GameResult"></span></div>
</div>

<div id="results"></div>

<script type="text/javascript">

  if (theObject = document.getElementById("GameBoardContainer")) {
    theObject.style.display = showBoard ? "" : "none";
  }

</script>

</body>

</html>
